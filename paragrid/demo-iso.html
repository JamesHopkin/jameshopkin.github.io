<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paragrid Isometric Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #1a1a1a;
        color: #e0e0e0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        width: 100%;
      }

      h1 {
        color: #4fc3f7;
        margin-bottom: 1rem;
        text-align: center;
      }

      .demo-area {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
      }

      #canvas {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        width: 800px;
        height: 600px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #status {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 1.5rem;
        min-width: 300px;
        flex-shrink: 0;
      }

      .status-line {
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #444;
      }

      .status-line:last-child {
        border-bottom: none;
      }

      .controls {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #555;
      }

      .key {
        display: inline-block;
        background: #444;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        color: #4fc3f7;
      }

      strong {
        color: #4fc3f7;
      }

      .description {
        text-align: center;
        margin-bottom: 2rem;
        color: #aaa;
      }

      .export-button {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background: #4fc3f7;
        color: #1a1a1a;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        transition: background 0.2s;
      }

      .export-button:hover {
        background: #81d4fa;
      }

      .export-button:active {
        background: #29b6f6;
      }

      .manual-view-control {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #555;
      }

      .manual-view-input {
        width: 100%;
        padding: 0.5rem;
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
        color: #e0e0e0;
        font-family: monospace;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .manual-view-input:focus {
        outline: none;
        border-color: #4fc3f7;
      }

      .manual-view-input::placeholder {
        color: #666;
      }

      .manual-view-status {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #aaa;
      }

      .manual-view-status.active {
        color: #4fc3f7;
      }

      .manual-view-status.error {
        color: #ff5252;
      }

      .zoom-control {
        margin-top: 1rem;
      }

      .zoom-slider {
        width: 100%;
        margin-top: 0.5rem;
      }

      .zoom-value {
        display: inline-block;
        min-width: 4rem;
        text-align: right;
        color: #4fc3f7;
        font-family: monospace;
      }
    </style>
    <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();function _t(){return Object.freeze({type:"empty"})}function mt(i){return Object.freeze({type:"concrete",id:i})}function at(i,t=null){return Object.freeze({type:"ref",gridId:i,isPrimary:t})}function Lt(i){return i.type==="empty"}function nt(i){return i.type==="concrete"}function z(i){return i.type==="ref"}function Qt(i,t){if(t.length===0)throw new Error("Grid must have at least one row");const e=t.length,r=t[0].length;if(r===0)throw new Error("Grid must have at least one column");for(let n=0;n<e;n++)if(t[n].length!==r)throw new Error(`Inconsistent row length at row ${n}: expected ${r}, got ${t[n].length}`);const s=Object.freeze(t.map(n=>Object.freeze(n)));return Object.freeze({id:i,cells:s,rows:e,cols:r})}function V(i,t){return i[t]}function Jt(i){const t={};for(const[e,r]of Object.entries(i)){const s=r.split("|"),n=[];for(let a=0;a<s.length;a++){const l=s[a],c=l.split(" "),d=[];for(let u=0;u<c.length;u++){const h=c[u];if(!h)d.push(_t());else if(h==="_")d.push(_t());else if(/^\d/.test(h))d.push(mt(h));else if(/^[a-zA-Z]/.test(h))d.push(at(h,null));else if(h.startsWith("*")&&h.length>=2)d.push(at(h.slice(1),!0));else if(h.startsWith("~")&&h.length>=2)d.push(at(h.slice(1),!1));else{const p=`Invalid cell string: '${h}'
  Grid: '${e}'
  Row ${a}: "${l}"
  Position: column ${u}
  Valid formats:
    - Digit start (0-9...): Concrete cell (e.g., '1', '123abc')
    - Letter start (a-zA-Z...): Ref cell (e.g., 'A', 'Main')
    - '*' prefix: Primary ref (e.g., '*A', '*Main')
    - '~' prefix: Secondary ref (e.g., '~A', '~Main')
    - '_': Empty cell
    - Empty string (multiple spaces): Empty cell`;throw new Error(p)}}n.push(d)}if(n.length>0){const a=n[0].length,l=[];for(let c=0;c<n.length;c++)n[c].length!==a&&l.push([c,n[c].length]);if(l.length>0){let c=`Inconsistent row lengths in grid '${e}'
  Expected: ${a} columns (from row 0)
  Mismatched rows:
`;for(const[d,u]of l)c+=`    Row ${d}: ${u} columns - "${s[d]}"
`;throw c+="  All rows must have the same number of cells",new Error(c)}}const o=Qt(e,n);t[e]=o}return Object.freeze(t)}function te(i){const t={};for(const[e,r]of Object.entries(i)){const s=[];for(let n=0;n<r.rows;n++){const o=[];for(let a=0;a<r.cols;a++){const l=r.cells[n][a];l.type==="empty"?o.push("_"):l.type==="concrete"?o.push(l.id):l.type==="ref"&&(l.isPrimary===!0?o.push("*"+l.gridId):l.isPrimary===!1?o.push("~"+l.gridId):o.push(l.gridId))}s.push(o.join(" "))}t[e]=s.join("|")}return t}var k=(i=>(i.N="N",i.S="S",i.E="E",i.W="W",i))(k||{});function ee(i){switch(i){case"N":return"S";case"S":return"N";case"E":return"W";case"W":return"E"}}class L{constructor(t,e,r){this.gridId=t,this.row=e,this.col=r}toKey(){return`${this.gridId},${this.row},${this.col}`}equals(t){return this.gridId===t.gridId&&this.row===t.row&&this.col===t.col}clone(){return new L(this.gridId,this.row,this.col)}toString(){return`CellPosition(${this.gridId}, ${this.row}, ${this.col})`}}function ht(i,t){const e=i[t.gridId];if(!e)throw new Error(`Grid not found: ${t.gridId}`);if(t.row<0||t.row>=e.rows||t.col<0||t.col>=e.cols)throw new Error(`Position out of bounds: ${t}`);return e.cells[t.row][t.col]}function st(i,t){for(const e of Object.values(i))for(let r=0;r<e.rows;r++)for(let s=0;s<e.cols;s++){const n=e.cells[r][s];if(z(n)&&n.gridId===t&&n.isPrimary===!0)return[e.id,r,s]}for(const e of Object.values(i))for(let r=0;r<e.rows;r++)for(let s=0;s<e.cols;s++){const n=e.cells[r][s];if(z(n)&&n.gridId===t)return[e.id,r,s]}}const q=ht;function Ct(i,t,e,r){const s=i[t];if(!s)return;const n=s.rows,o=s.cols;switch(e){case k.E:return new L(t,Math.floor(n/2),0);case k.W:return new L(t,Math.floor(n/2),o-1);case k.S:return new L(t,0,Math.floor(o/2));case k.N:return new L(t,n-1,Math.floor(o/2));default:return}}class ot{current;direction;store;visitedGrids;deltas;lastTransitionType;lastEnterViaNonPrimary;constructor(t,e,r){this.store=t,this.current=e.clone(),this.direction=r,this.visitedGrids=new Set,this.lastTransitionType=null,this.lastEnterViaNonPrimary=null,this.deltas={[k.N]:[-1,0],[k.S]:[1,0],[k.E]:[0,1],[k.W]:[0,-1]}}getLastTransition(){return this.lastTransitionType}getLastEnterViaNonPrimary(){return this.lastEnterViaNonPrimary}clone(){const t=new ot(this.store,this.current,this.direction);return t.visitedGrids=new Set(this.visitedGrids),t.lastTransitionType=this.lastTransitionType,t.lastEnterViaNonPrimary=this.lastEnterViaNonPrimary,t}tryAdvance(){this.visitedGrids.clear(),this.lastEnterViaNonPrimary=null;const[t,e]=this.deltas[this.direction],r=this.store[this.current.gridId],s=this.current.row+t,n=this.current.col+e;if(s<0||s>=r.rows||n<0||n>=r.cols){const o=new Set;let a=this.current.gridId;for(;;){const l=st(this.store,a);if(!l)return!1;const[c,d,u]=l,h=`${c},${d},${u}`;if(o.has(h))return!1;o.add(h);const p=this.store[c],m=d+t,$=u+e;if(m>=0&&m<p.rows&&$>=0&&$<p.cols)return this.current=new L(c,m,$),this.lastTransitionType="exit",!0;a=c}}return this.current=new L(this.current.gridId,s,n),this.lastTransitionType="move",!0}advance(){if(!this.tryAdvance())throw new Error(`Navigator.advance() failed at ${this.current}`)}tryEnter(t){const e=ht(this.store,this.current);if(!z(e)||this.visitedGrids.has(e.gridId))return!1;const r=Ct(this.store,e.gridId,this.direction);return r?(this.visitedGrids.add(e.gridId),this.current=r,this.lastTransitionType="enter",this.lastEnterViaNonPrimary=e.isPrimary===!1,!0):!1}enter(t){if(!this.tryEnter(t))throw new Error(`Navigator.enter() failed at ${this.current}`)}tryEnterMulti(t){const e=new Set;for(;;){const r=ht(this.store,this.current);if(!z(r))return this.visitedGrids.clear(),!0;if(e.has(r.gridId))return!1;e.add(r.gridId);const s=Ct(this.store,r.gridId,this.direction);if(!s)return!1;this.current=s}}enterMulti(t){if(!this.tryEnterMulti(t))throw new Error(`Navigator.enterMulti() failed at ${this.current}`)}flip(){this.direction=ee(this.direction)}}var X=(i=>(i.PORTAL="portal",i.SOLID="solid",i.SWALLOW="swallow",i))(X||{});class re{static DEFAULT=Object.freeze(["solid","portal","swallow"]);static TRY_ENTER_FIRST=Object.freeze(["portal","solid","swallow"]);static PUSH_FIRST=Object.freeze(["solid","portal","swallow"]);static SWALLOW_FIRST=Object.freeze(["swallow","portal","solid"])}function ie(i=re.DEFAULT){return Object.freeze({refStrategy:i})}function Et(i,t){if(t.length===0)return{store:i,chain:[]};const e=t.map(([a,l,c,d])=>({position:a,cell:l,transition:c,...d!==void 0&&{viaNonPrimaryReference:d}})),r=t.map(([a,l])=>l),s=[r[r.length-1],...r.slice(0,-1)],n=new Map;for(let a=0;a<t.length;a++){const[l,c]=t[a],d=s[a];n.has(l.gridId)||n.set(l.gridId,[]),n.get(l.gridId).push([l.row,l.col,d])}let o={...i};for(const[a,l]of n.entries()){const c=i[a];if(!c)throw new Error(`Grid not found: ${a}`);const d=c.cells.map(u=>[...u]);for(const[u,h,p]of l)d[u][h]=p;o={...o,[a]:{id:c.id,cells:d,rows:c.rows,cols:c.cols}}}return{store:o,chain:e}}function ne(i,t,e,r,s,n=1e3,o=10){function a(g,f,y,S,w){const v=q(i,f.current);if(Lt(v))return"succeed";if(s&&s(v).has("stop"))return{reason:"STOP_TAG",position:f.current,details:"Encountered stop-tagged cell"};const _=`${f.current.gridId},${f.current.row},${f.current.col}`;if(y.has(_))return g.length>0&&f.current.equals(t)?"succeed":{reason:"PATH_CYCLE",position:f.current,details:"Path cycled to non-start position"};const E=new Set(y);E.add(_);const C=[],I=g.length>0?g[g.length-1][0]:null,N=I?q(i,I):null,x=v;for(const M of r.refStrategy)M===X.SOLID?f.clone().tryAdvance()&&C.push(M):(M===X.PORTAL&&z(x)||M===X.SWALLOW&&N&&z(N))&&C.push(M);return C.length===0?{reason:"NO_STRATEGY",position:f.current,details:"No applicable strategy available"}:{path:g,nav:f,strategies:C,visited:E,nextTransition:S,nextViaNonPrimary:w}}const l=q(i,t);if(s&&s(l).has("stop"))return{reason:"STOP_TAG",position:t,details:"Cannot push from stop-tagged cell"};const c=new ot(i,t,e),d=new Set([`${t.gridId},${t.row},${t.col}`]);if(!c.tryAdvance())return{reason:"BLOCKED",position:t,details:"Cannot advance from start position (hit edge)"};const u=c.getLastTransition(),h=u==="enter"?c.getLastEnterViaNonPrimary()??void 0:void 0,p=a([[t,null,void 0]],c,d,u,h);if(typeof p=="object"&&"reason"in p)return p;if(p==="succeed"){const g=[[t,q(i,t),null,void 0],[c.current,q(i,c.current),u,h]];return Et(i,g)}const m=[p];let $,b=o;for(;m.length>0&&b>0;){const g=m[m.length-1];if(g.strategies.length===0){m.pop(),b--;continue}const f=g.nav.clone(),y=g.strategies.shift(),S=[...g.path];let w,v;if(y===X.SOLID)S.push([f.current,g.nextTransition,g.nextViaNonPrimary]),f.advance(),w=f.getLastTransition(),v=w==="enter"?f.getLastEnterViaNonPrimary()??void 0:void 0;else if(y===X.PORTAL)f.enter(r),w=f.getLastTransition(),v=w==="enter"?f.getLastEnterViaNonPrimary()??void 0:void 0;else if(y===X.SWALLOW)S.push([f.current,g.nextTransition,g.nextViaNonPrimary]),f.flip(),f.advance(),f.enter(r),w=f.getLastTransition(),v=w==="enter"?f.getLastEnterViaNonPrimary()??void 0:void 0;else throw new Error(`Unknown strategy: ${y}`);const _=a(S,f,g.visited,w,v);if(_==="succeed"){const E=S.map(([C,I,N])=>[C,q(i,C),I,N]);return E.push([f.current,q(i,f.current),w,v]),Et(i,E)}else if(typeof _=="object"&&"reason"in _){$=_;continue}else m.push(_)}return $||{reason:"NO_STRATEGY",position:t,details:"All backtracking attempts exhausted"}}function se(i,t,e){for(const r of Object.values(i))for(let s=0;s<r.cells.length;s++){const n=r.cells[s];for(let o=0;o<n.length;o++){const a=n[o];if(e(a).has(t))return new L(r.id,s,o)}}}function Q(i,t,e,r,s=.1,n=new Set,o=null,a=[],l=null){const c=a.length===0?[t]:a,d=(y,S)=>{if(o===null)return{focusDepth:null,focusOffset:null};const w=Array.from(c),v=Array.from(o);if(h(w,v))return{focusDepth:0,focusOffset:[S,y]};if(c.length<o.length){if(p(w,v)){const _=-(o.length-c.length),E=u();if(E!==null){const[C,I]=E;return{focusDepth:_,focusOffset:[S-C,y-I]}}return{focusDepth:_,focusOffset:null}}}else if(c.length>o.length&&p(v,w))return{focusDepth:c.length-o.length,focusOffset:null};return{focusDepth:null,focusOffset:null}},u=()=>{if(o===null||c.length>=o.length)return null;const y=o[c.length],S=V(i,t);if(!S)return null;for(let w=0;w<S.rows;w++)for(let v=0;v<S.cols;v++){const _=S.cells[w][v];if(z(_)&&_.gridId===y)return[v,w]}return null},h=(y,S)=>y.length===S.length&&y.every((w,v)=>w===S[v]),p=(y,S)=>y.length<=S.length&&y.every((w,v)=>w===S[v]);if(e<s||r<s){const y=d(0,0);return{type:"cutoff",gridId:t,focusDepth:y.focusDepth,focusOffset:y.focusOffset}}const m=V(i,t);if(!m)throw new Error(`Grid not found: ${t}`);const $=e/m.cols,b=r/m.rows,g=[];for(let y=0;y<m.rows;y++){const S=[];for(let w=0;w<m.cols;w++){const v=m.cells[y][w],_=d(y,w);if(Lt(v))S.push({type:"empty",focusDepth:_.focusDepth,focusOffset:_.focusOffset});else if(nt(v))S.push({type:"concrete",id:v.id,gridId:t,focusDepth:_.focusDepth,focusOffset:_.focusOffset});else if(z(v)){let E;v.isPrimary===!0?(E=!0,n.add(v.gridId)):v.isPrimary===!1?E=!1:(E=!n.has(v.gridId),E&&n.add(v.gridId));const C=[...c,v.gridId],I=Q(i,v.gridId,$,b,s,n,o,C,[w,y]);S.push({type:"ref",gridId:t,refTarget:v.gridId,isPrimary:E,content:I,focusDepth:_.focusDepth,focusOffset:_.focusOffset})}}g.push(S)}const f=d(0,0);return{type:"nested",gridId:t,children:g,focusDepth:f.focusDepth,focusOffset:f.focusOffset}}function ft(i){return i.type==="concrete"}function et(i){return i.type==="ref"}function rt(i){return i.type==="nested"}var oe=Object.defineProperty,ae=(i,t,e)=>t in i?oe(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,T=(i,t,e)=>ae(i,typeof t!="symbol"?t+"":t,e);const Y={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]};class le{constructor(){T(this,"objects",new Map),T(this,"templates",new Map),T(this,"idCounter",1),T(this,"groupStack",[]),T(this,"rootBuilder"),T(this,"sceneBackground"),T(this,"sceneLight"),T(this,"isInTemplate",!1),this.rootBuilder=new Z(this.generateId("root"),void 0),this.groupStack.push(this.rootBuilder)}generateId(t="node"){return`${t}-${this.idCounter++}`}object(t,e){const r=t??this.generateId("object");return this.objects.set(r,{id:r,type:"object",primitive:e}),this}lightObject(t,e){return this.object(t,{type:"light",...e})}group(t,e){const r=t??this.generateId("group");let s;e&&(s={position:e.position??Y.position,rotation:e.rotation??Y.rotation,scale:e.scale??Y.scale});const n=new Z(r,s,e?.lighting,e?.layer);return this.getCurrentGroup().addChild(n),this.groupStack.push(n),this}endGroup(){if(this.groupStack.length<=1)throw new Error("Cannot end root group");return this.groupStack.pop(),this}template(t){if(this.isInTemplate)throw new Error("Cannot nest templates");const e=new Z(t,void 0);return this.groupStack.push(e),this.isInTemplate=!0,this}endTemplate(){if(!this.isInTemplate)throw new Error("Not in template - call template() first");if(this.groupStack.length<=1)throw new Error("Cannot end template at root level");const t=this.groupStack.pop().build();return this.templates.set(t.id,t),this.isInTemplate=!1,this}instance(t,e){const r=e.id??this.generateId("instance"),s={position:e.position??Y.position,rotation:e.rotation??Y.rotation,scale:e.scale??Y.scale};let n={id:r,type:"instance",objectId:t,transform:s,color:e.color};return e.lighting!==void 0&&(n={...n,lighting:e.lighting}),e.layer!==void 0&&(n={...n,layer:e.layer}),this.getCurrentGroup().addChild(n),this}reference(t,e){let r={id:e?.id??this.generateId("reference"),type:"reference",targetId:t};return e?.translation!==void 0&&(r={...r,translation:e.translation}),e?.scale!==void 0&&(r={...r,scale:e.scale}),e?.billboard!==void 0&&(r={...r,billboard:e.billboard}),e?.layer!==void 0&&(r={...r,layer:e.layer}),this.getCurrentGroup().addChild(r),this}background(t){return this.sceneBackground=t,this}light(t){return this.sceneLight=t,this}lighting(t){return this.getCurrentGroup().setLighting(t),this}ambient(t){return this.getCurrentGroup().setAmbient(t),this}directional(t){return this.getCurrentGroup().setDirectional(t),this}getCurrentGroup(){const t=this.groupStack[this.groupStack.length-1];if(!t)throw new Error("No current group");return t}build(){if(this.isInTemplate)throw new Error("Unclosed template - call endTemplate()");if(this.groupStack.length!==1)throw new Error("Unclosed groups - call endGroup() for each group()");let t={objects:this.objects,templates:this.templates,root:this.rootBuilder.build()};return this.sceneBackground!==void 0&&(t={...t,background:this.sceneBackground}),this.sceneLight!==void 0&&(t={...t,light:this.sceneLight}),t}}class Z{constructor(t,e,r,s){T(this,"children",[]),T(this,"groupLighting"),T(this,"groupLayer"),this.id=t,this.transform=e,r!==void 0&&(this.groupLighting=r),s!==void 0&&(this.groupLayer=s)}addChild(t){this.children.push(t)}setLighting(t){this.groupLighting=t}setAmbient(t){this.groupLighting={...this.groupLighting,ambient:t}}setDirectional(t){this.groupLighting={...this.groupLighting,directional:t}}build(){let t={id:this.id,type:"group",children:this.children.map(e=>e instanceof Z?e.build():e)};return this.transform!==void 0&&(t={...t,transform:this.transform}),this.groupLighting!==void 0&&(t={...t,lighting:this.groupLighting}),this.groupLayer!==void 0&&(t={...t,layer:this.groupLayer}),t}}function ce(i=1){const t=i/2,e=[-t,-t,-t],r=[t,-t,-t],s=[t,-t,t],n=[-t,-t,t],o=[-t,t,-t],a=[t,t,-t],l=[t,t,t],c=[-t,t,t];return{type:"solid",faces:[{vertices:[e,r,s,n]},{vertices:[o,c,l,a]},{vertices:[n,s,l,c]},{vertices:[r,e,o,a]},{vertices:[e,n,c,o]},{vertices:[s,r,a,l]}]}}function ue(i=1,t=1){const e=i/2,r=[-e,0,-e],s=[e,0,-e],n=[e,0,e],o=[-e,0,e],a=[0,t,0];return{type:"solid",faces:[{vertices:[r,a,s]},{vertices:[s,a,n]},{vertices:[n,a,o]},{vertices:[o,a,r]}]}}function de(i=1){const t=i/Math.sqrt(2),e=[0,t,0],r=[0,-t,0],s=[0,0,t],n=[0,0,-t],o=[t,0,0],a=[-t,0,0];return{type:"solid",faces:[{vertices:[e,s,o]},{vertices:[e,o,n]},{vertices:[e,n,a]},{vertices:[e,a,s]},{vertices:[r,o,s]},{vertices:[r,n,o]},{vertices:[r,a,n]},{vertices:[r,s,a]}]}}function he(i,t=!0){const e=fe(i);return t?JSON.stringify(e,null,2):JSON.stringify(e)}function fe(i){const t={};i.objects.forEach((r,s)=>{t[s]=r});const e={};return i.templates.forEach((r,s)=>{e[s]=r}),{objects:t,templates:e,root:i.root,...i.background!==void 0?{background:i.background}:{},...i.light!==void 0?{light:i.light}:{}}}const pt={scale:[1,1],translation:[0,0]};function pe(i,t){return[i[0]+t[0],i[1]+t[1],i[2]+t[2]]}function F(i){const t=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);return t===0?[0,0,0]:[i[0]/t,i[1]/t,i[2]/t]}function zt(i,t){return i[0]*t[0]+i[1]*t[1]+i[2]*t[2]}function O(i,t,e){t=Math.max(0,Math.min(1,t));const r=i.replace("#","");let s=parseInt(r.substring(0,2),16),n=parseInt(r.substring(2,4),16),o=parseInt(r.substring(4,6),16);if(e){const u=e.replace("#",""),h=parseInt(u.substring(0,2),16)/255,p=parseInt(u.substring(2,4),16)/255,m=parseInt(u.substring(4,6),16)/255;s=Math.round(s*h),n=Math.round(n*p),o=Math.round(o*m)}const a=Math.round(s*t),l=Math.round(n*t),c=Math.round(o*t),d=u=>u.toString(16).padStart(2,"0");return`#${d(a)}${d(l)}${d(c)}`}function Gt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ge(i,t,e){return[1,0,0,i,0,1,0,t,0,0,1,e,0,0,0,1]}function me(i,t,e){return[i,0,0,0,0,t,0,0,0,0,e,0,0,0,0,1]}function yt(i){const t=Math.cos(i),e=Math.sin(i);return[1,0,0,0,0,t,-e,0,0,e,t,0,0,0,0,1]}function wt(i){const t=Math.cos(i),e=Math.sin(i);return[t,0,e,0,0,1,0,0,-e,0,t,0,0,0,0,1]}function ye(i){const t=Math.cos(i),e=Math.sin(i);return[t,-e,0,0,e,t,0,0,0,0,1,0,0,0,0,1]}function jt(i,t){return[i,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]}function G(i,t){const e=new Array(16).fill(0);for(let r=0;r<4;r++)for(let s=0;s<4;s++){let n=0;for(let o=0;o<4;o++){const a=i[r*4+o],l=t[o*4+s];a!==void 0&&l!==void 0&&(n+=a*l)}e[r*4+s]=n}return e}function P(i,t){const[e,r,s]=i,n=1,o=t[0]*e+t[1]*r+t[2]*s+t[3]*n,a=t[4]*e+t[5]*r+t[6]*s+t[7]*n,l=t[8]*e+t[9]*r+t[10]*s+t[11]*n,c=t[12]*e+t[13]*r+t[14]*s+t[15]*n;return c!==1&&c!==0?[o/c,a/c,l/c]:[o,a,l]}function we(i,t){const[e,r,s]=i,n=0,o=t[0]*e+t[1]*r+t[2]*s+t[3]*n,a=t[4]*e+t[5]*r+t[6]*s+t[7]*n,l=t[8]*e+t[9]*r+t[10]*s+t[11]*n;return[o,a,l]}function vt(i,t,e){const r=me(e[0],e[1],e[2]),s=yt(t[0]),n=wt(t[1]),o=ye(t[2]),a=ge(i[0],i[1],i[2]);let l=r;return l=G(s,l),l=G(n,l),l=G(o,l),l=G(a,l),l}function ve(i){return[i[0],i[1]]}function it(i){return i*Math.PI/180}class A{constructor(t){this.config=t}getConfig(){return this.config}withConfig(t){return new A({...this.config,...t})}transformToView(t){const{yaw:e,pitch:r,groundScale:s,heightScale:n}=this.config,o=it(e),a=it(r),l=wt(o),c=yt(a),d=G(c,l),u=jt(s,n),h=G(u,d),p=P(t,h);return[p[0],p[1]]}getScale(){const{center:t,rightEdge:e,viewportWidth:r}=this.config;if(t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return 100;const s=this.transformToView(t),n=this.transformToView(e),o=n[0]-s[0],a=n[1]-s[1],l=Math.sqrt(o*o+a*a);return l<1e-4?100:r/2/l}getOffset(){const{center:t}=this.config,e=this.transformToView(t),r=this.getScale(),s=e[0]*r,n=-e[1]*r,o=-s,a=-n;return[o,a]}withCenter(t){return new A({...this.config,center:t})}withZoom(t){return new A({...this.config,rightEdge:t})}withViewport(t,e){return new A({...this.config,viewportWidth:t,viewportHeight:e})}pan(t){const{center:e,rightEdge:r}=this.config;return new A({...this.config,center:[e[0]+t[0],e[1]+t[1],e[2]+t[2]],rightEdge:[r[0]+t[0],r[1]+t[1],r[2]+t[2]]})}zoom(t){const{center:e,rightEdge:r}=this.config,s=r[0]-e[0],n=r[1]-e[1],o=r[2]-e[2],a=[e[0]+s*t,e[1]+n*t,e[2]+o*t];return new A({...this.config,rightEdge:a})}static fromViewWidth(t,e,r,s){const n=[t[0]+e/2,t[1],t[2]];switch(s){case"true-isometric":return A.trueIsometric(t,n,r);case"architectural":return A.architectural(t,n,r);case"tactical":return A.tactical(t,n,r);case"dramatic":return A.dramatic(t,n,r);case"dimetric":return A.dimetric(t,n,r);case"flat-illustration":return A.flatIllustration(t,n,r)}}static trueIsometric(t=[0,0,0],e=[6,0,0],r=[800,600]){return new A({center:t,rightEdge:e,viewportWidth:r[0],viewportHeight:r[1],yaw:45,pitch:35.264,groundScale:1,heightScale:1,preset:"true-isometric"})}static architectural(t=[0,0,0],e=[6,0,0],r=[800,600]){return new A({center:t,rightEdge:e,viewportWidth:r[0],viewportHeight:r[1],yaw:45,pitch:30,groundScale:1,heightScale:1.1,preset:"architectural"})}static tactical(t=[0,0,0],e=[6,0,0],r=[800,600]){return new A({center:t,rightEdge:e,viewportWidth:r[0],viewportHeight:r[1],yaw:45,pitch:25,groundScale:1.05,heightScale:.7,preset:"tactical"})}static dramatic(t=[0,0,0],e=[6,0,0],r=[800,600]){return new A({center:t,rightEdge:e,viewportWidth:r[0],viewportHeight:r[1],yaw:45,pitch:42,groundScale:.95,heightScale:1.3,preset:"dramatic"})}static dimetric(t=[0,0,0],e=[6,0,0],r=[800,600]){return new A({center:t,rightEdge:e,viewportWidth:r[0],viewportHeight:r[1],yaw:42,pitch:35,groundScale:1,heightScale:.85,preset:"dimetric"})}static flatIllustration(t=[0,0,0],e=[6,0,0],r=[800,600]){return new A({center:t,rightEdge:e,viewportWidth:r[0],viewportHeight:r[1],yaw:45,pitch:18,groundScale:1.1,heightScale:.5,preset:"flat-illustration"})}static custom(t){return new A(t)}static default(){return A.trueIsometric()}}function Se(i){const{yaw:t,pitch:e}=i.getConfig(),r=it(t),s=it(e),n=yt(s),o=wt(r);return G(n,o)}function be(i){const{groundScale:t,heightScale:e}=i.getConfig();return jt(t,e)}function $e(i,t){return i.templates.get(t)||Dt(i.root,t)}function Dt(i,t){if(i.id===t)return i;for(const e of i.children){if(e.id===t)return e;if(e.type==="group"){const r=Dt(e,t);if(r)return r}}return null}function Wt(i,t){return t?{position:t.position??i.position,rotation:t.rotation??i.rotation,scale:t.scale??i.scale}:i}function Ht(i,t){if(!t)return i;let e={};return i.ambient!==void 0&&(e={...e,ambient:i.ambient}),i.directional!==void 0&&(e={...e,directional:i.directional}),t.ambient!==void 0&&(e={...e,ambient:t.ambient}),t.directional!==void 0&&(e={...e,directional:t.directional}),e}function _e(i,t,e,r){let s={};return i.light!==void 0&&(s={directional:i.light}),St(i.root,i,i.objects,Gt(),t,e,s,0,r)}function St(i,t,e,r,s,n,o,a,l){let c;if(i.transform){const b=l?.get(i.id),g=Wt(i.transform,b);c=vt(g.position,g.rotation,g.scale)}else c=Gt();const d=G(r,c),u=Ht(o,i.lighting),h=i.layer!==void 0?i.layer:a,p=[],m=[];for(const b of i.children)if(b.type==="group"){const g=St(b,t,e,d,s,n,u,h,l);p.push(g.screenSpaceNode),m.push(...g.elements)}else if(b.type==="instance"){const g=Ft(b,e,d,s,n,u,h,l);g&&(p.push(g.screenSpaceNode),m.push(...g.elements))}else if(b.type==="reference"){const g=Bt(b,t,e,d,s,n,u,h,l);g&&(p.push(g.screenSpaceNode),m.push(...g.elements))}let $={id:i.id,type:"group",transform:pt,children:p};return i.layer!==void 0&&($={...$,layer:i.layer}),{screenSpaceNode:$,elements:m}}function Ft(i,t,e,r,s,n,o,a){const l=t.get(i.objectId);if(!l)return console.warn(`Object not found: ${i.objectId}`),null;const c=a?.get(i.id),d=Wt(i.transform,c),u=vt(d.position,d.rotation,d.scale),h=G(e,u),p=G(r,h),m=Ht(n,i.lighting),$=i.layer!==void 0?i.layer:o,b=Ce(l.primitive,p,i.color,i.id,s,h,m,$),g=b.map(y=>{let S={id:`${i.id}-${y.element.id}`,type:"element",transform:pt,element:y.element};return i.layer!==void 0&&(S={...S,layer:i.layer}),S});let f={id:i.id,type:"group",transform:pt,children:g};return i.layer!==void 0&&(f={...f,layer:i.layer}),{screenSpaceNode:f,elements:b}}function Bt(i,t,e,r,s,n,o,a,l){const c=$e(t,i.targetId);if(!c)return console.warn(`Reference target not found: ${i.targetId}`),null;let d=i.translation??[0,0,0],u=i.scale??[1,1,1];const h=[0,0,0],p=l?.get(i.id);p&&(d=p.position??d,u=p.scale??u);const m=vt(d,h,u),$=G(r,m),b=i.layer!==void 0?i.layer:a;return c.type==="group"?St(c,t,e,$,s,n,o,b,l):c.type==="instance"?Ft(c,e,$,s,n,o,b,l):c.type==="reference"?Bt(c,t,e,$,s,n,o,b,l):null}function Ce(i,t,e,r,s,n,o,a){switch(i.type){case"line":return Ee(i.start,i.end);case"shape":return Ie(i.vertices,t,e,r,s,n,o,a);case"solid":return Pe(i.faces,t,e,r,s,n,o,a);case"sphere":return xe(i.radius,t,e,r,s,n,o,a);case"cylinder":return Ae(i.radius,i.height,t,e,r,s,n,o,a);case"cone":return ke(i.radius,i.height,t,e,r,s,n,o,a);case"light":return Me(i,t,e,r,s,n,a)}}function Ee(i,t,e,r,s,n,o){return[]}function Ie(i,t,e,r,s,n,o,a){const l=i.map(m=>P(m,t)),c=i.map(m=>P(m,n));let d=null;if(c.length>=3){const m=c[0],$=c[1],b=c[2];if(m&&$&&b){const g=[$[0]-m[0],$[1]-m[1],$[2]-m[2]],f=[b[0]-m[0],b[1]-m[1],b[2]-m[2]],y=[g[1]*f[2]-g[2]*f[1],g[2]*f[0]-g[0]*f[2],g[0]*f[1]-g[1]*f[0]];d=F(y)}}const u=l.map(m=>j(m,s)),h=P([0,0,0],t)[2];let p=e;if(o.ambient&&(p=O(e,1,o.ambient)),o.directional&&d){const m=o.directional,$=F(m.direction),b=Math.max(0,zt(d,$)),g=m.ambient+(1-m.ambient)*b;p=O(p,g,m.color)}return[{element:{type:"polygon",id:`${r}-shape`,vertices:u,fill:{type:"solid",color:p},zIndex:h,layer:a},depth:h}]}function Pe(i,t,e,r,s,n,o,a){const l=[],c=P([0,0,0],t)[2];for(let d=0;d<i.length;d++){const u=i[d];if(!u)continue;const h=u.vertices.map(f=>P(f,n));let p=null;if(h.length>=3){const f=h[0],y=h[1],S=h[2];if(f&&y&&S){const w=[y[0]-f[0],y[1]-f[1],y[2]-f[2]],v=[S[0]-f[0],S[1]-f[1],S[2]-f[2]],_=[w[1]*v[2]-w[2]*v[1],w[2]*v[0]-w[0]*v[2],w[0]*v[1]-w[1]*v[0]];p=F(_)}}const m=u.vertices.map(f=>P(f,t));if(m.length>=3){const f=m[0],y=m[1],S=m[2];if(f&&y&&S){const w=[y[0]-f[0],y[1]-f[1],y[2]-f[2]],v=[S[0]-f[0],S[1]-f[1],S[2]-f[2]];if([w[1]*v[2]-w[2]*v[1],w[2]*v[0]-w[0]*v[2],w[0]*v[1]-w[1]*v[0]][2]<0)continue}}const $=m.map(f=>j(f,s));let b=e;if(o.ambient&&(b=O(e,1,o.ambient)),o.directional&&p){const f=o.directional,y=F(f.direction),S=Math.max(0,zt(p,y)),w=f.ambient+(1-f.ambient)*S;b=O(b,w,f.color)}const g={type:"polygon",id:`${r}-face-${d}`,vertices:$,fill:{type:"solid",color:b},zIndex:c,layer:a};l.push({element:g,depth:c})}return l}function j(i,t){const e=ve(i),r=e[0]*t.scale+t.offset[0],s=-e[1]*t.scale+t.offset[1];return[r,s]}function xe(i,t,e,r,s,n,o,a){const l=P([0,0,0],t),c=j(l,s),d=P([i,0,0],t),u=j(d,s),h=Math.sqrt(Math.pow(u[0]-c[0],2)+Math.pow(u[1]-c[1],2));let p;if(o.directional){const g=F(o.directional.direction),f=P([0,0,0],n),y=[f[0]+g[0],f[1]+g[1],f[2]+g[2]],S=t,w=P(y,S),v=P([0,0,0],S),_=[w[0]-v[0],w[1]-v[1]],E=Math.sqrt(_[0]*_[0]+_[1]*_[1]);if(E>.001){const C=[_[0]/E,_[1]/E],I=h*.3;p=[c[0]+C[0]*I,c[1]-C[1]*I]}}let m=e;o.ambient&&(m=O(e,1,o.ambient));let $=m,b=m;if(o.directional){const g=o.directional,f=g.ambient+(1-g.ambient)*1;$=O(m,f,g.color);const y=g.ambient;b=O(m,y,g.color)}else b=O(m,.5,"#000000");return[{element:{type:"circle",id:`${r}-sphere`,center:c,radius:h,fill:p?{type:"radial",center:c,radius:h,focalPoint:p,stops:[{offset:0,color:$},{offset:1,color:b}]}:{type:"radial",center:c,radius:h,stops:[{offset:0,color:$},{offset:1,color:b}]},zIndex:l[2],layer:a},depth:l[2]}]}function Ae(i,t,e,r,s,n,o,a,l){const c=P([0,t/2,0],e),d=j(c,n),u=P([i,t/2,0],e),h=j(u,n),p=Math.sqrt(Math.pow(h[0]-d[0],2)+Math.pow(h[1]-d[1],2));let m;if(a.directional){const f=F(a.directional.direction),y=P([0,t/2,0],o),S=[y[0]+f[0],y[1]+f[1],y[2]+f[2]],w=P(S,e),v=P([0,t/2,0],e),_=[w[0]-v[0],w[1]-v[1]],E=Math.sqrt(_[0]*_[0]+_[1]*_[1]);if(E>.001){const C=[_[0]/E,_[1]/E],I=p*.3;m=[d[0]+C[0]*I,d[1]-C[1]*I]}}let $=r;a.ambient&&($=O(r,1,a.ambient));let b=$,g=$;if(a.directional){const f=a.directional,y=f.ambient+(1-f.ambient)*1;b=O($,y,f.color);const S=f.ambient;g=O($,S,f.color)}else g=O($,.5,"#000000");return[{element:{type:"circle",id:`${s}-cylinder`,center:d,radius:p,fill:m?{type:"radial",center:d,radius:p,focalPoint:m,stops:[{offset:0,color:b},{offset:1,color:g}]}:{type:"radial",center:d,radius:p,stops:[{offset:0,color:b},{offset:1,color:g}]},zIndex:c[2],layer:l},depth:c[2]}]}function ke(i,t,e,r,s,n,o,a,l){const c=P([0,0,0],e),d=j(c,n),u=P([i,0,0],e),h=j(u,n),p=Math.sqrt(Math.pow(h[0]-d[0],2)+Math.pow(h[1]-d[1],2));let m;if(a.directional){const f=F(a.directional.direction),y=P([0,0,0],o),S=[y[0]+f[0],y[1]+f[1],y[2]+f[2]],w=P(S,e),v=P([0,0,0],e),_=[w[0]-v[0],w[1]-v[1]],E=Math.sqrt(_[0]*_[0]+_[1]*_[1]);if(E>.001){const C=[_[0]/E,_[1]/E],I=p*.3;m=[d[0]+C[0]*I,d[1]-C[1]*I]}}let $=r;a.ambient&&($=O(r,1,a.ambient));let b=$,g=$;if(a.directional){const f=a.directional,y=f.ambient+(1-f.ambient)*1;b=O($,y,f.color);const S=f.ambient;g=O($,S,f.color)}else g=O($,.5,"#000000");return[{element:{type:"circle",id:`${s}-cone`,center:d,radius:p,fill:m?{type:"radial",center:d,radius:p,focalPoint:m,stops:[{offset:0,color:b},{offset:1,color:g}]}:{type:"radial",center:d,radius:p,stops:[{offset:0,color:b},{offset:1,color:g}]},zIndex:c[2],layer:l},depth:c[2]}]}function Me(i,t,e,r,s,n,o){const{radius:a,aspectRatio:l=1,direction:c,glowScale:d=2}=i,u=P([0,0,0],t),h=j(u,s);let p,m,$=0;if(l!==1&&c){const g=F(we(c,n)),f=P([0,0,0],n),y=pe(f,g),S=P(y,t),w=j(S,s),v=[w[0]-h[0],w[1]-h[1]];$=Math.atan2(v[1],v[0]);const _=P([a,0,0],t),E=j(_,s),C=Math.sqrt(Math.pow(E[0]-h[0],2)+Math.pow(E[1]-h[1],2));p=C*d,m=C*l*d}else{const g=P([a,0,0],t),f=j(g,s),y=Math.sqrt(Math.pow(f[0]-h[0],2)+Math.pow(f[1]-h[1],2));p=y*d,m=y*l*d}const b=[{offset:0,color:e,opacity:1},{offset:.4,color:e,opacity:.8},{offset:.7,color:e,opacity:.3},{offset:1,color:e,opacity:0}];return Math.abs(p-m)<.01?[{element:{type:"circle",id:`${r}-light`,center:h,radius:p,fill:{type:"radial",center:h,radius:p,stops:b},zIndex:u[2],layer:o},depth:u[2]}]:[{element:{type:"ellipse",id:`${r}-light`,center:h,radiusX:p,radiusY:m,rotation:$,fill:{type:"radial",center:h,radius:Math.max(p,m),stops:b},zIndex:u[2],layer:o},depth:u[2]}]}function Te(i){const t=[1,0,0],e=[0,1,0],r=[0,0,1],s=P(t,i),n=P(e,i),o=P(r,i),a=40,l=[60,60],c=l,d=[l[0]+s[0]*a,l[1]-s[1]*a],u=[l[0]+n[0]*a,l[1]-n[1]*a],h=[l[0]+o[0]*a,l[1]-o[1]*a];return{origin:c,xAxis:{end:d,color:"#ff0000"},yAxis:{end:u,color:"#00ff00"},zAxis:{end:h,color:"#0000ff"}}}function It(i,t,e=800,r=600,s={}){const n=Se(t),o=be(t),a=G(o,n),l=t.getScale(),c=t.getOffset(),d=[e/2+c[0],r/2+c[1]],u=_e(i,a,{scale:l,offset:d},s.transformOverrides),h=u.screenSpaceNode,p=u.elements.sort(($,b)=>$.depth-b.depth).map($=>$.element);let m={root:h,width:e,height:r,renderOrder:p};return i.background!==void 0&&(m={...m,background:i.background}),s.showGizmo&&(m={...m,gizmo:Te(a)}),m}function Ve(i,t,e=!0){const r=e?"  ":"",s=e?`
`:"",n=[];n.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${i.width}" height="${i.height}">`),i.background&&n.push(Oe(i.background,r,s));const o=i.renderOrder,a=new Map;for(const c of o){const d=c.layer;a.has(d)||a.set(d,[]),a.get(d).push(c)}const l=Array.from(a.keys()).sort((c,d)=>c-d);for(const c of l){const d=a.get(c);n.push(Re(c,d,t,r,s))}return i.gizmo&&n.push(je(i.gizmo,r,s)),n.push("</svg>"),n.join(s)}function Ne(i,t){return t!=null&&t.layers?t.layers(i)??{opacity:1}:{opacity:1}}function Oe(i,t,e){const r=[];return i.type==="solid"?r.push(`${t}<rect width="100%" height="100%" fill="${i.color}"/>`):(r.push(`${t}<defs>`),r.push(`${t}${t}<linearGradient id="bg-gradient" x1="0%" y1="0%" x2="0%" y2="100%">`),r.push(`${t}${t}${t}<stop offset="0%" stop-color="${i.topColor}"/>`),r.push(`${t}${t}${t}<stop offset="100%" stop-color="${i.bottomColor}"/>`),r.push(`${t}${t}</linearGradient>`),r.push(`${t}</defs>`),r.push(`${t}<rect width="100%" height="100%" fill="url(#bg-gradient)"/>`)),r.join(e)}function Re(i,t,e,r,s){const n=[],o=Ne(i,e);let a=`${r}<g id="layer-${i}"`;o.opacity!==1&&(a+=` opacity="${o.opacity}"`),a+=">",n.push(a);const l=[];for(const c of t)if(c.type==="polygon"){const{svg:d,gradientDef:u}=Le(c,r+r);n.push(d),u&&l.push(u)}else if(c.type==="circle"){const{svg:d,gradientDef:u}=ze(c,r+r);n.push(d),u&&l.push(u)}else if(c.type==="ellipse"){const{svg:d,gradientDef:u}=Ge(c,r+r);n.push(d),u&&l.push(u)}return l.length>0&&(n.splice(1,0,`${r}${r}<defs>`),n.splice(2,0,...l.map(c=>`${r}${r}${r}${c}`)),n.splice(2+l.length,0,`${r}${r}</defs>`)),n.push(`${r}</g>`),n.join(s)}function Le(i,t){const e=i.vertices.map(n=>`${n[0]},${n[1]}`).join(" ");let r,s;if(i.fill.type==="solid")r=`fill="${i.fill.color}"`;else if(i.fill.type==="gradient"){const n=`gradient-${i.id}`;r=`fill="url(#${n})"`;const o=i.fill,a=o.stops.map(l=>`<stop offset="${l.offset*100}%" stop-color="${l.color}"/>`).join("");s=`<linearGradient id="${n}" x1="${o.start[0]}" y1="${o.start[1]}" x2="${o.end[0]}" y2="${o.end[1]}" gradientUnits="userSpaceOnUse">${a}</linearGradient>`}else{const n=`gradient-${i.id}`;r=`fill="url(#${n})"`;const o=i.fill,a=o.stops.map(c=>`<stop offset="${c.offset*100}%" stop-color="${c.color}"/>`).join(""),l=o.focalPoint?`fx="${o.focalPoint[0]}" fy="${o.focalPoint[1]}"`:"";s=`<radialGradient id="${n}" cx="${o.center[0]}" cy="${o.center[1]}" r="${o.radius}" ${l} gradientUnits="userSpaceOnUse">${a}</radialGradient>`}return{svg:`${t}<polygon id="${i.id}" points="${e}" ${r} stroke="none"/>`,gradientDef:s}}function ze(i,t){let e,r;if(i.fill.type==="solid")e=`fill="${i.fill.color}"`;else if(i.fill.type==="gradient"){const s=`gradient-${i.id}`;e=`fill="url(#${s})"`;const n=i.fill,o=n.stops.map(a=>`<stop offset="${a.offset*100}%" stop-color="${a.color}"/>`).join("");r=`<linearGradient id="${s}" x1="${n.start[0]}" y1="${n.start[1]}" x2="${n.end[0]}" y2="${n.end[1]}" gradientUnits="userSpaceOnUse">${o}</linearGradient>`}else{const s=`gradient-${i.id}`;e=`fill="url(#${s})"`;const n=i.fill,o=n.stops.map(l=>`<stop offset="${l.offset*100}%" stop-color="${l.color}"/>`).join(""),a=n.focalPoint?`fx="${n.focalPoint[0]}" fy="${n.focalPoint[1]}"`:"";r=`<radialGradient id="${s}" cx="${n.center[0]}" cy="${n.center[1]}" r="${n.radius}" ${a} gradientUnits="userSpaceOnUse">${o}</radialGradient>`}return{svg:`${t}<circle id="${i.id}" cx="${i.center[0]}" cy="${i.center[1]}" r="${i.radius}" ${e} stroke="none"/>`,gradientDef:r}}function Ge(i,t){let e,r;if(i.fill.type==="solid")e=`fill="${i.fill.color}"`;else if(i.fill.type==="gradient"){const n=`gradient-${i.id}`;e=`fill="url(#${n})"`;const o=i.fill,a=o.stops.map(l=>{const c=l.opacity!==void 0?` stop-opacity="${l.opacity}"`:"";return`<stop offset="${l.offset*100}%" stop-color="${l.color}"${c}/>`}).join("");r=`<linearGradient id="${n}" x1="${o.start[0]}" y1="${o.start[1]}" x2="${o.end[0]}" y2="${o.end[1]}" gradientUnits="userSpaceOnUse">${a}</linearGradient>`}else{const n=`gradient-${i.id}`;e=`fill="url(#${n})"`;const o=i.fill,a=o.stops.map(c=>{const d=c.opacity!==void 0?` stop-opacity="${c.opacity}"`:"";return`<stop offset="${c.offset*100}%" stop-color="${c.color}"${d}/>`}).join(""),l=o.focalPoint?`fx="${o.focalPoint[0]}" fy="${o.focalPoint[1]}"`:"";r=`<radialGradient id="${n}" cx="${o.center[0]}" cy="${o.center[1]}" r="${o.radius}" ${l} gradientUnits="userSpaceOnUse">${a}</radialGradient>`}const s=i.rotation!==0?` transform="rotate(${i.rotation*180/Math.PI} ${i.center[0]} ${i.center[1]})"`:"";return{svg:`${t}<ellipse id="${i.id}" cx="${i.center[0]}" cy="${i.center[1]}" rx="${i.radiusX}" ry="${i.radiusY}"${s} ${e} stroke="none"/>`,gradientDef:r}}function je(i,t,e){const r=[];r.push(`${t}<g id="axis-gizmo">`);const s=(o,a,l)=>`${t}${t}<line x1="${o[0]}" y1="${o[1]}" x2="${a[0]}" y2="${a[1]}" stroke="${l}" stroke-width="2" stroke-linecap="round"/>`,n=(o,a,l)=>`${t}${t}<text x="${o[0]}" y="${o[1]}" fill="${l}" font-size="12" font-weight="bold">${a}</text>`;return r.push(s(i.origin,i.xAxis.end,i.xAxis.color)),r.push(s(i.origin,i.yAxis.end,i.yAxis.color)),r.push(s(i.origin,i.zAxis.end,i.zAxis.color)),r.push(n(i.xAxis.end,"X",i.xAxis.color)),r.push(n(i.yAxis.end,"Y",i.yAxis.color)),r.push(n(i.zAxis.end,"Z",i.zAxis.color)),r.push(`${t}</g>`),r.join(e)}class De{constructor(t){T(this,"svg",null),T(this,"currentScreenSpace",null),T(this,"currentRenderOptions"),T(this,"animationFrameId",null),this.config=t,this.initialize()}initialize(){this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",String(this.config.width??800)),this.svg.setAttribute("height",String(this.config.height??600)),this.svg.style.display="block",this.config.target.appendChild(this.svg)}render(t,e){this.currentScreenSpace=t,this.currentRenderOptions=e,this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(()=>{this.performRender()})}performRender(){if(!this.svg||!this.currentScreenSpace)return;this.svg.innerHTML="",this.currentScreenSpace.background&&this.renderBackground(this.currentScreenSpace.background);const t=this.currentScreenSpace.renderOrder,e=new Map;for(const s of t){const n=s.layer;e.has(n)||e.set(n,[]),e.get(n).push(s)}const r=Array.from(e.keys()).sort((s,n)=>s-n);for(const s of r){const n=e.get(s);this.renderLayer(s,n)}this.currentScreenSpace.gizmo&&this.renderGizmo(this.currentScreenSpace.gizmo)}renderLayer(t,e){if(!this.svg)return;const r=document.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("id",`layer-${t}`);const s=this.getLayerConfig(t);s.opacity!==1&&r.setAttribute("opacity",String(s.opacity)),s.tint;for(const n of e)n.type==="polygon"?this.renderPolygonToGroup(n,r):n.type==="circle"?this.renderCircleToGroup(n,r):n.type==="ellipse"&&this.renderEllipseToGroup(n,r);this.svg.appendChild(r)}getLayerConfig(t){var e;return(e=this.currentRenderOptions)!=null&&e.layers?this.currentRenderOptions.layers(t)??{opacity:1}:{opacity:1}}renderBackground(t){if(!this.svg)return;const e=document.createElementNS("http://www.w3.org/2000/svg","rect");if(e.setAttribute("width","100%"),e.setAttribute("height","100%"),t.type==="solid")e.setAttribute("fill",t.color);else{const r="bg-gradient",s=document.createElementNS("http://www.w3.org/2000/svg","defs"),n=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");n.setAttribute("id",r),n.setAttribute("x1","0%"),n.setAttribute("y1","0%"),n.setAttribute("x2","0%"),n.setAttribute("y2","100%");const o=document.createElementNS("http://www.w3.org/2000/svg","stop");o.setAttribute("offset","0%"),o.setAttribute("stop-color",t.topColor);const a=document.createElementNS("http://www.w3.org/2000/svg","stop");a.setAttribute("offset","100%"),a.setAttribute("stop-color",t.bottomColor),n.appendChild(o),n.appendChild(a),s.appendChild(n),this.svg.appendChild(s),e.setAttribute("fill",`url(#${r})`)}this.svg.appendChild(e)}renderPolygonToGroup(t,e){const r=document.createElementNS("http://www.w3.org/2000/svg","polygon");r.setAttribute("id",t.id);const s=t.vertices.map(n=>`${n[0]},${n[1]}`).join(" ");r.setAttribute("points",s),this.applyFill(r,t.fill),r.setAttribute("stroke","none"),e.appendChild(r)}renderCircleToGroup(t,e){const r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("id",t.id),r.setAttribute("cx",String(t.center[0])),r.setAttribute("cy",String(t.center[1])),r.setAttribute("r",String(t.radius)),this.applyFill(r,t.fill),r.setAttribute("stroke","none"),e.appendChild(r)}renderEllipseToGroup(t,e){const r=document.createElementNS("http://www.w3.org/2000/svg","ellipse");if(r.setAttribute("id",t.id),r.setAttribute("cx",String(t.center[0])),r.setAttribute("cy",String(t.center[1])),r.setAttribute("rx",String(t.radiusX)),r.setAttribute("ry",String(t.radiusY)),t.rotation!==0){const s=t.rotation*180/Math.PI;r.setAttribute("transform",`rotate(${s} ${t.center[0]} ${t.center[1]})`)}this.applyFill(r,t.fill),r.setAttribute("stroke","none"),e.appendChild(r)}applyFill(t,e){if(e.type==="solid")t.setAttribute("fill",e.color);else if(e.type==="gradient"){const r=`gradient-${Math.random().toString(36).substr(2,9)}`;if(!this.svg)return;let s=this.svg.querySelector("defs");s||(s=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.svg.appendChild(s));const n=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");n.setAttribute("id",r),n.setAttribute("x1",String(e.start[0])),n.setAttribute("y1",String(e.start[1])),n.setAttribute("x2",String(e.end[0])),n.setAttribute("y2",String(e.end[1])),n.setAttribute("gradientUnits","userSpaceOnUse");for(const o of e.stops){const a=document.createElementNS("http://www.w3.org/2000/svg","stop");a.setAttribute("offset",`${o.offset*100}%`),a.setAttribute("stop-color",o.color),o.opacity!==void 0&&a.setAttribute("stop-opacity",String(o.opacity)),n.appendChild(a)}s.appendChild(n),t.setAttribute("fill",`url(#${r})`)}else if(e.type==="radial"){const r=`radial-gradient-${Math.random().toString(36).substr(2,9)}`;if(!this.svg)return;let s=this.svg.querySelector("defs");s||(s=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.svg.appendChild(s));const n=document.createElementNS("http://www.w3.org/2000/svg","radialGradient");n.setAttribute("id",r),n.setAttribute("cx",String(e.center[0])),n.setAttribute("cy",String(e.center[1])),n.setAttribute("r",String(e.radius)),n.setAttribute("gradientUnits","userSpaceOnUse"),e.focalPoint&&(n.setAttribute("fx",String(e.focalPoint[0])),n.setAttribute("fy",String(e.focalPoint[1])));for(const o of e.stops){const a=document.createElementNS("http://www.w3.org/2000/svg","stop");a.setAttribute("offset",`${o.offset*100}%`),a.setAttribute("stop-color",o.color),o.opacity!==void 0&&a.setAttribute("stop-opacity",String(o.opacity)),n.appendChild(a)}s.appendChild(n),t.setAttribute("fill",`url(#${r})`)}}renderGizmo(t){if(!this.svg)return;const e="http://www.w3.org/2000/svg",r=document.createElementNS(e,"g");r.setAttribute("id","axis-gizmo");const s=(o,a,l)=>{const c=document.createElementNS(e,"line");return c.setAttribute("x1",o[0].toString()),c.setAttribute("y1",o[1].toString()),c.setAttribute("x2",a[0].toString()),c.setAttribute("y2",a[1].toString()),c.setAttribute("stroke",l),c.setAttribute("stroke-width","2"),c.setAttribute("stroke-linecap","round"),c},n=(o,a,l)=>{const c=document.createElementNS(e,"text");return c.setAttribute("x",o[0].toString()),c.setAttribute("y",o[1].toString()),c.setAttribute("fill",l),c.setAttribute("font-size","12"),c.setAttribute("font-weight","bold"),c.textContent=a,c};r.appendChild(s(t.origin,t.xAxis.end,t.xAxis.color)),r.appendChild(s(t.origin,t.yAxis.end,t.yAxis.color)),r.appendChild(s(t.origin,t.zAxis.end,t.zAxis.color)),r.appendChild(n(t.xAxis.end,"X",t.xAxis.color)),r.appendChild(n(t.yAxis.end,"Y",t.yAxis.color)),r.appendChild(n(t.zAxis.end,"Z",t.zAxis.color)),this.svg.appendChild(r)}toSVG(t=!0){return this.currentScreenSpace?Ve(this.currentScreenSpace,this.currentRenderOptions,t):null}destroy(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.svg&&(this.svg.remove(),this.svg=null),this.currentScreenSpace=null}}class lt{constructor(t){switch(T(this,"backend"),t.backend){case"svg":this.backend=new De(t);break;case"canvas":throw new Error("Canvas renderer not yet implemented");default:throw new Error(`Unknown backend: ${t.backend}`)}}render(t,e){this.backend.render(t,e)}destroy(){this.backend.destroy()}}function We(){return[0,0,0,1]}function He(i){const[t,e,r,s]=i,n=2*(s*t+e*r),o=1-2*(t*t+e*e),a=Math.atan2(n,o),l=2*(s*e-r*t),c=Math.abs(l)>=1?Math.sign(l)*Math.PI/2:Math.asin(l),d=2*(s*r+t*e),u=1-2*(e*e+r*r),h=Math.atan2(d,u);return[a,c,h]}function Fe(i){const[t,e,r,s]=i,n=Math.sqrt(t*t+e*e+r*r+s*s);return n===0?We():[t/n,e/n,r/n,s/n]}function Be(i,t){return i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]*t[3]}function qe(i,t,e){let r=Be(i,t),s=t;if(r<0&&(r=-r,s=[-t[0],-t[1],-t[2],-t[3]]),r>.9995){const c=i[0]+e*(s[0]-i[0]),d=i[1]+e*(s[1]-i[1]),u=i[2]+e*(s[2]-i[2]),h=i[3]+e*(s[3]-i[3]);return Fe([c,d,u,h])}const n=Math.acos(r),o=Math.sin(n),a=Math.sin((1-e)*n)/o,l=Math.sin(e*n)/o;return[a*i[0]+l*s[0],a*i[1]+l*s[1],a*i[2]+l*s[2],a*i[3]+l*s[3]]}const Pt={easeInQuad:i=>i*i,easeInOutQuad:i=>i<.5?2*i*i:-1+(4-2*i)*i};function J(i,t,e){return i+(t-i)*e}function Ue(i,t,e){return[J(i[0],t[0],e),J(i[1],t[1],e),J(i[2],t[2],e)]}function bt(i,t){if(i.length===0)return null;const e=i[0];if(!e)return null;if(i.length===1)return{start:e,end:e,localT:0};for(let s=0;s<i.length-1;s++){const n=i[s],o=i[s+1];if(n&&o&&t>=n.time&&t<=o.time){const a=o.time-n.time,l=a===0?0:(t-n.time)/a;return{start:n,end:o,localT:l}}}if(t<e.time)return{start:e,end:e,localT:0};const r=i[i.length-1];return r?{start:r,end:r,localT:0}:null}function qt(i,t,e=!1){const r=bt(i,t);if(!r)return null;const{start:s,end:n,localT:o}=r;if(e)return o>=1?n.value:s.value;const a=s.easing?s.easing(o):o;return Ue(s.value,n.value,a)}function Xe(i,t,e=!1){const r=bt(i,t);if(!r)return null;const{start:s,end:n,localT:o}=r;if(e)return o>=1?n.value:s.value;const a=s.easing?s.easing(o):o;return qe(s.value,n.value,a)}class Ye{constructor(){T(this,"clips"),T(this,"state"),this.clips=new Map,this.state={clipId:null,currentTime:0,playing:!1,speed:1}}addClip(t){this.clips.set(t.id,t)}removeClip(t){this.clips.delete(t),this.state.clipId===t&&this.stop()}play(t){if(!this.clips.get(t)){console.warn(`Animation clip "${t}" not found`);return}this.state={clipId:t,currentTime:0,playing:!0,speed:this.state.speed}}pause(){this.state={...this.state,playing:!1}}resume(){this.state.clipId&&(this.state={...this.state,playing:!0})}stop(){this.state={clipId:null,currentTime:0,playing:!1,speed:this.state.speed}}setSpeed(t){this.state={...this.state,speed:t}}getState(){return this.state}update(t){if(!this.state.playing||!this.state.clipId)return;const e=this.clips.get(this.state.clipId);if(!e)return;let r=this.state.currentTime+t*this.state.speed;e.loop?r=r%e.duration:r>=e.duration&&(r=e.duration,this.state={...this.state,playing:!1}),this.state={...this.state,currentTime:r}}evaluateTransforms(){if(!this.state.clipId)return new Map;const t=this.clips.get(this.state.clipId);if(!t)return new Map;const e=new Map;for(const r of t.animations){let s,n,o;for(const l of r.channels){const c=this.evaluateChannel(l,this.state.currentTime);if(c)switch(l.target){case"position":s=c;break;case"scale":o=c;break;case"rotation":n=c;break;case"rotationQuat":n=He(c);break}}const a={};s!==void 0&&(a.position=s),n!==void 0&&(a.rotation=n),o!==void 0&&(a.scale=o),Object.keys(a).length>0&&e.set(r.nodeId,a)}return e}evaluateChannel(t,e){const r=t.interpolation==="step";switch(t.target){case"position":case"scale":case"rotation":return qt(t.keyFrames,e,r);case"rotationQuat":return Xe(t.keyFrames,e,r);default:return null}}}class Ze{constructor(){T(this,"clips"),T(this,"state"),this.clips=new Map,this.state={clipId:null,currentTime:0,playing:!1,speed:1}}addClip(t){this.clips.set(t.id,t)}removeClip(t){this.clips.delete(t),this.state.clipId===t&&this.stop()}play(t){if(!this.clips.get(t)){console.warn(`Camera animation clip "${t}" not found`);return}this.state={clipId:t,currentTime:0,playing:!0,speed:this.state.speed}}pause(){this.state={...this.state,playing:!1}}resume(){this.state.clipId&&(this.state={...this.state,playing:!0})}stop(){this.state={clipId:null,currentTime:0,playing:!1,speed:this.state.speed}}setSpeed(t){this.state={...this.state,speed:t}}getState(){return this.state}update(t){if(!this.state.playing||!this.state.clipId)return;const e=this.clips.get(this.state.clipId);if(!e)return;let r=this.state.currentTime+t*this.state.speed;e.loop?r=r%e.duration:r>=e.duration&&(r=e.duration,this.state={...this.state,playing:!1}),this.state={...this.state,currentTime:r}}evaluateCamera(t){if(!this.state.clipId||!this.state.playing)return t;const e=this.clips.get(this.state.clipId);if(!e)return t;let r,s,n,o,a,l;for(const d of e.channels){const u=this.evaluateChannel(d,this.state.currentTime);if(u!==null)switch(d.target){case"center":r=u;break;case"rightEdge":s=u;break;case"yaw":n=u;break;case"pitch":o=u;break;case"groundScale":a=u;break;case"heightScale":l=u;break}}const c={};return r!==void 0&&(c.center=r),s!==void 0&&(c.rightEdge=s),n!==void 0&&(c.yaw=n),o!==void 0&&(c.pitch=o),a!==void 0&&(c.groundScale=a),l!==void 0&&(c.heightScale=l),Object.keys(c).length>0?t.withConfig(c):t}evaluateChannel(t,e){const r=t.interpolation==="step";switch(t.target){case"center":case"rightEdge":return qt(t.keyFrames,e,r);case"yaw":case"pitch":case"groundScale":case"heightScale":return this.interpolateNumber(t.keyFrames,e,r);default:return null}}interpolateNumber(t,e,r=!1){const s=bt(t,e);if(!s)return null;const{start:n,end:o,localT:a}=s;if(r)return a>=1?o.value:n.value;const l=n.easing?n.easing(a):a;return J(n.value,o.value,l)}}function Ke(i,t,e){const r=(1-Math.abs(2*e-1))*t,s=r*(1-Math.abs(i/60%2-1)),n=e-r/2;let o=0,a=0,l=0;i<60?(o=r,a=s,l=0):i<120?(o=s,a=r,l=0):i<180?(o=0,a=r,l=s):i<240?(o=0,a=s,l=r):i<300?(o=s,a=0,l=r):(o=r,a=0,l=s);const c=d=>Math.round((d+n)*255).toString(16).padStart(2,"0");return`#${c(o)}${c(a)}${c(l)}`}function Qe(i){let t=0;for(let r=0;r<i.length;r++)t=i.charCodeAt(r)+((t<<5)-t);const e=Math.abs(t%360);return Ke(e,.7,.6)}function tt(i,t,e,r){return A.custom({center:i,rightEdge:[i[0]+t/2,i[1],i[2]],viewportWidth:e,viewportHeight:r,yaw:40,pitch:28,groundScale:1,heightScale:1})}function gt(i){if(i.focusDepth!==-1||!i.focusOffset)return;const[t,e]=i.focusOffset;if(t<=0&&e>=0)return 1}function ct(i,t){const{width:e,height:r,store:s,tagFn:n}=t;if(!rt(i))throw new Error("Root node must be a NestedNode");const o=new le;o.background({type:"gradient",bottomColor:"#00352D",topColor:"#3A7B6F"}).light({direction:[1,2,1],color:"#ffffff",ambient:.5});const a=1,l=a/2;o.object("floor-square",{type:"shape",vertices:[[l,0,-l],[-l,0,-l],[-l,0,l],[l,0,l]]}),o.object("concrete-cube",ce(.8)),o.object("player-octahedron",de(.8)),o.object("concrete-pyramid",ue(.7));const c=.3,u=.9/2;o.object("stop-box",{type:"solid",faces:[{vertices:[[-u,0,-u],[u,0,-u],[u,0,u],[-u,0,u]]},{vertices:[[-u,c,-u],[-u,c,u],[u,c,u],[u,c,-u]]},{vertices:[[u,0,u],[u,c,u],[-u,c,u],[-u,0,u]]},{vertices:[[-u,0,-u],[-u,c,-u],[u,c,-u],[u,0,-u]]},{vertices:[[-u,0,u],[-u,c,u],[-u,c,-u],[-u,0,-u]]},{vertices:[[u,0,-u],[u,c,-u],[u,c,u],[u,0,u]]}]});const h=new Map,p=new Map;let m=0;function $(x,M=!1,R=0){if(rt(x)){!M&&!h.has(x)&&(h.set(x,`grid-template-${m++}`),p.set(x,R));for(const W of x.children)for(const B of W)$(B,!1,R)}else et(x)&&$(x.content,!1,R+1)}$(i,!0,0);const b=Array.from(h.keys());for(let x=b.length-1;x>=0;x--){const M=b[x],R=h.get(M),W=p.get(M)??0,B=xt(M.gridId);er(M,R,o,B,a,h,s,n,0,W)}const g=i.children.length,f=i.children[0]?.length||0,y=f,S=g;o.object("floor-base",{type:"shape",vertices:[[0,0,0],[-y,0,0],[-y,0,S],[0,0,S]]});const w=-(f-1)/2,v=-(g-1)/2,_=xt(i.gridId);o.group("base-floor-layer",{layer:-50}),o.instance("floor-base",{position:[y/2,0,-S/2],color:_.dark}),o.endGroup(),tr(i,o,[w,0,v],_,a,h,s,n);const E=o.build(),I=Math.max(g,f)*1.2,N=tt([0,0,0],I,e,r);return{scene:E,camera:N,width:e,height:r}}function xt(i){return{main:{light:"#292929",dark:"#0a0a0a"},inner:{light:"#29553f",dark:"#13281e"},a:{light:"#293f55",dark:"#131e28"},b:{light:"#4a294a",dark:"#231323"},c:{light:"#4a4a29",dark:"#232313"},d:{light:"#552929",dark:"#281313"},e:{light:"#29553f",dark:"#13281e"},f:{light:"#553f29",dark:"#281e13"},first:{light:"#293f55",dark:"#131e28"},second:{light:"#4a294a",dark:"#231323"},third:{light:"#552929",dark:"#281313"},fourth:{light:"#29553f",dark:"#13281e"},fifth:{light:"#553f29",dark:"#281e13"}}[i]||{light:"#555529",dark:"#282813"}}function At(i){i=i.replace("#","");const t=parseInt(i.substring(0,2),16)/255,e=parseInt(i.substring(2,4),16)/255,r=parseInt(i.substring(4,6),16)/255,s=Math.max(t,e,r),n=Math.min(t,e,r),o=s-n;let a=0,l=0;const c=(s+n)/2;return o!==0&&(l=c>.5?o/(2-s-n):o/(s+n),s===t?a=((e-r)/o+(e<r?6:0))/6:s===e?a=((r-t)/o+2)/6:a=((t-e)/o+4)/6),[a*360,l,c]}function Je(i,t,e){i=i/360;const r=(l,c,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?l+(c-l)*6*d:d<1/2?c:d<2/3?l+(c-l)*(2/3-d)*6:l);let s,n,o;if(t===0)s=n=o=e;else{const l=e<.5?e*(1+t):e+t-e*t,c=2*e-l;s=r(c,l,i+1/3),n=r(c,l,i),o=r(c,l,i-1/3)}const a=l=>{const c=Math.round(l*255).toString(16);return c.length===1?"0"+c:c};return`#${a(s)}${a(n)}${a(o)}`}function Ut(i){const t="#f0a0a0",[e,r]=At(i),[,s,n]=At(t),o=r<.05?0:s;return Je(e,o,n)}function Xt(i){const e={1:"#ffb3ba",2:"#bae1ff",3:"#ffffba",4:"#baffc9",5:"#ffdfba",6:"#e0bfff",7:"#ffd4e5",8:"#d4f4dd"}[i]||Qe(i),r=parseInt(i,10),s=isNaN(r)||r%2===1?"cube":"pyramid";return{model:s,yOffset:s==="cube"?.4:0,color:e}}function tr(i,t,e,r,s,n,o,a){const l=i.children.length,c=i.children[0]?.length||0,d=V(o,i.gridId);for(let u=0;u<l;u++)for(let h=0;h<c;h++){const p=i.children[u][h];let m;if(ft(p))m=`concrete-${p.id}`;else if(et(p)){const w=d?.cells[u]?.[h];if(w&&z(w)){const v=w.isPrimary===!0?"primary":w.isPrimary===!1?"secondary":"auto";m=`ref-${w.gridId}-${v}`}else m=`ref-${p.gridId}-${u}-${h}`}else m=`empty-${u}-${h}`;const $=e[0]+h,b=e[1],g=e[2]+u,f=`root-cell-${u}-${h}`;t.group(f,{position:[$,b,g]}),(u+h)%2===0&&(t.group(`root-floor-${u}-${h}`,{layer:-50}),t.instance("floor-square",{position:[0,0,0],color:r.light}),t.endGroup());const S=gt(p);if(t.group(m,{position:[0,0,0],...S!==void 0&&{layer:S}}),ft(p)){const w=mt(p.id),v=a(w),_=v.has("player"),E=v.has("stop"),C=Xt(p.id);let I=C.model==="cube"?"concrete-cube":"concrete-pyramid",N=C.yOffset,x=C.color;E&&(I="stop-box",N=0,x=Ut(r.light)),_&&(I="player-octahedron",N=.8/Math.sqrt(2),x="#F4E04D"),t.instance(I,{position:[0,N,0],color:x})}else if(et(p)&&rt(p.content)){const w=d?.cells[u]?.[h],v=w&&z(w)&&w.isPrimary===!1,_=n.get(p.content);if(!_)console.error(`Template not found for nested grid: ${p.content.gridId}`);else{const E=p.content.children.length,C=p.content.children[0]?.length||0,I=1/C,N=1/E,x=1/Math.max(C,E);v&&t.group("lighting-override",{lighting:{ambient:"#ffffff",directional:{direction:[1,2,1],color:"#ffffff",ambient:.8}}}),t.reference(_,{scale:[I,x,N]}),v&&t.endGroup()}}t.endGroup(),t.endGroup()}}function er(i,t,e,r,s,n,o,a,l=0,c=0){e.template(t);const d=i.children.length,u=i.children[0]?.length||0,h=u,p=d,m=h/2,$=-p/2;e.object(`${t}-floor-base`,{type:"shape",vertices:[[0,0,0],[-h,0,0],[-h,0,p],[0,0,p]]});const b=l-50+c;e.group(`${t}-base-floor-layer`,{layer:b}),e.instance(`${t}-floor-base`,{position:[m,0,$],color:r.dark}),e.endGroup();for(let g=0;g<d;g++)for(let f=0;f<u;f++){const y=i.children[g][f],S=f-(u-1)/2,w=g-(d-1)/2;if(e.group(`${t}-cell-${g}-${f}`,{position:[S,0,w]}),(g+f)%2===0&&(e.group(`${t}-floor-${g}-${f}`,{layer:b}),e.instance("floor-square",{position:[0,0,0],color:r.light}),e.endGroup()),ft(y)){const _=mt(y.id),E=a(_),C=E.has("player"),I=E.has("stop"),N=Xt(y.id);let x=N.model==="cube"?"concrete-cube":"concrete-pyramid",M=N.yOffset,R=N.color;I&&(x="stop-box",M=0,R=Ut(r.light)),C&&(x="player-octahedron",M=.8/Math.sqrt(2),R="#F4E04D");const W=gt(y),B=W!==void 0?W:l;e.group(`concrete-${y.id}`,{position:[0,0,0],layer:B}),e.instance(x,{position:[0,M,0],color:R}),e.endGroup()}else if(et(y)&&rt(y.content)){const _=n.get(y.content);if(!_)console.error(`Template not found for nested grid: ${y.content.gridId}`);else{const C=V(o,i.gridId)?.cells[g]?.[f];let I;if(C&&z(C)){const Kt=C.isPrimary===!0?"primary":C.isPrimary===!1?"secondary":"auto";I=`ref-${C.gridId}-${Kt}`}else I=`ref-${y.gridId}-${g}-${f}`;const N=gt(y),x=N!==void 0?N:l;e.group(I,{position:[0,0,0],layer:x});const M=y.content.children.length,R=y.content.children[0]?.length||0,W=1/R,B=1/M,Zt=1/Math.max(R,M),$t=C&&z(C)&&C.isPrimary===!1;$t&&e.group("lighting-override",{lighting:{ambient:"#ffffff",directional:{direction:[1,2,1],color:"#ffffff",ambient:.8}}}),e.reference(_,{scale:[W,Zt,B]}),$t&&e.endGroup(),e.endGroup()}}e.endGroup()}e.endTemplate()}function rr(i,t,e){const r=new ot(i,t,e);return r.tryAdvance()?r.current.gridId:null}class ir{store;constructor(t){this.store=t}setStore(t){this.store=t}getStore(){return this.store}getParent(t){const e=st(this.store,t);if(!e)return null;const[r]=e;return r}getDirectlyContainedReferences(t){const e=V(this.store,t);if(!e)return[];const r=new Set,s=[];for(let n=0;n<e.rows;n++)for(let o=0;o<e.cols;o++){const a=e.cells[n][o];z(a)&&!r.has(a.gridId)&&(r.add(a.gridId),s.push(a.gridId))}return s}findDirectlyContainedReference(t,e){return this.getDirectlyContainedReferences(t).includes(e)}getPathToAncestor(t,e){const r=[],s=new Set;let n=t;for(;;){if(s.has(n))return null;if(s.add(n),r.push(n),n===e)return r;const o=this.getParent(n);if(o===null)return null;n=o}}getAncestorChain(t,e){const r=[],s=new Set;let n=t;for(e&&s.add(e);;){if(s.has(n))return r;s.add(n),r.push(n);const o=this.getParent(n);if(o===null)return r;n=o}}getExitDestinations(t){const e=new Map,r=V(this.store,t);if(!r)return e;const s=Math.floor(r.rows/2),n=Math.floor(r.cols/2),o=new Map([[k.N,new L(t,0,n)],[k.S,new L(t,r.rows-1,n)],[k.E,new L(t,s,r.cols-1)],[k.W,new L(t,s,0)]]);for(const[a,l]of o){const c=rr(this.store,l,a);e.set(a,c)}return e}}function H(i,t){if(t.length===0)return null;const e=V(i,t[0]);if(!e)return null;if(t.length===1)return{centerX:e.cols/2,centerY:e.rows/2,width:e.cols,height:e.rows};let r=e.cols,s=e.rows,n=e.cols/2,o=e.rows/2;for(let a=0;a<t.length-1;a++){const l=t[a],c=t[a+1],d=st(i,c);if(!d)return null;const[u,h,p]=d;if(u!==l)return null;const m=V(i,l),$=V(i,c);if(!m||!$)return null;const b=r/m.cols,g=s/m.rows,f=b,y=g,S=b*p+b/2,w=g*h+g/2,v=n+(S-r/2),_=o+(w-s/2);r=f,s=y,n=v,o=_}return{centerX:n,centerY:o,width:r,height:s}}function kt(i,t,e){if(t.length===0||!t.includes(e.gridId))return null;const r=t.indexOf(e.gridId),s=t.slice(0,r+1),n=H(i,s);if(!n)return null;const o=V(i,e.gridId);if(!o)return null;const a=n.width/o.cols,l=n.height/o.rows,c=V(i,t[0]);if(!c)return null;const d=(e.col+.5)*a,u=(e.row+.5)*l,h=n.centerX-n.width/2,p=n.centerY-n.height/2,m=h+d,$=p+u,b=m-c.cols/2,g=$-c.rows/2;return{x:b,y:0,z:g}}function Mt(i,t,e=1){if(t.length===0)return null;const r=t[0],s=V(i,r);if(!s)return null;const n=H(i,t);if(!n)return null;const o=n.centerX-s.cols/2,a=n.centerY-s.rows/2,c=Math.sqrt(n.width**2+n.height**2)*e;return{position:[o,0,a],viewWidth:c}}function Tt(i,t,e){if(t.length===0||e.length===0||t[0]!==e[0])return null;t[0];const r=t[t.length-1],s=e[e.length-1],n=V(i,r),o=V(i,s);if(!n||!o)return null;const a=H(i,t),l=H(i,e);if(!a||!l)return null;const c=a.width/n.cols,d=l.width/o.cols;return c/d}function D(i,t){const e=i.getAncestorChain(t);if(e.reverse(),e.length>1)return e;const r=i.getParent(t);return[...r?[r]:[],t]}class nr{constructor(t){this.helper=t}getStandardView(t){return{targetView:D(this.helper,t)}}onPlayerEnter(t,e,r){return{targetView:D(this.helper,e)}}onPlayerExit(t,e){return{targetView:D(this.helper,e)}}onPlayerMove(t){return{targetView:D(this.helper,t)}}}class Vt{constructor(t){this.helper=t}getStandardView(t){return{targetView:D(this.helper,t)}}onPlayerEnter(t,e,r){if(r){const o=D(this.helper,e);return{targetView:o,animationStartView:o.length>1?o.slice(-1):void 0}}const s=D(this.helper,t);if(t===e)return this.helper.getParent(t)!==e&&console.warn(`Entering same grid but not self-reference (grid ${t})?`),{targetView:[...s,s[0]],animationStartView:s};const n=this.helper.getAncestorChain(e,t);return n.reverse(),{targetView:[...s,...n],animationStartView:s}}onPlayerExit(t,e){const r=D(this.helper,e);if(t===e){this.helper.getParent(t)!==e&&console.warn(`Exiting to same grid but not self-reference (grid ${t})?`);const n=e;let o;return r.length>=2&&r[r.length-1]===n&&r[r.length-2]===n?o=r.slice(0,-1):o=r,{targetView:o,animationStartView:[...o,n]}}const s=this.helper.getAncestorChain(t,e);return s.reverse(),{targetView:r,animationStartView:[...r,...s]}}onPlayerMove(t){return{targetView:D(this.helper,t),trackObjectAnimations:!0}}}function Nt(i,t){if(t.length===0)return{valid:!1,error:{message:"View path is empty"}};for(let e=0;e<t.length;e++){const r=t[e];if(!V(i,r))return{valid:!1,error:{message:`Grid '${r}' does not exist`,gridId:r,pathIndex:e}}}for(let e=0;e<t.length-1;e++){const r=t[e],s=t[e+1],n=st(i,s);if(!n)return{valid:!1,error:{message:`Grid '${s}' has no primary reference (not referenced by any parent)`,gridId:s,pathIndex:e+1}};const[o]=n;if(o!==r)return{valid:!1,error:{message:`Invalid hierarchy: Grid '${s}' is not a child of '${r}' (primary reference is in '${o}')`,gridId:s,pathIndex:e+1}}}return{valid:!0}}function sr(i,t,e){const r=e?`${e}: `:"",s=Nt(i,t.targetView);if(!s.valid)return{valid:!1,error:{message:`${r}Invalid targetView - ${s.error.message}`,gridId:s.error.gridId,pathIndex:s.error.pathIndex}};if(t.animationStartView){const n=Nt(i,t.animationStartView);if(!n.valid)return{valid:!1,error:{message:`${r}Invalid animationStartView - ${n.error.message}`,gridId:n.error.gridId,pathIndex:n.error.pathIndex}}}return{valid:!0}}function K(i,t,e){const r=sr(i,t,e);if(!r.valid)throw new Error(r.error.message)}class U{constructor(t,e){this.controller=t,this.store=e}setStore(t){this.store=t}getStore(){return this.store}getStandardView(t){const e=this.controller.getStandardView(t);return K(this.store,e,`${this.controller.constructor.name}.getStandardView`),e}onPlayerEnter(t,e,r){const s=this.controller.onPlayerEnter(t,e,r);return K(this.store,s,`${this.controller.constructor.name}.onPlayerEnter`),s}onPlayerExit(t,e){const r=this.controller.onPlayerExit(t,e);return K(this.store,r,`${this.controller.constructor.name}.onPlayerExit`),r}onPlayerMove(t){const e=this.controller.onPlayerMove(t);return K(this.store,e,`${this.controller.constructor.name}.onPlayerMove`),e}}function Ot(i,t){const e=Math.min(i.length,t.length);for(let r=e;r>0;r--){let s=!0;for(let n=0;n<r;n++)if(i[i.length-r+n]!==t[n]){s=!1;break}if(s)return i.slice(i.length-r)}return[]}function ut(i,t,e){const r=[];if(t.length===0)return r;const s=n=>{const o=e.getAncestorChain(n);return o?[...o].reverse():(console.warn(`Could not compute ancestor chain for grid '${n}'`),null)};for(let n=0;n<t.length;n++){const o=t[n],a=o.cell,l=o.position;if(a.type==="empty")continue;const c=(n+1)%t.length,d=t[c],u=d.position;if(l.equals(u))continue;let h;if(nt(a))h=`concrete-${a.id}`;else if(a.type==="ref"){const S=a.isPrimary===!0?"primary":a.isPrimary===!1?"secondary":"auto";h=`ref-${a.gridId}-${S}`}else continue;const p=d.transition==="enter"||d.transition==="exit";if(p){if(d.transition==="enter"&&d.viaNonPrimaryReference===!0)continue;if(d.transition==="exit"){const S=i[u.gridId]?.cells[u.row]?.[u.col];if(S&&S.type==="ref"&&S.isPrimary===!1)continue}}let m,$,b=null,g=null;if(p){if(b=s(l.gridId),g=s(u.gridId),!b||!g){console.warn(`  [WARN] Skipping animation for ${h}: could not determine view paths`),console.warn(`    Old: [${l.gridId}](${l.row},${l.col}), New: [${u.gridId}](${u.row},${u.col}), transition: ${d.transition}`);continue}if(l.gridId===u.gridId)continue;if(d.transition==="enter"){if(b=Ot(b,g),b.length===0){console.warn(`  [WARN] Skipping animation for ${h}: no overlap between view paths`),console.warn(`    Old: [${l.gridId}](${l.row},${l.col}), New: [${u.gridId}](${u.row},${u.col}), transition: ${d.transition}`);continue}}else if(g=Ot(g,b),g.length===0){console.warn(`  [WARN] Skipping animation for ${h}: no overlap between view paths`),console.warn(`    Old: [${l.gridId}](${l.row},${l.col}), New: [${u.gridId}](${u.row},${u.col}), transition: ${d.transition}`);continue}const w=kt(i,b,l),v=kt(i,g,u);if(!w||!v){console.warn(`  [WARN] Skipping animation for ${h}: could not calculate world positions`),console.warn(`    Old path: ${b.join("  ")}, New path: ${g.join("  ")}`),console.warn(`    Old: [${l.gridId}](${l.row},${l.col}), New: [${u.gridId}](${u.row},${u.col}), transition: ${d.transition}`);continue}m=[w.x,w.y,w.z],$=[v.x,v.y,v.z];const _=Math.abs(u.row-l.row),E=Math.abs(u.col-l.col),C=Math.max(_,E);C>5&&(console.warn(`  [WARN] ${h}: Enter/exit movement has large cell coordinate displacement (${C} cells)`),console.warn(`    Old: [${l.gridId}](${l.row},${l.col}), transition: ${d.transition}`),console.warn(`    New: [${u.gridId}](${u.row},${u.col})`),console.warn("    This might indicate incorrect world position calculation"))}else{m=[l.col+.5,0,l.row+.5],$=[u.col+.5,0,u.row+.5];const S=Math.abs(u.row-l.row)+Math.abs(u.col-l.col);S!==1&&(console.warn(`  [WARN] ${h}: In-grid movement is ${S} cells (expected 1)`),console.warn(`    Old: [${l.gridId}](${l.row},${l.col})`),console.warn(`    New: [${u.gridId}](${u.row},${u.col})`))}let f,y;if(p){const S=Tt(i,b,g);S!==null&&(f=S);const w=[g[0]],v=Tt(i,w,g);if(v!==null&&(y=v),f===void 0||y===void 0){console.warn(`  ${h}: Could not calculate scale values for enter/exit transition - skipping animation`);continue}}r.push({cellId:h,oldPos:m,newPos:$,isEnterExit:p,visualScaleRatio:f,parentScaleCompensation:y})}return r}class or{config;animationSystem;cameraAnimationSystem;animationFrameId=null;lastFrameTime=0;frameCallback=null;completionCallback=null;constructor(t={}){this.config={movementDuration:t.movementDuration??.3,cameraDuration:t.cameraDuration??.3,movementEasing:t.movementEasing??Pt.easeInQuad,cameraEasing:t.cameraEasing??Pt.easeInOutQuad},this.animationSystem=new Ye,this.cameraAnimationSystem=new Ze}animate(t,e){const r=[];if(t.length>0){const s=e?"enter-exit-move":"push-move",n=e?this.config.cameraDuration:this.config.movementDuration,o=e?this.config.cameraEasing:this.config.movementEasing;this.animationSystem.removeClip("push-move"),this.animationSystem.removeClip("enter-exit-move");const a=[];for(const c of t){let d=[c.oldPos[0]-c.newPos[0],c.oldPos[1]-c.newPos[1],c.oldPos[2]-c.newPos[2]];const u=c.isEnterExit&&c.visualScaleRatio!==void 0;c.isEnterExit&&c.parentScaleCompensation!==void 0&&(d=[d[0]*c.parentScaleCompensation,d[1]*c.parentScaleCompensation,d[2]*c.parentScaleCompensation]);const p=[{target:"position",interpolation:"linear",keyFrames:[{time:0,value:d,easing:o},{time:n,value:[0,0,0]}]}];if(u){const m=[c.visualScaleRatio,c.visualScaleRatio,c.visualScaleRatio],$=[1,1,1];p.push({target:"scale",interpolation:"linear",keyFrames:[{time:0,value:m,easing:o},{time:n,value:$}]})}a.push({nodeId:c.cellId,channels:p})}const l={id:s,duration:n,loop:!1,animations:a};this.animationSystem.addClip(l),this.animationSystem.play(s),r.push(s)}if(e){const s=this.animateCameraTransition(e.start,e.end);r.push(s)}return r}animateCameraTransition(t,e){const r="camera-transition",s=this.config.cameraDuration,n=t.position,o=[n[0]+t.viewWidth/2,n[1],n[2]],a=e.position,l=[a[0]+e.viewWidth/2,a[1],a[2]],c={id:r,duration:s,loop:!1,channels:[{target:"center",interpolation:"linear",keyFrames:[{time:0,value:n,easing:this.config.cameraEasing},{time:s,value:a}]},{target:"rightEdge",interpolation:"linear",keyFrames:[{time:0,value:o,easing:this.config.cameraEasing},{time:s,value:l}]}]};return this.cameraAnimationSystem.addClip(c),this.cameraAnimationSystem.play(r),r}start(t,e){if(this.animationFrameId!==null)return;this.frameCallback=t,this.completionCallback=e??null,this.lastFrameTime=performance.now();const r=s=>{const n=(s-this.lastFrameTime)/1e3;this.lastFrameTime=s,this.animationSystem.update(n),this.cameraAnimationSystem.update(n),this.frameCallback&&this.frameCallback(n);const o=this.animationSystem.getState().playing,a=this.cameraAnimationSystem.getState().playing;if(o||a)this.animationFrameId=requestAnimationFrame(r);else{this.animationFrameId=null;const l=this.frameCallback,c=this.completionCallback;this.frameCallback=null,this.completionCallback=null,this.animationSystem.removeClip("push-move"),this.animationSystem.removeClip("enter-exit-move"),this.cameraAnimationSystem.removeClip("camera-transition"),l&&l(0),c&&c()}};this.animationFrameId=requestAnimationFrame(r)}stop(){this.animationSystem.stop(),this.cameraAnimationSystem.stop(),this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.frameCallback=null}isAnimating(){return this.animationFrameId!==null}evaluateTransforms(){return this.animationSystem.evaluateTransforms()}evaluateCamera(t){return this.cameraAnimationSystem.evaluateCamera(t)}clear(){this.stop(),this.animationSystem.removeClip("push-move"),this.animationSystem.removeClip("enter-exit-move")}}const ar=.3,lr=.3,dt=1/64,Rt={exported:{main:"9 9 9 9 9 9 9 9|9 _ _ _ _ _ _ 9|9 _ 2 _ _ _ _ 9|9 _ _ _ _ *inner _ 9|9 _ _ _ _ _ _ _|9 _ _ 3 _ _ _ 9|9 ~inner _ _ 9 _ a 9|9 9 9 9 9 9 9 9",inner:"9 9 _ 9 9|9 _ _ _ 9|9 _ _ _ 9|9 _ _ _ 9|9 9 9 9 9",a:"_ main *b|1 9 _|_ ~b 9",b:"_ 4 _|_ _ _|_ _ 9"},swap:{main:"9 9 9 9 9 9 9 9|9 _ _ _ _ _ _ 9|9 _ _ 1 _ 2 _ 9|9 _ main _ _ *inner _ 9|9 _ _ _ _ _ _ _|9 _ _ _ _ _ _ 9|9 ~inner _ _ 9 _ _ 9|9 9 9 9 9 9 9 9",inner:"9 9 _ 9 9|9 _ _ _ 9|9 _ _ _ 9|9 _ _ _ 9|9 9 9 9 9"},swapEdited:{main:"9 9 9 9 9 9 9 9|9 _ _ _ _ _ _ 9|9 _ _ _ _ 2 _ 9|9 _ main _ _ *inner _ 1|9 _ _ _ _ _ _ _|9 _ _ _ _ _ a 9|9 ~inner _ _ 9 _ _ 9|9 9 9 9 9 9 9 9",inner:"9 9 _ 9 9|9 _ _ _ 9|9 _ _ _ 9|9 _ _ _ 9|9 9 9 9 9",a:"b _ _|_ _ _|_ 9 _",b:"_ _ _|_ _ _|_ 9 _"},indirectSelfRef:{main:"9 9 9 9 9 9 9 9|9 _ _ _ _ _ _ 9|9 _ 2 _ _ _ a 9|9 _ _ _ _ *inner _ 9|9 _ _ _ _ _ _ _|9 _ _ 3 _ _ _ 9|9 ~inner _ _ 9 _ _ 9|9 9 9 9 9 9 9 9",inner:"9 9 _ 9 9|9 _ _ _ 9|9 _ _ _ 9|9 _ _ _ 9|9 9 9 9 9",a:"_ main *b|_ 9 _|_ ~b 9",b:"_ 4 _|_ 1 _|_ _ 9"},simple5x5:{main:"9 9 _ 9 9|9 1 _ _ 9|_ _ inner _ _|9 _ _ _ 9|9 9 _ 9 9",inner:"9 9 _ 9 9|9 _ _ _ 9|_ _ _ _ _|9 _ _ _ 9|9 9 _ 9 9"},secondaryToSelfRef:{main:"9 9 _ 9 9|9 _ _ _ 9|_ _ _ 1 _|9 _ _ ~inner 9|9 9 _ 9 9",inner:"9 9 _ 9 9|9 _ _ _ 9|_ _ *inner _ _|9 _ _ _ 9|9 9 _ 9 9"},simple:{main:"1 _ _|_ 9 _|_ _ 2"},doubleExit:{main:"_ _ _|a 2 1|_ _ _",a:"b _ _|_ _ _|_ _ _",b:"_ _ _|_ _ _|_ _ _"},exitEnter:{main:"_ _ 9|_ a b|1 _ _",a:"_ b|_ _",b:"2 _|_ _"},tricky:{main:"9 9 9 9 9 9 9|9 _ _ _ _ _ 9|9 _ a _ b _ 9|9 _ _ _ _ _ 9|9 _ c _ 1 _ 9|9 _ _ _ _ _ 9|9 9 9 9 9 9 9",a:"_ 9 _|_ _ _|_ _ _",b:"9 9 9 9|9 9 _ _|9 9 9 9|9 9 9 9",c:"9 "+"_ ".repeat(10)+"9|"+"_ ".repeat(11)+"9|"+("9 "+"_ ".repeat(10)+"9|").repeat(9)+"9 "+"_ ".repeat(10)+"9"},transparency:{main:"_ _ _|_ a _|_ 2 _",a:"_ _ _|_ 1 _|_ _ _"},nonPrimaryRef:{main:"1 _ _|*a _ ~a|_ _ _",a:"9 _ 9|_ 3 _|9 _ 9"}},Yt="secondaryToSelfRef";function cr(){const i=new URLSearchParams(window.location.search);return{fullscreen:i.get("fullscreen")==="true",scene:i.get("scene")||Yt,hideControls:i.get("hideControls")==="true",hideHeader:i.get("hideHeader")==="true",mobile:i.get("mobile")==="true"}}class ur{store;originalStore;tagFn;playerTag="player";statusMessage="Ready. Use WASD to move.";isStatusError=!1;canvas;statusEl;currentScene=null;currentCellTree=null;currentCamera=null;currentRenderer=null;animator;previousPlayerPosition=null;renderWidth=800;renderHeight=600;allowRapidInput=!0;isFullscreen;resizeObserver=null;resizeTimeout=null;undoStack=[];redoStack=[];maxHistorySize=50;manualViewPath=null;manualViewInputEl=null;manualViewStatusEl=null;zoomSliderEl=null;zoomValueEl=null;zoomMultiplier=1;hierarchyHelper;cameraController;currentViewPath=null;cameraControllerSelectEl=null;trackObjectAnimations=!1;constructor(t,e,r,s,n=!1){this.store=t,this.originalStore=t,this.tagFn=e,this.canvas=r,this.statusEl=s,this.isFullscreen=n,this.animator=new or({movementDuration:ar,cameraDuration:lr}),this.updateDimensions(),this.hierarchyHelper=new ir(this.store),this.cameraController=new U(new Vt(this.hierarchyHelper),this.store),this.previousPlayerPosition=this.playerPosition??null;const o=this.playerPosition;if(o){const a=this.safeCallCamera(()=>this.cameraController.getStandardView(o.gridId),"initial view");a&&(this.currentViewPath=a.targetView)}this.setupKeyboardHandlers(),this.setupExportButton(),this.setupManualViewControls(),this.setupAnimationStatusPanel(),this.setupResizeHandler(),this.render()}get playerPosition(){return se(this.store,this.playerTag,this.tagFn)}updateDimensions(){if(this.isFullscreen){const t=this.canvas.getBoundingClientRect();this.renderWidth=t.width,this.renderHeight=t.height}else this.renderWidth=800,this.renderHeight=600}setupResizeHandler(){this.isFullscreen&&(this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.canvas),window.addEventListener("resize",()=>{this.handleResize()}))}handleResize(){this.resizeTimeout!==null&&window.clearTimeout(this.resizeTimeout),this.resizeTimeout=window.setTimeout(()=>{const t=this.renderWidth,e=this.renderHeight;this.updateDimensions(),(this.renderWidth!==t||this.renderHeight!==e)&&this.render(!0),this.resizeTimeout=null},100)}setupKeyboardHandlers(){document.addEventListener("keydown",t=>{const e=t.key.toLowerCase();if((t.ctrlKey||t.metaKey)&&e==="z"){t.preventDefault(),t.shiftKey?this.redo():this.undo();return}if((t.ctrlKey||t.metaKey)&&e==="y"){t.preventDefault(),this.redo();return}if(!(this.manualViewInputEl&&document.activeElement===this.manualViewInputEl))switch(["w","a","s","d","r"].includes(e)&&t.preventDefault(),e){case"w":this.attemptPush(k.N);break;case"s":this.attemptPush(k.S);break;case"a":this.attemptPush(k.W);break;case"d":this.attemptPush(k.E);break;case"r":this.reset();break}})}setupExportButton(){const t=document.getElementById("export-button"),e=document.getElementById("export-format-select"),r=document.getElementById("export-description");if(!t||!e||!r)return;const s=()=>{switch(e.value){case"grid-store":r.textContent="Logs grid definitions to console";break;case"scene-json":r.textContent="Logs scene to browser console";break;case"scene-svg":r.textContent="Downloads SVG file";break}};e.addEventListener("change",s),t.addEventListener("click",()=>{switch(e.value){case"grid-store":this.exportGridStore();break;case"scene-json":this.exportScene();break;case"scene-svg":this.exportSceneSVG();break}})}setupManualViewControls(){this.manualViewInputEl=document.getElementById("manual-view-input"),this.manualViewStatusEl=document.getElementById("manual-view-status"),this.zoomSliderEl=document.getElementById("zoom-slider"),this.zoomValueEl=document.getElementById("zoom-value"),this.cameraControllerSelectEl=document.getElementById("camera-controller-select"),this.cameraControllerSelectEl&&this.cameraControllerSelectEl.addEventListener("change",()=>{this.switchCameraController()}),this.manualViewInputEl&&(this.manualViewInputEl.addEventListener("input",()=>{this.updateManualView()}),this.manualViewInputEl.addEventListener("keydown",t=>{t.key==="Enter"&&this.updateManualView()}),this.zoomSliderEl&&(this.zoomSliderEl.addEventListener("input",()=>{this.updateZoom()}),this.zoomSliderEl.addEventListener("dblclick",()=>{this.zoomSliderEl.value="0",this.updateZoom()})))}setupAnimationStatusPanel(){const t=document.getElementById("animation-status-content");t&&setInterval(()=>{const e=this.animator.isAnimating(),r=this.animator.animationSystem.getState(),s=this.animator.cameraAnimationSystem.getState();if(!e&&!r.playing&&!s.playing){t.innerHTML='<span style="color: #666;">No animations active</span>';return}const n=[];if(r.playing){const o=Object.keys(this.animator.animationSystem.clips||{});n.push(`<span style="color: #4fc3f7;">Cell Animations:</span> ${o.join(", ")}`)}if(s.playing){const o=Object.keys(this.animator.cameraAnimationSystem.clips||{});n.push(`<span style="color: #4fc3f7;">Camera Animations:</span> ${o.join(", ")}`)}t.innerHTML=n.join("<br>")||'<span style="color: #666;">No animations active</span>'},100)}updateManualView(){if(!this.manualViewInputEl||!this.manualViewStatusEl)return;const t=this.manualViewInputEl.value.trim();if(t===""){this.manualViewPath=null,this.manualViewStatusEl.textContent="Enter grid path to override camera (empty = auto)",this.manualViewStatusEl.className="manual-view-status",this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0);return}const e=this.parseManualViewInput(t);e.success?(this.manualViewPath=e.path,this.manualViewStatusEl.textContent=` View: ${e.path.join("  ")}`,this.manualViewStatusEl.className="manual-view-status active",this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0)):(this.manualViewPath=null,this.manualViewStatusEl.textContent=` ${e.error}`,this.manualViewStatusEl.className="manual-view-status error")}safeCallCamera(t,e){try{return t()}catch(r){const s=r instanceof Error?r.message:String(r);return this.statusMessage=` Camera error (${e}): ${s}`,this.isStatusError=!0,console.error(`Camera validation error in ${e}:`,r),null}}parseManualViewInput(t){const e=t.toLowerCase().split("."),r=[],s=Object.keys(this.store);for(const o of e){if(o.length===0)return{success:!1,error:"Empty segment in path"};const a=s.filter(l=>l.toLowerCase().startsWith(o.toLowerCase()));if(a.length===0)return{success:!1,error:`No grid found starting with '${o}'`};if(a.length>1)return{success:!1,error:`Ambiguous: '${o}' matches ${a.join(", ")}`};r.push(a[0])}return H(this.store,r)?{success:!0,path:r}:{success:!1,error:"Invalid path: grids don't reference each other correctly"}}updateZoom(){if(!this.zoomSliderEl||!this.zoomValueEl)return;const t=parseFloat(this.zoomSliderEl.value);this.zoomMultiplier=Math.pow(2,t),this.zoomValueEl.textContent=`${this.zoomMultiplier.toFixed(2)}`,this.animator.isAnimating()&&this.cancelCurrentAnimation(),this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0)}switchCameraController(){if(!this.cameraControllerSelectEl)return;this.cameraControllerSelectEl.value==="animated"?this.cameraController=new U(new Vt(this.hierarchyHelper),this.store):this.cameraController=new U(new nr(this.hierarchyHelper),this.store);const e=this.playerPosition;if(e){const r=this.safeCallCamera(()=>this.cameraController.getStandardView(e.gridId),"camera switch");r&&(this.currentViewPath=r.targetView)}this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0)}exportScene(){if(!this.currentScene){console.warn("No scene available to export");return}const t=he(this.currentScene);console.log("Scene JSON:"),console.log(t)}exportSceneSVG(){if(!this.currentRenderer){console.warn("No renderer available to export SVG");return}const t=this.canvas.querySelector("svg");if(!t){console.warn("No SVG element found in canvas");return}const r=new XMLSerializer().serializeToString(t),s=new Blob([r],{type:"image/svg+xml"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download="paragrid-scene.svg",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log("SVG exported successfully")}exportGridStore(){const t=te(this.store);console.log("Grid Store Export:"),console.log(JSON.stringify(t,null,2)),console.log(`
Parseable format for use with parseGrids():`),console.log(t)}attemptPush(t){if(this.animator.isAnimating())if(this.allowRapidInput)this.cancelCurrentAnimation();else return;const e=this.playerPosition;if(!e){this.statusMessage=" Error: No player found!",this.isStatusError=!0,this.render();return}const r=ne(this.store,e,t,ie(),this.tagFn);if(this.isPushFailure(r)){this.statusMessage=` Push ${t} failed: ${r.reason}`,this.isStatusError=!0,r.details&&(this.statusMessage+=` (${r.details})`),this.render(!0),this.updateStatus();return}this.undoStack.push(this.store),this.undoStack.length>this.maxHistorySize&&this.undoStack.shift(),this.redoStack=[],this.store=r.store,this.hierarchyHelper.setStore(this.store),this.cameraController instanceof U&&this.cameraController.setStore(this.store);const s=r.chain,n=this.playerPosition;if(n){if(this.previousPlayerPosition=n,this.statusMessage=` Pushed ${t}! Player at [${n.row}, ${n.col}]`,this.isStatusError=!1,this.manualViewPath){const l=ut(this.store,s,this.hierarchyHelper);l.length>0?this.createMultipleMovementAnimations(l):this.render(!0);return}let o=null;if(s.length>1)if(s[1].transition==="enter"){const l=s[1].viaNonPrimaryReference??!1;o=this.safeCallCamera(()=>this.cameraController.onPlayerEnter(e.gridId,n.gridId,l),"player enter")}else s[1].transition==="exit"&&(o=this.safeCallCamera(()=>this.cameraController.onPlayerExit(e.gridId,n.gridId),"player exit"));if(o){const l=this.currentViewPath,c=o.targetView;this.currentViewPath=c,this.trackObjectAnimations=o.trackObjectAnimations??!1;const d=ut(this.store,s,this.hierarchyHelper);o.animationStartView&&l?this.createAnimationWithCamera(d,o.animationStartView,o.targetView):(this.animator.stop(),this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0));return}if(o=this.safeCallCamera(()=>this.cameraController.onPlayerMove(e.gridId),"player move"),o){const l=o.targetView;this.currentViewPath=l,this.trackObjectAnimations=o.trackObjectAnimations??!1}const a=ut(this.store,s,this.hierarchyHelper);a.length>0?this.createMultipleMovementAnimations(a):this.render(!0)}else this.statusMessage=" Push succeeded but player lost!",this.isStatusError=!1,this.render(!0)}isPushFailure(t){return"reason"in t&&"position"in t}cancelCurrentAnimation(){this.animator.stop(),this.animator.clear(),this.render(!0)}reset(){if(this.store=this.originalStore,this.hierarchyHelper.setStore(this.store),this.cameraController instanceof U&&this.cameraController.setStore(this.store),this.statusMessage="Grid reset to original state",this.isStatusError=!1,this.previousPlayerPosition=this.playerPosition??null,!this.manualViewPath){const t=this.playerPosition;if(t){const e=this.safeCallCamera(()=>this.cameraController.getStandardView(t.gridId),"reset");e&&(this.currentViewPath=e.targetView)}}this.cancelCurrentAnimation(),this.undoStack=[],this.redoStack=[],this.render()}undo(){if(this.undoStack.length===0){this.statusMessage=" Nothing to undo",this.isStatusError=!1,this.updateStatus();return}this.cancelCurrentAnimation(),this.redoStack.push(this.store);const t=this.undoStack.pop();if(this.store=t,this.hierarchyHelper.setStore(this.store),this.cameraController instanceof U&&this.cameraController.setStore(this.store),this.previousPlayerPosition=this.playerPosition??null,!this.manualViewPath){const e=this.playerPosition;if(e){const r=this.safeCallCamera(()=>this.cameraController.getStandardView(e.gridId),"undo");r&&(this.currentViewPath=r.targetView)}}this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.statusMessage=" Undo successful",this.isStatusError=!1,this.render(!0)}redo(){if(this.redoStack.length===0){this.statusMessage=" Nothing to redo",this.isStatusError=!1,this.updateStatus();return}this.cancelCurrentAnimation(),this.undoStack.push(this.store),this.undoStack.length>this.maxHistorySize&&this.undoStack.shift();const t=this.redoStack.pop();if(this.store=t,this.hierarchyHelper.setStore(this.store),this.cameraController instanceof U&&this.cameraController.setStore(this.store),this.previousPlayerPosition=this.playerPosition??null,!this.manualViewPath){const e=this.playerPosition;if(e){const r=this.safeCallCamera(()=>this.cameraController.getStandardView(e.gridId),"redo");r&&(this.currentViewPath=r.targetView)}}this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.statusMessage=" Redo successful",this.isStatusError=!1,this.render(!0)}createMultipleMovementAnimations(t){if(t.length===0)return;this.rebuildSceneData();let e;if(this.trackObjectAnimations&&this.currentViewPath&&this.currentViewPath.length>0){const r=this.currentViewPath[this.currentViewPath.length-1],s=t.find(n=>n.cellId.startsWith(`ref-${r}-`));if(s){const n=H(this.store,this.currentViewPath);if(n){const o=V(this.store,this.currentViewPath[0]);if(o){const a=n.centerX-o.cols/2,l=n.centerY-o.rows/2,d=Math.sqrt(n.width**2+n.height**2)*this.zoomMultiplier,u=[s.oldPos[0]-s.newPos[0],s.oldPos[1]-s.newPos[1],s.oldPos[2]-s.newPos[2]];e={start:{position:[a+u[0],u[1],l+u[2]],viewWidth:d},end:{position:[a,0,l],viewWidth:d}}}}}}this.animator.animate(t,e),this.startAnimationLoop()}startAnimationLoop(t){this.animator.start(()=>{this.render(!1)},t)}createAnimationWithCamera(t,e,r){let s=Mt(this.store,e,this.zoomMultiplier);const n=Mt(this.store,r,this.zoomMultiplier);if(!s||!n){console.warn("Failed to calculate camera positions for animation, falling back to instant transition"),this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0);return}const o=r[r.length-1],a=t.find(p=>p.cellId.startsWith(`ref-${o}-`));if(a){const p=[a.oldPos[0]-a.newPos[0],a.oldPos[1]-a.newPos[1],a.oldPos[2]-a.newPos[2]];s={position:[s.position[0]+p[0],s.position[1]+p[1],s.position[2]+p[2]],viewWidth:s.viewWidth}}if(this.animator.stop(),this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,!this.playerPosition)return;const c=r[0],d=V(this.store,c);if(!d)return;this.currentCellTree=Q(this.store,c,d.cols,d.rows,dt,new Set,r);const u=ct(this.currentCellTree,{width:this.renderWidth,height:this.renderHeight,store:this.store,tagFn:this.tagFn});this.currentScene=u.scene;const h=tt(n.position,n.viewWidth,this.renderWidth,this.renderHeight);this.currentCamera=h,this.currentRenderer||(this.canvas.innerHTML="",this.currentRenderer=new lt({target:this.canvas,backend:"svg",width:this.renderWidth,height:this.renderHeight})),this.animator.animate(t,{start:s,end:n}),this.render(!1),this.startAnimationLoop(()=>{this.transitionToStandardView(r)})}transitionToStandardView(t){if(this.manualViewPath)return;const e=this.playerPosition;if(!e)return;const r=this.safeCallCamera(()=>this.cameraController.getStandardView(e.gridId),"get standard view");if(!r)return;const s=r.targetView;this.viewPathsEqual(t,s)||(this.currentViewPath=s,this.currentScene=null,this.currentCellTree=null,this.currentRenderer=null,this.render(!0))}viewPathsEqual(t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}rebuildSceneData(){if(!this.playerPosition)return;const e=this.manualViewPath??this.currentViewPath;if(!e||e.length===0){console.error("No view path available for rebuild");return}const r=e[0],s=V(this.store,r);if(!s){console.error(`Rebuild: Grid '${r}' not found`);return}const n=H(this.store,e);if(!n){console.error(`Rebuild: Invalid path ${e.join("  ")}`);return}const o=n.centerX-s.cols/2,a=n.centerY-s.rows/2,c=Math.sqrt(n.width**2+n.height**2)*this.zoomMultiplier;this.currentCellTree=Q(this.store,r,s.cols,s.rows,dt,new Set,e);const d=ct(this.currentCellTree,{width:this.renderWidth,height:this.renderHeight,store:this.store,tagFn:this.tagFn});this.currentScene=d.scene,this.currentCamera=tt([o,0,a],c,this.renderWidth,this.renderHeight),this.currentRenderer||(this.currentRenderer=new lt({target:this.canvas,backend:"svg",width:this.renderWidth,height:this.renderHeight}))}render(t=!1){if(!this.playerPosition){this.canvas.innerHTML='<div style="color: red; padding: 20px;">Error: No player cell found!</div>',this.updateStatus();return}let r;try{if(t||!this.currentScene||!this.currentCellTree||!this.currentRenderer){this.canvas.innerHTML="",this.currentRenderer=null;const s=this.manualViewPath??this.currentViewPath;if(!s||s.length===0)throw new Error("No view path available");const n=s[0],o=V(this.store,n);if(!o)throw new Error(`View path: Grid '${n}' not found`);const a=H(this.store,s);if(!a)throw new Error(`View path: Invalid path ${s.join("  ")}`);const l=a.centerX-o.cols/2,c=a.centerY-o.rows/2,u=Math.sqrt(a.width**2+a.height**2)*this.zoomMultiplier;this.currentCellTree=Q(this.store,n,o.cols,o.rows,dt,new Set,s);const h=ct(this.currentCellTree,{width:this.renderWidth,height:this.renderHeight,store:this.store,tagFn:this.tagFn});this.currentScene=h.scene,this.currentCamera=tt([l,0,c],u,this.renderWidth,this.renderHeight),this.currentRenderer=new lt({target:this.canvas,backend:"svg",width:this.renderWidth,height:this.renderHeight});let p=this.animator.evaluateCamera(this.currentCamera);r=It(this.currentScene,p,this.renderWidth,this.renderHeight)}else{const s=this.animator.evaluateTransforms(),n=this.animator.evaluateCamera(this.currentCamera);r=It(this.currentScene,n,this.renderWidth,this.renderHeight,{transformOverrides:s})}this.currentRenderer.render(r,{layers:s=>s>=1?{opacity:.5}:{opacity:1}})}catch(s){console.error("Render error:",s),this.canvas.innerHTML=`<div style="color: red; padding: 20px;">Render error: ${s}</div>`}this.updateStatus()}updateStatus(){const t=this.playerPosition;let r=`
      <div class="status-line"${this.isStatusError?' style="color: #ff4444; font-weight: bold;"':""}><strong>Status:</strong> ${this.statusMessage}</div>
    `;if(t){r+=`
        <div class="status-line"><strong>Player Position:</strong> ${t.gridId}[${t.row}, ${t.col}]</div>
      `;const n=V(this.store,t.gridId)?.cells[t.row]?.[t.col];n&&nt(n)&&(r+=`
          <div class="status-line"><strong>Cell:</strong> Concrete(${n.id})</div>
        `);const o=this.manualViewPath??this.currentViewPath;o&&o.length>0&&(r+=`
          <div class="status-line"><strong>View Path:</strong> ${o.join("  ")}</div>
        `)}r+=`
      <div class="controls">
        <strong>Controls:</strong><br>
        <span class="key">W/A/S/D</span> - Move (Push)<br>
        <span class="key">R</span> - Reset<br>
        <span class="key">Ctrl+Z</span> - Undo (${this.undoStack.length} available)<br>
        <span class="key">Ctrl+Shift+Z</span> or <span class="key">Ctrl+Y</span> - Redo (${this.redoStack.length} available)<br>
        <strong style="margin-top: 0.5rem; display: inline-block;">Export:</strong><br>
        See buttons below for scene JSON and SVG
      </div>
    `,this.statusEl.innerHTML=r}}function dr(i){const t=document.querySelector(".container"),e=document.querySelector("h1"),r=document.querySelector(".description"),s=document.getElementById("manual-view"),n=document.getElementById("animation-status"),o=document.getElementById("status"),a=document.querySelector(".container > div:last-child"),l=document.getElementById("canvas"),c=document.querySelector(".demo-area");i.fullscreen&&(document.body.style.padding="0",document.body.style.margin="0",document.body.style.overflow="hidden",t&&(t.style.maxWidth="100%",t.style.width="100vw",t.style.height="100vh",t.style.display="flex",t.style.flexDirection="column",t.style.padding="0"),l&&(l.style.width="100%",l.style.height="100%",l.style.maxWidth="none",l.style.maxHeight="none",l.style.flex="1",l.style.minHeight="0"),c&&(c.style.flex="1",c.style.marginTop="0",c.style.width="100%",c.style.minHeight="0",c.style.display="flex",c.style.gap="0")),i.hideHeader&&(e&&(e.style.display="none"),r&&(r.style.display="none")),i.hideControls&&(s&&(s.style.display="none"),n&&(n.style.display="none"),o&&(o.style.display="none"),a&&(a.style.display="none")),i.fullscreen&&fr()}function hr(i){const t="80px",e="1rem",r=`
    width: ${t};
    height: ${t};
    background: rgba(79, 195, 247, 0.8);
    color: #1a1a1a;
    border: 2px solid rgba(79, 195, 247, 1);
    border-radius: 12px;
    font-size: 2rem;
    cursor: pointer;
    z-index: 900;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  `,s=[{id:"mobile-north",direction:k.N,arrow:"",label:"N"},{id:"mobile-south",direction:k.S,arrow:"",label:"S"},{id:"mobile-west",direction:k.W,arrow:"",label:"W"},{id:"mobile-east",direction:k.E,arrow:"",label:"E"}],n=document.createElement("div");n.id="mobile-controls",s.forEach(({id:a,direction:l,arrow:c,label:d})=>{const u=document.createElement("button");u.id=a,u.innerHTML=c,u.setAttribute("aria-label",`Move ${d}`),u.style.cssText=r+"position: fixed;";const h=p=>{p.preventDefault(),i.attemptPush(l)};u.addEventListener("touchstart",h),u.addEventListener("click",h),u.addEventListener("mouseenter",()=>{u.style.background="rgba(129, 212, 250, 0.9)",u.style.transform="scale(1.05)"}),u.addEventListener("mouseleave",()=>{u.style.background="rgba(79, 195, 247, 0.8)",u.style.transform="scale(1)"}),u.addEventListener("touchstart",()=>{u.style.background="rgba(41, 182, 246, 0.9)",u.style.transform="scale(0.95)"}),u.addEventListener("touchend",()=>{u.style.background="rgba(79, 195, 247, 0.8)",u.style.transform="scale(1)"}),n.appendChild(u)}),document.body.appendChild(n),o(),window.addEventListener("resize",o);function o(){const a=document.getElementById("mobile-north"),l=document.getElementById("mobile-south"),c=document.getElementById("mobile-west"),d=document.getElementById("mobile-east");if(window.innerWidth<768)c.style.bottom=e,c.style.left=e,c.style.top="auto",c.style.right="auto",l.style.bottom=e,l.style.right=e,l.style.top="auto",l.style.left="auto",a.style.top=e,a.style.left=e,a.style.bottom="auto",a.style.right="auto",d.style.top=e,d.style.right=e,d.style.bottom="auto",d.style.left="auto";else{const h="0.5rem";c.style.bottom=e,c.style.left=e,c.style.top="auto",c.style.right="auto",d.style.bottom=e,d.style.left=`calc(${e} + ${t} + ${h})`,d.style.top="auto",d.style.right="auto",a.style.bottom=`calc(${e} + ${t} + ${h})`,a.style.left=e,a.style.top="auto",a.style.right="auto",l.style.bottom=`calc(${e} + ${t} + ${h})`,l.style.left=`calc(${e} + ${t} + ${h})`,l.style.top="auto",l.style.right="auto"}}}function fr(i){const t=document.createElement("button");t.id="burger-menu",t.innerHTML="",t.style.cssText=`
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 3rem;
    height: 3rem;
    background: #4fc3f7;
    color: #1a1a1a;
    border: none;
    border-radius: 8px;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 1000;
    transition: background 0.2s;
  `,t.onmouseenter=()=>t.style.background="#81d4fa",t.onmouseleave=()=>t.style.background="#4fc3f7";const e=document.createElement("div");e.id="settings-modal",e.style.cssText=`
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 999;
    align-items: center;
    justify-content: center;
  `;const r=document.createElement("div");r.id="modal-content",r.style.cssText=`
    background: #2a2a2a;
    border: 2px solid #444;
    border-radius: 8px;
    padding: 2rem;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    color: #e0e0e0;
  `;const s=document.createElement("button");s.textContent="Close",s.className="export-button",s.style.marginTop="1rem",s.onclick=()=>e.style.display="none",e.appendChild(r),document.body.appendChild(t),document.body.appendChild(e);const n=()=>{r.innerHTML="";const o=document.getElementById("manual-view"),a=document.getElementById("animation-status"),l=document.getElementById("status"),c=document.querySelector(".container > div:last-child");if(o){const d=o.cloneNode(!0);d.style.display="block",r.appendChild(d)}if(a){const d=a.cloneNode(!0);d.style.display="block",r.appendChild(d)}if(l){const d=l.cloneNode(!0);d.style.marginBottom="1rem",d.style.display="block",r.appendChild(d)}if(c){const d=c.cloneNode(!0);d.style.display="block",r.appendChild(d)}r.appendChild(s)};t.onclick=()=>{e.style.display==="flex"?e.style.display="none":(n(),e.style.display="flex")},e.onclick=o=>{o.target===e&&(e.style.display="none")}}document.addEventListener("DOMContentLoaded",()=>{const i=cr(),t=Rt[i.scene]||Rt[Yt],e=Jt(t),r=a=>{if(nt(a)){if(a.id==="1")return new Set(["player"]);if(a.id==="9")return new Set(["stop"])}return new Set},s=document.getElementById("canvas"),n=document.getElementById("status");if(!s||!n){console.error("Required elements not found!");return}dr(i);const o=new ur(e,r,s,n,i.fullscreen);i.mobile&&hr(o)});</script>
  </head>
  <body>
    <div class="container">
      <h1>Paragrid Isometric Demo</h1>
      <div class="description">
        Navigate a 44 grid using WASD keys. The lemon octahedron is your player.
      </div>

      <div class="demo-area">
        <div id="canvas"></div>
        <div>
          <div id="manual-view" style="background: #2a2a2a; border: 2px solid #444; border-radius: 8px; padding: 1.5rem; min-width: 300px; flex-shrink: 0; margin-bottom: 1rem;">
            <div class="manual-view-control">
              <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #555;">
                <strong>Camera Controller</strong>
                <select
                  id="camera-controller-select"
                  class="manual-view-input"
                  style="cursor: pointer; margin-top: 0.5rem;"
                >
                  <option value="parent">Parent View (No Animation)</option>
                  <option value="animated" selected>Animated Parent View</option>
                </select>
              </div>
              <strong>Manual View (Dev Tool)</strong>
              <input
                type="text"
                id="manual-view-input"
                class="manual-view-input"
                placeholder="e.g., m.i for main.inner"
                autocomplete="off"
                spellcheck="false"
              />
              <div id="manual-view-status" class="manual-view-status">
                Enter grid path to override camera (empty = auto)
              </div>
              <div class="zoom-control">
                <strong>Zoom: <span id="zoom-value" class="zoom-value">1.0</span></strong>
                <input
                  type="range"
                  id="zoom-slider"
                  class="zoom-slider"
                  min="-3"
                  max="3"
                  step="0.1"
                  value="0"
                />
              </div>
            </div>
          </div>
          <div id="animation-status" style="background: #2a2a2a; border: 2px solid #444; border-radius: 8px; padding: 1.5rem; min-width: 300px; flex-shrink: 0; margin-bottom: 1rem;">
            <strong>Animation Status</strong>
            <div id="animation-status-content" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.85rem; color: #aaa;">
              No animations active
            </div>
          </div>
          <div id="status">
            Loading...
          </div>
        </div>
      </div>

      <div style="margin-top: 2rem; max-width: 300px; margin-left: auto; margin-right: 0;">
        <strong>Export</strong>
        <select
          id="export-format-select"
          class="manual-view-input"
          style="cursor: pointer; margin-top: 0.5rem;"
        >
          <option value="grid-store">Grid Store (console)</option>
          <option value="scene-json">Scene JSON (console)</option>
          <option value="scene-svg">Scene SVG (download)</option>
        </select>
        <button id="export-button" class="export-button" style="margin-top: 0.5rem;">Export</button>
        <p id="export-description" style="color: #aaa; font-size: 0.85rem; margin-top: 0.5rem; text-align: center;">
          Logs grid definitions to console
        </p>
      </div>
    </div>

  </body>
</html>

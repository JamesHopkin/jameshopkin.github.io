(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(e){if(e.ep)return;e.ep=!0;const s=n(e);fetch(e.href,s)}})();function pe(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function ge(a){if(Object.prototype.hasOwnProperty.call(a,"__esModule"))return a;var t=a.default;if(typeof t=="function"){var n=function r(){var e=!1;try{e=this instanceof r}catch{}return e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(a).forEach(function(r){var e=Object.getOwnPropertyDescriptor(a,r);Object.defineProperty(n,r,e.get?e:{enumerable:!0,get:function(){return a[r]}})}),n}var B={exports:{}},q={exports:{}},F,K;function ye(){if(K)return F;K=1;function a(n){return n>64&&n<91?n-65:n>96&&n<123?n-71:n>47&&n<58?n+4:n===43?62:n===47?63:0}function t(n,r){for(var e=n.replace(/[^A-Za-z0-9\+\/]/g,""),s=e.length,l=r?Math.ceil((s*3+1>>2)/r)*r:s*3+1>>2,o=new Uint8Array(l),i,u,d=0,c=0,m=0;m<s;m++)if(u=m&3,d|=a(e.charCodeAt(m))<<18-6*u,u===3||s-m===1){for(i=0;i<3&&c<l;i++,c++)o[c]=d>>>(16>>>i&24)&255;d=0}return o}return F={decode:t},F}var O,Y;function be(){return Y||(Y=1,O=function(a,t){return new Promise(function(n,r){var e=new XMLHttpRequest;t&&(e.responseType=t),e.open("GET",a),e.onload=function(){e.status===200?n(e.response):r(Error(e.statusText))},e.onerror=function(){r(Error("Network Error"))},e.send()})}),O}var W;function Te(){return W||(W=1,(function(a){var t=ye(),n=be();function r(h){return function(f){return typeof f=="string"&&h.test(f)}}function e(h,f){return typeof h=="string"?h+f:typeof h=="function"?h(f):f}function s(h,f,T,A){var P=l(f)?o:i(f)?u:d(f)?c:m(f)?g:w(f)?b:v(f)?x:L(f)?E:p(f)?N:null,C=T||{};return P?P(h,f,C):A?Promise.resolve(A):Promise.reject("Source not valid ("+f+")")}s.fetch=n;function l(h){return h instanceof ArrayBuffer}function o(h,f,T){return new Promise(function(A,P){h.decodeAudioData(f,function(C){A(C)},function(){P("Can't decode audio data ("+f.slice(0,30)+"...)")})})}var i=r(/\.(mp3|wav|ogg)(\?.*)?$/i);function u(h,f,T){var A=e(T.from,f);return s(h,s.fetch(A,"arraybuffer"),T)}function d(h){return h&&typeof h.then=="function"}function c(h,f,T){return f.then(function(A){return s(h,A,T)})}var m=Array.isArray;function g(h,f,T){return Promise.all(f.map(function(A){return s(h,A,T,A)}))}function w(h){return h&&typeof h=="object"}function b(h,f,T){var A={},P=Object.keys(f).map(function(C){if(T.only&&T.only.indexOf(C)===-1)return null;var J=f[C];return s(h,J,T,J).then(function(ve){A[C]=ve})});return Promise.all(P).then(function(){return A})}var v=r(/\.json(\?.*)?$/i);function x(h,f,T){var A=e(T.from,f);return s(h,s.fetch(A,"text").then(JSON.parse),T)}var L=r(/^data:audio/);function E(h,f,T){var A=f.indexOf(",");return s(h,t.decode(f.slice(A+1)).buffer,T)}var p=r(/\.js(\?.*)?$/i);function N(h,f,T){var A=e(T.from,f);return s(h,s.fetch(A,"text").then(y),T)}function y(h){var f=h.indexOf("MIDI.Soundfont.");if(f<0)throw Error("Invalid MIDI.js Soundfont format");f=h.indexOf("=",f)+2;var T=h.lastIndexOf(",");return JSON.parse(h.slice(f,T)+"}")}a.exports&&(a.exports=s),typeof window<"u"&&(window.loadAudio=s)})(q)),q.exports}var j={exports:{}},R,Z;function we(){if(Z)return R;Z=1,R=a;function a(o){var i=o.createGain(),u=i._voltage=r(o),d=e(u),c=e(u),m=e(u);return i._startAmount=e(c),i._endAmount=e(m),i._multiplier=e(d),i._multiplier.connect(i),i._startAmount.connect(i),i._endAmount.connect(i),i.value=d.gain,i.startValue=c.gain,i.endValue=m.gain,i.startValue.value=0,i.endValue.value=0,Object.defineProperties(i,t),i}var t={attack:{value:0,writable:!0},decay:{value:0,writable:!0},sustain:{value:1,writable:!0},release:{value:0,writable:!0},getReleaseDuration:{value:function(){return this.release}},start:{value:function(o){var i=this._multiplier.gain,u=this._startAmount.gain,d=this._endAmount.gain;this._voltage.start(o),this._decayFrom=this._decayFrom=o+this.attack,this._startedAt=o;var c=this.sustain;i.cancelScheduledValues(o),u.cancelScheduledValues(o),d.cancelScheduledValues(o),d.setValueAtTime(0,o),this.attack?(i.setValueAtTime(0,o),i.linearRampToValueAtTime(1,o+this.attack),u.setValueAtTime(1,o),u.linearRampToValueAtTime(0,o+this.attack)):(i.setValueAtTime(1,o),u.setValueAtTime(0,o)),this.decay&&i.setTargetAtTime(c,this._decayFrom,s(this.decay))}},stop:{value:function(o,i){i&&(o=o-this.release);var u=o+this.release;if(this.release){var d=this._multiplier.gain,c=this._startAmount.gain,m=this._endAmount.gain;d.cancelScheduledValues(o),c.cancelScheduledValues(o),m.cancelScheduledValues(o);var g=s(this.release);if(this.attack&&o<this._decayFrom){var w=l(0,1,this._startedAt,this._decayFrom,o);d.linearRampToValueAtTime(w,o),c.linearRampToValueAtTime(1-w,o),c.setTargetAtTime(0,o,g)}m.setTargetAtTime(1,o,g),d.setTargetAtTime(0,o,g)}return this._voltage.stop(u),u}},onended:{get:function(){return this._voltage.onended},set:function(o){this._voltage.onended=o}}},n=new Float32Array([1,1]);function r(o){var i=o.createBufferSource(),u=o.createBuffer(1,2,o.sampleRate);return u.getChannelData(0).set(n),i.buffer=u,i.loop=!0,i}function e(o){var i=o.context.createGain();return o.connect(i),i}function s(o){return Math.log(o+1)/Math.log(100)}function l(o,i,u,d,c){var m=i-o,g=d-u,w=c-u,b=w/g,v=o+b*m;return v<=o&&(v=o),v>=i&&(v=i),v}return R}var D,Q;function Ee(){if(Q)return D;Q=1;var a=we(),t={},n={gain:1,attack:.01,decay:.1,sustain:.9,release:.3,loop:!1,cents:0,loopStart:0,loopEnd:0};function r(i,u,d){var c=!1,m=0,g={},w=i.createGain();w.gain.value=1;var b=Object.assign({},n,d),v={context:i,out:w,opts:b};return u instanceof AudioBuffer?v.buffer=u:v.buffers=u,v.start=function(E,p,N){if(v.buffer&&E!==null)return v.start(null,E,p);var y=E?v.buffers[E]:v.buffer;if(y){if(!c){console.warn("SamplePlayer not connected to any node.");return}}else{console.warn("Buffer "+E+" not found.");return}var h=N||t;p=Math.max(i.currentTime,p||0),v.emit("start",p,E,h);var f=L(E,y,h);return f.id=x(E,f),f.env.start(p),f.source.start(p),v.emit("started",p,f.id,f),h.duration&&f.stop(p+h.duration),f},v.play=function(E,p,N){return v.start(E,p,N)},v.stop=function(E,p){var N;return p=p||Object.keys(g),p.map(function(y){return N=g[y],N?(N.stop(E),N.id):null})},v.connect=function(E){return c=!0,w.connect(E),v},v.emit=function(E,p,N,y){v.onevent&&v.onevent(E,p,N,y);var h=v["on"+E];h&&h(p,N,y)},v;function x(E,p){return p.id=m++,g[p.id]=p,p.source.onended=function(){var N=i.currentTime;p.source.disconnect(),p.env.disconnect(),p.disconnect(),v.emit("ended",N,p.id,p)},p.id}function L(E,p,N){var y=i.createGain();return y.gain.value=0,y.connect(w),y.env=l(i,N,b),y.env.connect(y.gain),y.source=i.createBufferSource(),y.source.buffer=p,y.source.connect(y),y.source.loop=N.loop||b.loop,y.source.playbackRate.value=o(N.cents||b.cents),y.source.loopStart=N.loopStart||b.loopStart,y.source.loopEnd=N.loopEnd||b.loopEnd,y.stop=function(h){var f=h||i.currentTime;v.emit("stop",f,E);var T=y.env.stop(f);y.source.stop(T)},y}}function e(i){return typeof i=="number"}var s=["attack","decay","sustain","release"];function l(i,u,d){var c=a(i),m=u.adsr||d.adsr;return s.forEach(function(g,w){m?c[g]=m[w]:c[g]=u[g]||d[g]}),c.value.value=e(u.gain)?u.gain:e(d.gain)?d.gain:1,c}function o(i){return i?Math.pow(2,i/1200):1}return D=r,D}var I,ee;function Ne(){if(ee)return I;ee=1,I=function(t){return t.on=function(n,r){if(arguments.length===1&&typeof n=="function")return t.on("event",n);var e="on"+n,s=t[e];return t[e]=s?a(s,r):r,t},t};function a(t,n){return function(r,e,s,l){t(r,e,s,l),n(r,e,s,l)}}return I}var k,te;function Ae(){if(te)return k;te=1;var a=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function t(){return a}var n=[0,2,4,5,7,9,11];function r(o,i,u){if(typeof o!="string")return null;var d=a.exec(o);if(!d||!i&&d[4])return null;var c={letter:d[1].toUpperCase(),acc:d[2].replace(/x/g,"##")};return c.pc=c.letter+c.acc,c.step=(c.letter.charCodeAt(0)+3)%7,c.alt=c.acc[0]==="b"?-c.acc.length:c.acc.length,c.chroma=n[c.step]+c.alt,d[3]&&(c.oct=+d[3],c.midi=c.chroma+12*(c.oct+1),c.freq=e(c.midi,u)),i&&(c.tonicOf=d[4]),c}function e(o,i){return Math.pow(2,(o-69)/12)*(i||440)}var s={parse:r,regex:t,midiToFreq:e},l=["letter","acc","pc","step","alt","chroma","oct","midi","freq"];return l.forEach(function(o){s[o]=function(i){var u=r(i);return u&&typeof u[o]<"u"?u[o]:null}}),k=s,k}var H,ne;function Me(){if(ne)return H;ne=1;var a=Ae(),t=function(e){return e!==null&&e!==[]&&e>=0&&e<129},n=function(e){return t(e)?+e:a.midi(e)};H=function(e){if(e.buffers){var s=e.opts.map,l=typeof s=="function"?s:n,o=function(u){return u?l(u)||u:null};e.buffers=r(e.buffers,o);var i=e.start;e.start=function(u,d,c){var m=o(u),g=m%1;return g&&(m=Math.floor(m),c=Object.assign(c||{},{cents:Math.floor(g*100)})),i(m,d,c)}}return e};function r(e,s){return Object.keys(e).reduce(function(l,o){return l[s(o)]=e[o],l},{})}return H}var $,re;function Ce(){if(re)return $;re=1;var a=Array.isArray,t=function(r){return r&&typeof r=="object"},n={};return $=function(r){return r.schedule=function(e,s){var l=r.context.currentTime,o=e<l?l:e;r.emit("schedule",o,s);var i,u,d,c;return s.map(function(m){if(m)a(m)?(i=m[0],u=m[1]):(i=m.time,u=m);else return null;return t(u)?(d=u.name||u.key||u.note||u.midi||null,c=u):(d=u,c=n),r.start(d,o+(i||0),c)})},r},$}function S(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var G={exports:{}},oe;function _e(){return oe||(oe=1,(function(a,t){(function(n){a.exports=n()})(function(){return(function n(r,e,s){function l(u,d){if(!e[u]){if(!r[u]){var c=typeof S=="function"&&S;if(!d&&c)return c(u,!0);if(o)return o(u,!0);var m=new Error("Cannot find module '"+u+"'");throw m.code="MODULE_NOT_FOUND",m}var g=e[u]={exports:{}};r[u][0].call(g.exports,function(w){var b=r[u][1][w];return l(b||w)},g,g.exports,n,r,e,s)}return e[u].exports}for(var o=typeof S=="function"&&S,i=0;i<s.length;i++)l(s[i]);return l})({1:[function(n,r,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(s){function l(o){if(this._event=o,this._data=o.data,this.receivedTime=o.receivedTime,this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}switch(this._messageCode=o.data[0]&240,this.channel=o.data[0]&15,this._messageCode){case 128:this.messageType="noteoff",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 144:this.messageType="noteon",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 160:this.messageType="keypressure",this.key=o.data[1]&127,this.pressure=o.data[2]&127;break;case 176:this.messageType="controlchange",this.controllerNumber=o.data[1]&127,this.controllerValue=o.data[2]&127,this.controllerNumber===120&&this.controllerValue===0?this.channelModeMessage="allsoundoff":this.controllerNumber===121?this.channelModeMessage="resetallcontrollers":this.controllerNumber===122?this.controllerValue===0?this.channelModeMessage="localcontroloff":this.channelModeMessage="localcontrolon":this.controllerNumber===123&&this.controllerValue===0?this.channelModeMessage="allnotesoff":this.controllerNumber===124&&this.controllerValue===0?this.channelModeMessage="omnimodeoff":this.controllerNumber===125&&this.controllerValue===0?this.channelModeMessage="omnimodeon":this.controllerNumber===126?this.channelModeMessage="monomodeon":this.controllerNumber===127&&(this.channelModeMessage="polymodeon");break;case 192:this.messageType="programchange",this.program=o.data[1];break;case 208:this.messageType="channelpressure",this.pressure=o.data[1]&127;break;case 224:this.messageType="pitchbendchange";var i=o.data[2]&127,u=o.data[1]&127;this.pitchBend=(i<<8)+u;break}}return new l(s)},r.exports=e.default},{}]},{},[1])(1)})})(G)),G.exports}var V,ie;function Pe(){if(ie)return V;ie=1;var a=_e();return V=function(t){return t.listenToMidi=function(n,r){var e={},s=r||{},l=s.gain||function(o){return o/127};return n.onmidimessage=function(o){var i=o.messageType?o:a(o);if(i.messageType==="noteon"&&i.velocity===0&&(i.messageType="noteoff"),!(s.channel&&i.channel!==s.channel))switch(i.messageType){case"noteon":e[i.key]=t.play(i.key,0,{gain:l(i.velocity)});break;case"noteoff":e[i.key]&&(e[i.key].stop(),delete e[i.key]);break}},t},t},V}var ae;function Se(){return ae||(ae=1,(function(a){var t=Ee(),n=Ne(),r=Me(),e=Ce(),s=Pe();function l(o,i,u){return s(e(r(n(t(o,i,u)))))}a.exports&&(a.exports=l),typeof window<"u"&&(window.SamplePlayer=l)})(j)),j.exports}function se(a,t){return Array(t+1).join(a)}function X(a){return typeof a=="number"}function xe(a){return typeof a=="string"}function Le(a){return typeof a<"u"}function de(a,t){return Math.pow(2,(a-69)/12)*(t||440)}var fe=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function Be(){return fe}var qe=[0,2,4,5,7,9,11];function M(a,t,n){if(typeof a!="string")return null;var r=fe.exec(a);if(!r||!t&&r[4])return null;var e={letter:r[1].toUpperCase(),acc:r[2].replace(/x/g,"##")};e.pc=e.letter+e.acc,e.step=(e.letter.charCodeAt(0)+3)%7,e.alt=e.acc[0]==="b"?-e.acc.length:e.acc.length;var s=qe[e.step]+e.alt;return e.chroma=s<0?12+s:s%12,r[3]&&(e.oct=+r[3],e.midi=s+12*(e.oct+1),e.freq=de(e.midi,n)),t&&(e.tonicOf=r[4]),e}var Fe="CDEFGAB";function Oe(a){return X(a)?a<0?se("b",-a):se("#",a):""}function je(a){return X(a)?""+a:""}function he(a,t,n){return a===null||typeof a>"u"?null:a.step?he(a.step,a.alt,a.oct):a<0||a>6?null:Fe.charAt(a)+Oe(t)+je(n)}function me(a){if((X(a)||xe(a))&&a>=0&&a<128)return+a;var t=M(a);return t&&Le(t.midi)?t.midi:null}function Re(a,t){var n=me(a);return n===null?null:de(n,t)}function De(a){return(M(a)||{}).letter}function Ie(a){return(M(a)||{}).acc}function ke(a){return(M(a)||{}).pc}function He(a){return(M(a)||{}).step}function $e(a){return(M(a)||{}).alt}function Ge(a){return(M(a)||{}).chroma}function Ve(a){return(M(a)||{}).oct}const Ue=Object.freeze(Object.defineProperty({__proto__:null,acc:Ie,alt:$e,build:he,chroma:Ge,freq:Re,letter:De,midi:me,oct:Ve,parse:M,pc:ke,regex:Be,step:He},Symbol.toStringTag,{value:"Module"})),Xe=ge(Ue);var U,ue;function ze(){if(ue)return U;ue=1;var a=Xe;function t(e,s){if(console.warn("new Soundfont() is deprected"),console.log("Please use Soundfont.instrument() instead of new Soundfont().instrument()"),!(this instanceof t))return new t(e);this.nameToUrl=s||t.nameToUrl,this.ctx=e,this.instruments={},this.promises=[]}t.prototype.onready=function(e){console.warn("deprecated API"),console.log("Please use Promise.all(Soundfont.instrument(), Soundfont.instrument()).then() instead of new Soundfont().onready()"),Promise.all(this.promises).then(e)},t.prototype.instrument=function(e,s){console.warn("new Soundfont().instrument() is deprecated."),console.log("Please use Soundfont.instrument() instead.");var l=this.ctx;if(e=e||"default",e in this.instruments)return this.instruments[e];var o={name:e,play:r(l,s)};if(this.instruments[e]=o,e!=="default"){var i=t.instrument(l,e,s).then(function(u){return o.play=u.play,o});this.promises.push(i),o.onready=function(u){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),i.then(u)}}else o.onready=function(u){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),u()};return o};function n(e,s,l){return console.warn("Soundfont.loadBuffers is deprecate."),console.log("Use Soundfont.instrument(..) and get buffers properties from the result."),t.instrument(e,s,l).then(function(o){return o.buffers})}t.loadBuffers=n;function r(e,s){return s=s||{},function(l,o,i,u){console.warn("The oscillator player is deprecated."),console.log("Starting with version 0.9.0 you will have to wait until the soundfont is loaded to play sounds.");var d=l>0&&l<129?+l:a.midi(l),c=d?a.midiToFreq(d,440):null;if(c){i=i||.2,u=u||{};var m=u.destination||s.destination||e.destination,g=u.vcoType||s.vcoType||"sine",w=u.gain||s.gain||.4,b=e.createOscillator();b.type=g,b.frequency.value=c;var v=e.createGain();return v.gain.value=w,b.connect(v),v.connect(m),b.start(o),i>0&&b.stop(o+i),b}}}return t.noteToMidi=a.midi,U=t,U}var ce;function Je(){return ce||(ce=1,(function(a){var t=Te(),n=Se();function r(o,i,u){if(arguments.length===1)return function(w,b){return r(o,w,b)};var d=u||{},c=d.isSoundfontURL||e,m=d.nameToUrl||s,g=c(i)?i:m(i,d.soundfont,d.format);return t(o,g,{only:d.only||d.notes}).then(function(w){var b=n(o,w,d).connect(d.destination?d.destination:o.destination);return b.url=g,b.name=i,b})}function e(o){return/\.js(\?.*)?$/i.test(o)}function s(o,i,u){return u=u==="ogg"?u:"mp3",i=i==="FluidR3_GM"?i:"MusyngKite","https://gleitz.github.io/midi-js-soundfonts/"+i+"/"+o+"-"+u+".js"}var l=ze();l.instrument=r,l.nameToUrl=s,a.exports&&(a.exports=l),typeof window<"u"&&(window.Soundfont=l)})(B)),B.exports}var Ke=Je();const le=pe(Ke);class Ye{instrument=null;activeNotes=new Map;ready=!1;audioContext=null;async initialize(t="electric_piano_1"){try{this.audioContext=new AudioContext,this.instrument=await le.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite"}),this.ready=!0,console.log(`Audio service initialized with ${t}`)}catch(n){throw console.error("Failed to initialize audio service:",n),n}}async changeInstrument(t){try{this.stopAllNotes(),this.ready=!1,this.audioContext||(this.audioContext=new AudioContext),this.instrument=await le.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite"}),this.ready=!0,console.log(`Changed instrument to ${t}`)}catch(n){throw console.error("Failed to change instrument:",n),n}}playNote(t){if(!this.instrument||!this.ready){console.warn("Audio service not ready");return}if(this.activeNotes.has(t))return;const n=this.instrument.play(t);this.activeNotes.set(t,n)}stopNote(t){const n=this.activeNotes.get(t);n&&(n.stop(),this.activeNotes.delete(t))}stopAllNotes(){this.activeNotes.forEach(t=>t.stop()),this.activeNotes.clear()}isReady(){return this.ready}setPitchBend(t,n){const r=this.activeNotes.get(t);if(r)try{r.source&&r.source.detune&&(r.source.detune.value=n)}catch(e){console.warn("Failed to apply pitch bend:",e)}}}const _=new Ye;class We{container;activeButtons=new Set;showLabels=!0;currentPreset=null;dragStartX=new Map;noteToTouchId=new Map;touchIdToNote=new Map;mouseControlledNote=null;noteToButtonPosition=new Map;documentMouseMoveHandler=null;documentMouseUpHandler=null;documentTouchMoveHandler=null;documentTouchEndHandler=null;documentTouchCancelHandler=null;constructor(t){const n=document.getElementById(t);if(!n)throw new Error(`Container element with id "${t}" not found`);this.container=n,this.setupDocumentEventListeners()}isFormControl(t){if(!t||!(t instanceof HTMLElement))return!1;const n=t.tagName.toLowerCase();return n==="select"||n==="input"||n==="textarea"||n==="label"||t.closest("select, input, textarea, label")!==null}getButtonAtPoint(t,n){const r=document.elementFromPoint(t,n);if(r&&r.classList.contains("pad-button")){const e=r.getAttribute("data-note");if(e)return{button:r,note:e}}return null}isImmediatelyAdjacent(t,n){const r=this.noteToButtonPosition.get(t),e=this.noteToButtonPosition.get(n);return!r||!e?!1:r.col===e.col&&Math.abs(r.row-e.row)===1}setupDocumentEventListeners(){this.documentMouseMoveHandler=t=>{t.preventDefault();const n=this.getButtonAtPoint(t.clientX,t.clientY);this.mouseControlledNote&&(n&&n.note!==this.mouseControlledNote&&this.isImmediatelyAdjacent(this.mouseControlledNote,n.note)?(this.handleNoteEnd(this.mouseControlledNote),this.handleNoteStart(n.note,n.button,t.clientX),this.mouseControlledNote=n.note):(n||this.mouseControlledNote)&&this.handleDrag(this.mouseControlledNote,t.clientX))},this.documentMouseUpHandler=t=>{t.preventDefault(),this.mouseControlledNote&&(this.handleNoteEnd(this.mouseControlledNote),this.mouseControlledNote=null)},this.documentTouchMoveHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.touches.length;n++){const r=t.touches[n],e=this.touchIdToNote.get(r.identifier);if(e){const s=this.getButtonAtPoint(r.clientX,r.clientY);s&&s.note!==e&&this.isImmediatelyAdjacent(e,s.note)?(this.handleNoteEnd(e,r.identifier),this.handleNoteStart(s.note,s.button,r.clientX,r.identifier)):this.activeButtons.has(e)&&this.handleDrag(e,r.clientX,r.identifier)}}},this.documentTouchEndHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&this.handleNoteEnd(e,r.identifier)}},this.documentTouchCancelHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&this.handleNoteEnd(e,r.identifier)}},document.addEventListener("mousemove",this.documentMouseMoveHandler),document.addEventListener("mouseup",this.documentMouseUpHandler),document.addEventListener("touchmove",this.documentTouchMoveHandler,{passive:!1}),document.addEventListener("touchend",this.documentTouchEndHandler,{passive:!1}),document.addEventListener("touchcancel",this.documentTouchCancelHandler,{passive:!1})}setShowLabels(t){this.showLabels=t,this.currentPreset&&this.render(this.currentPreset)}render(t){this.currentPreset=t,this.activeButtons.clear(),this.noteToButtonPosition.clear(),this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateRows=`repeat(${t.rows}, 1fr)`,this.container.style.gridTemplateColumns=`repeat(${t.cols}, 1fr)`;const n=t.rows>10||t.cols>10?"2px":"6px";this.container.style.gap=n,this.container.style.width="100%",this.container.style.height="100%";const r=t.rows>10||t.cols>10?"8px":"16px";this.container.style.padding=r,t.buttons.forEach(e=>{const s=this.createButton(e);this.container.appendChild(s)})}createButton(t){const n=document.createElement("button");return n.className="pad-button",n.textContent=this.showLabels?t.label||t.note:"",n.dataset.note=t.note,this.noteToButtonPosition.set(t.note,{row:t.row,col:t.col}),t.color&&(n.style.backgroundColor=t.color),n.style.gridRow=`${t.row+1}`,n.style.gridColumn=`${t.col+1}`,n.addEventListener("mousedown",r=>{r.preventDefault(),this.handleNoteStart(t.note,n,r.clientX)}),n.addEventListener("touchstart",r=>{if(r.preventDefault(),r.changedTouches.length>0){const e=r.changedTouches[0];this.handleNoteStart(t.note,n,e.clientX,e.identifier)}}),n}handleNoteStart(t,n,r,e){if(!_.isReady()){console.warn("Audio service not ready");return}this.activeButtons.has(t)||(this.activeButtons.add(t),n.classList.add("active"),_.playNote(t),this.dragStartX.set(t,r),e!==void 0?(this.noteToTouchId.set(t,e),this.touchIdToNote.set(e,t)):this.mouseControlledNote=t)}handleDrag(t,n,r){if(r!==void 0&&this.noteToTouchId.get(t)!==r)return;const e=this.dragStartX.get(t);if(e===void 0)return;const s=n-e,l=window.innerWidth,o=1200,i=s/l*o,u=Math.max(-o,Math.min(o,i));_.setPitchBend(t,u)}handleNoteEnd(t,n){n!==void 0&&this.noteToTouchId.get(t)!==n||this.activeButtons.has(t)&&(this.activeButtons.delete(t),this.container.querySelectorAll(`[data-note="${t}"]`).forEach(e=>{e.classList.remove("active")}),_.stopNote(t),this.dragStartX.delete(t),n!==void 0?(this.noteToTouchId.delete(t),this.touchIdToNote.delete(n)):this.mouseControlledNote===t&&(this.mouseControlledNote=null))}stopAll(){this.activeButtons.clear(),_.stopAllNotes(),this.container.querySelectorAll(".pad-button").forEach(n=>n.classList.remove("active"))}destroy(){this.documentMouseMoveHandler&&document.removeEventListener("mousemove",this.documentMouseMoveHandler),this.documentMouseUpHandler&&document.removeEventListener("mouseup",this.documentMouseUpHandler),this.documentTouchMoveHandler&&document.removeEventListener("touchmove",this.documentTouchMoveHandler),this.documentTouchEndHandler&&document.removeEventListener("touchend",this.documentTouchEndHandler),this.documentTouchCancelHandler&&document.removeEventListener("touchcancel",this.documentTouchCancelHandler),this.stopAll()}}class Ze{container;config;onPresetChange;currentPresetId;constructor(t,n,r){const e=document.getElementById(t);if(!e)throw new Error(`Container element with id "${t}" not found`);this.container=e,this.config=n,this.onPresetChange=r,this.currentPresetId=n.defaultPresetId}render(){this.container.innerHTML="";const t=document.createElement("label");t.textContent="Layout: ",t.htmlFor="preset-select";const n=document.createElement("select");n.id="preset-select",n.className="preset-select",this.config.presets.forEach(r=>{const e=document.createElement("option");e.value=r.id,e.textContent=r.name,e.selected=r.id===this.currentPresetId,n.appendChild(e)}),n.addEventListener("change",r=>{const s=r.target.value;this.selectPreset(s)}),this.container.appendChild(t),this.container.appendChild(n)}selectPreset(t){const n=this.config.presets.find(r=>r.id===t);n?(this.currentPresetId=t,this.onPresetChange(n)):console.error(`Preset with id "${t}" not found`)}getCurrentPreset(){return this.config.presets.find(t=>t.id===this.currentPresetId)}}function z(a,t){const n=a.includes("#"),e={0:0,1:0,2:0,3:30,4:60,5:150,6:180,7:240,8:280,9:280}[t]??240;return n?`hsl(${e}, 25%, 28%)`:`hsl(${e}, 30%, 35%)`}function Qe(){const a=["C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5"],t=[];for(let n=0;n<a.length;n++){const r=Math.floor(n/6),e=n%6,s=a[n],l=parseInt(s.match(/\d+/)?.[0]??"4"),o=s.replace(/\d+/,"");t.push({row:r,col:e,note:s,label:s,color:z(o,l)})}return t}function et(){const a=[],n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];for(let r=0;r<16;r++)for(let e=0;e<19;e++){const s=36+e*2+r,l=Math.floor(s/12)-1,o=s%12,i=n[o],u=`${i}${l}`,d=z(i,l);a.push({row:15-r,col:e,note:u,label:u,color:d})}return a}function tt(){const a=[],n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];for(let r=0;r<12;r++)for(let e=0;e<15;e++){const s=48+e*2+r,l=Math.floor(s/12)-1,o=s%12,i=n[o],u=`${i}${l}`,d=z(i,l);a.push({row:11-r,col:e,note:u,label:u,color:d})}return a}const nt={presets:[{id:"chromatic",name:"Chromatic Scale",rows:4,cols:6,buttons:Qe()},{id:"harpejji",name:"Harpejji",rows:16,cols:19,buttons:et()},{id:"harpejji-compact",name:"Harpejji Compact",rows:12,cols:15,buttons:tt()}],defaultPresetId:"chromatic"};async function rt(){const a=document.getElementById("app");if(!a)throw new Error("App container not found");a.classList.add("loading");const t=document.getElementById("header");if(t){const n=document.createElement("div");n.id="loading-message",n.textContent="Loading audio...",t.appendChild(n)}try{await _.initialize("electric_piano_1");const n=document.getElementById("loading-message");n&&n.remove(),a.classList.remove("loading");const r=new We("grid-container"),e=document.getElementById("instrument-selector");if(e){const i=document.createElement("label");i.textContent="Instrument: ",i.htmlFor="instrument-select";const u=document.createElement("select");u.id="instrument-select",u.className="preset-select",[{value:"electric_piano_1",name:"Electric Piano (Rhodes)"},{value:"electric_piano_2",name:"Electric Piano (DX7)"},{value:"acoustic_grand_piano",name:"Acoustic Grand Piano"},{value:"bright_acoustic_piano",name:"Bright Acoustic Piano"},{value:"electric_grand_piano",name:"Electric Grand Piano"},{value:"honky_tonk_piano",name:"Honky-Tonk Piano"},{value:"vibraphone",name:"Vibraphone"},{value:"marimba",name:"Marimba"},{value:"xylophone",name:"Xylophone"},{value:"harpsichord",name:"Harpsichord"},{value:"clavinet",name:"Clavinet"},{value:"drawbar_organ",name:"Drawbar Organ"},{value:"percussive_organ",name:"Percussive Organ"},{value:"rock_organ",name:"Rock Organ"},{value:"church_organ",name:"Church Organ"},{value:"reed_organ",name:"Reed Organ"},{value:"acoustic_guitar_nylon",name:"Acoustic Guitar (Nylon)"},{value:"acoustic_guitar_steel",name:"Acoustic Guitar (Steel)"},{value:"electric_guitar_jazz",name:"Electric Guitar (Jazz)"},{value:"electric_guitar_clean",name:"Electric Guitar (Clean)"},{value:"electric_guitar_muted",name:"Electric Guitar (Muted)"},{value:"overdriven_guitar",name:"Overdriven Guitar"},{value:"distortion_guitar",name:"Distortion Guitar"}].forEach(c=>{const m=document.createElement("option");m.value=c.value,m.textContent=c.name,m.selected=c.value==="electric_piano_1",u.appendChild(m)}),u.addEventListener("change",async c=>{const g=c.target.value;u.disabled=!0,r.stopAll();try{await _.changeInstrument(g),u.disabled=!1}catch(w){console.error("Failed to change instrument:",w),u.disabled=!1}}),e.appendChild(i),e.appendChild(u)}const s=document.getElementById("labels-toggle");if(s){const i=document.createElement("input");i.type="checkbox",i.id="show-labels",i.checked=!0;const u=document.createElement("label");u.htmlFor="show-labels",u.textContent="Show note names",i.addEventListener("change",d=>{const c=d.target;r.setShowLabels(c.checked)}),s.appendChild(i),s.appendChild(u)}const l=new Ze("preset-selector",nt,i=>{r.stopAll(),r.render(i)});l.render();const o=l.getCurrentPreset();o&&r.render(o),console.log("Music Touchpad initialized successfully!")}catch(n){console.error("Failed to initialize app:",n);const r=document.createElement("div");r.className="error-message",r.textContent="Failed to load audio. Please refresh the page.",a.appendChild(r)}}rt();

(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=n(t);fetch(t.href,a)}})();function Ee(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Ne(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var e=i.default;if(typeof e=="function"){var n=function r(){var t=!1;try{t=this instanceof r}catch{}return t?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};n.prototype=e.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(i).forEach(function(r){var t=Object.getOwnPropertyDescriptor(i,r);Object.defineProperty(n,r,t.get?t:{enumerable:!0,get:function(){return i[r]}})}),n}var B={exports:{}},O={exports:{}},q,Z;function Ce(){if(Z)return q;Z=1;function i(n){return n>64&&n<91?n-65:n>96&&n<123?n-71:n>47&&n<58?n+4:n===43?62:n===47?63:0}function e(n,r){for(var t=n.replace(/[^A-Za-z0-9\+\/]/g,""),a=t.length,c=r?Math.ceil((a*3+1>>2)/r)*r:a*3+1>>2,o=new Uint8Array(c),s,u,d=0,l=0,f=0;f<a;f++)if(u=f&3,d|=i(t.charCodeAt(f))<<18-6*u,u===3||a-f===1){for(s=0;s<3&&l<c;s++,l++)o[l]=d>>>(16>>>s&24)&255;d=0}return o}return q={decode:e},q}var F,Q;function Ae(){return Q||(Q=1,F=function(i,e){return new Promise(function(n,r){var t=new XMLHttpRequest;e&&(t.responseType=e),t.open("GET",i),t.onload=function(){t.status===200?n(t.response):r(Error(t.statusText))},t.onerror=function(){r(Error("Network Error"))},t.send()})}),F}var ee;function Pe(){return ee||(ee=1,(function(i){var e=Ce(),n=Ae();function r(p){return function(h){return typeof h=="string"&&p.test(h)}}function t(p,h){return typeof p=="string"?p+h:typeof p=="function"?p(h):h}function a(p,h,T,N){var x=c(h)?o:s(h)?u:d(h)?l:f(h)?m:w(h)?g:v(h)?P:A(h)?_:y(h)?E:null,S=T||{};return x?x(p,h,S):N?Promise.resolve(N):Promise.reject("Source not valid ("+h+")")}a.fetch=n;function c(p){return p instanceof ArrayBuffer}function o(p,h,T){return new Promise(function(N,x){p.decodeAudioData(h,function(S){N(S)},function(){x("Can't decode audio data ("+h.slice(0,30)+"...)")})})}var s=r(/\.(mp3|wav|ogg)(\?.*)?$/i);function u(p,h,T){var N=t(T.from,h);return a(p,a.fetch(N,"arraybuffer"),T)}function d(p){return p&&typeof p.then=="function"}function l(p,h,T){return h.then(function(N){return a(p,N,T)})}var f=Array.isArray;function m(p,h,T){return Promise.all(h.map(function(N){return a(p,N,T,N)}))}function w(p){return p&&typeof p=="object"}function g(p,h,T){var N={},x=Object.keys(h).map(function(S){if(T.only&&T.only.indexOf(S)===-1)return null;var W=h[S];return a(p,W,T,W).then(function(_e){N[S]=_e})});return Promise.all(x).then(function(){return N})}var v=r(/\.json(\?.*)?$/i);function P(p,h,T){var N=t(T.from,h);return a(p,a.fetch(N,"text").then(JSON.parse),T)}var A=r(/^data:audio/);function _(p,h,T){var N=h.indexOf(",");return a(p,e.decode(h.slice(N+1)).buffer,T)}var y=r(/\.js(\?.*)?$/i);function E(p,h,T){var N=t(T.from,h);return a(p,a.fetch(N,"text").then(b),T)}function b(p){var h=p.indexOf("MIDI.Soundfont.");if(h<0)throw Error("Invalid MIDI.js Soundfont format");h=p.indexOf("=",h)+2;var T=p.lastIndexOf(",");return JSON.parse(p.slice(h,T)+"}")}i.exports&&(i.exports=a),typeof window<"u"&&(window.loadAudio=a)})(O)),O.exports}var R={exports:{}},j,te;function Se(){if(te)return j;te=1,j=i;function i(o){var s=o.createGain(),u=s._voltage=r(o),d=t(u),l=t(u),f=t(u);return s._startAmount=t(l),s._endAmount=t(f),s._multiplier=t(d),s._multiplier.connect(s),s._startAmount.connect(s),s._endAmount.connect(s),s.value=d.gain,s.startValue=l.gain,s.endValue=f.gain,s.startValue.value=0,s.endValue.value=0,Object.defineProperties(s,e),s}var e={attack:{value:0,writable:!0},decay:{value:0,writable:!0},sustain:{value:1,writable:!0},release:{value:0,writable:!0},getReleaseDuration:{value:function(){return this.release}},start:{value:function(o){var s=this._multiplier.gain,u=this._startAmount.gain,d=this._endAmount.gain;this._voltage.start(o),this._decayFrom=this._decayFrom=o+this.attack,this._startedAt=o;var l=this.sustain;s.cancelScheduledValues(o),u.cancelScheduledValues(o),d.cancelScheduledValues(o),d.setValueAtTime(0,o),this.attack?(s.setValueAtTime(0,o),s.linearRampToValueAtTime(1,o+this.attack),u.setValueAtTime(1,o),u.linearRampToValueAtTime(0,o+this.attack)):(s.setValueAtTime(1,o),u.setValueAtTime(0,o)),this.decay&&s.setTargetAtTime(l,this._decayFrom,a(this.decay))}},stop:{value:function(o,s){s&&(o=o-this.release);var u=o+this.release;if(this.release){var d=this._multiplier.gain,l=this._startAmount.gain,f=this._endAmount.gain;d.cancelScheduledValues(o),l.cancelScheduledValues(o),f.cancelScheduledValues(o);var m=a(this.release);if(this.attack&&o<this._decayFrom){var w=c(0,1,this._startedAt,this._decayFrom,o);d.linearRampToValueAtTime(w,o),l.linearRampToValueAtTime(1-w,o),l.setTargetAtTime(0,o,m)}f.setTargetAtTime(1,o,m),d.setTargetAtTime(0,o,m)}return this._voltage.stop(u),u}},onended:{get:function(){return this._voltage.onended},set:function(o){this._voltage.onended=o}}},n=new Float32Array([1,1]);function r(o){var s=o.createBufferSource(),u=o.createBuffer(1,2,o.sampleRate);return u.getChannelData(0).set(n),s.buffer=u,s.loop=!0,s}function t(o){var s=o.context.createGain();return o.connect(s),s}function a(o){return Math.log(o+1)/Math.log(100)}function c(o,s,u,d,l){var f=s-o,m=d-u,w=l-u,g=w/m,v=o+g*f;return v<=o&&(v=o),v>=s&&(v=s),v}return j}var D,ne;function Me(){if(ne)return D;ne=1;var i=Se(),e={},n={gain:1,attack:.01,decay:.1,sustain:.9,release:.3,loop:!1,cents:0,loopStart:0,loopEnd:0};function r(s,u,d){var l=!1,f=0,m={},w=s.createGain();w.gain.value=1;var g=Object.assign({},n,d),v={context:s,out:w,opts:g};return u instanceof AudioBuffer?v.buffer=u:v.buffers=u,v.start=function(_,y,E){if(v.buffer&&_!==null)return v.start(null,_,y);var b=_?v.buffers[_]:v.buffer;if(b){if(!l){console.warn("SamplePlayer not connected to any node.");return}}else{console.warn("Buffer "+_+" not found.");return}var p=E||e;y=Math.max(s.currentTime,y||0),v.emit("start",y,_,p);var h=A(_,b,p);return h.id=P(_,h),h.env.start(y),h.source.start(y),v.emit("started",y,h.id,h),p.duration&&h.stop(y+p.duration),h},v.play=function(_,y,E){return v.start(_,y,E)},v.stop=function(_,y){var E;return y=y||Object.keys(m),y.map(function(b){return E=m[b],E?(E.stop(_),E.id):null})},v.connect=function(_){return l=!0,w.connect(_),v},v.emit=function(_,y,E,b){v.onevent&&v.onevent(_,y,E,b);var p=v["on"+_];p&&p(y,E,b)},v;function P(_,y){return y.id=f++,m[y.id]=y,y.source.onended=function(){var E=s.currentTime;y.source.disconnect(),y.env.disconnect(),y.disconnect(),v.emit("ended",E,y.id,y)},y.id}function A(_,y,E){var b=s.createGain();return b.gain.value=0,b.connect(w),b.env=c(s,E,g),b.env.connect(b.gain),b.source=s.createBufferSource(),b.source.buffer=y,b.source.connect(b),b.source.loop=E.loop||g.loop,b.source.playbackRate.value=o(E.cents||g.cents),b.source.loopStart=E.loopStart||g.loopStart,b.source.loopEnd=E.loopEnd||g.loopEnd,b.stop=function(p){var h=p||s.currentTime;v.emit("stop",h,_);var T=b.env.stop(h);b.source.stop(T)},b}}function t(s){return typeof s=="number"}var a=["attack","decay","sustain","release"];function c(s,u,d){var l=i(s),f=u.adsr||d.adsr;return a.forEach(function(m,w){f?l[m]=f[w]:l[m]=u[m]||d[m]}),l.value.value=t(u.gain)?u.gain:t(d.gain)?d.gain:1,l}function o(s){return s?Math.pow(2,s/1200):1}return D=r,D}var k,re;function xe(){if(re)return k;re=1,k=function(e){return e.on=function(n,r){if(arguments.length===1&&typeof n=="function")return e.on("event",n);var t="on"+n,a=e[t];return e[t]=a?i(a,r):r,e},e};function i(e,n){return function(r,t,a,c){e(r,t,a,c),n(r,t,a,c)}}return k}var H,oe;function Le(){if(oe)return H;oe=1;var i=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function e(){return i}var n=[0,2,4,5,7,9,11];function r(o,s,u){if(typeof o!="string")return null;var d=i.exec(o);if(!d||!s&&d[4])return null;var l={letter:d[1].toUpperCase(),acc:d[2].replace(/x/g,"##")};return l.pc=l.letter+l.acc,l.step=(l.letter.charCodeAt(0)+3)%7,l.alt=l.acc[0]==="b"?-l.acc.length:l.acc.length,l.chroma=n[l.step]+l.alt,d[3]&&(l.oct=+d[3],l.midi=l.chroma+12*(l.oct+1),l.freq=t(l.midi,u)),s&&(l.tonicOf=d[4]),l}function t(o,s){return Math.pow(2,(o-69)/12)*(s||440)}var a={parse:r,regex:e,midiToFreq:t},c=["letter","acc","pc","step","alt","chroma","oct","midi","freq"];return c.forEach(function(o){a[o]=function(s){var u=r(s);return u&&typeof u[o]<"u"?u[o]:null}}),H=a,H}var $,ie;function Ie(){if(ie)return $;ie=1;var i=Le(),e=function(t){return t!==null&&t!==[]&&t>=0&&t<129},n=function(t){return e(t)?+t:i.midi(t)};$=function(t){if(t.buffers){var a=t.opts.map,c=typeof a=="function"?a:n,o=function(u){return u?c(u)||u:null};t.buffers=r(t.buffers,o);var s=t.start;t.start=function(u,d,l){var f=o(u),m=f%1;return m&&(f=Math.floor(f),l=Object.assign(l||{},{cents:Math.floor(m*100)})),s(f,d,l)}}return t};function r(t,a){return Object.keys(t).reduce(function(c,o){return c[a(o)]=t[o],c},{})}return $}var G,se;function Be(){if(se)return G;se=1;var i=Array.isArray,e=function(r){return r&&typeof r=="object"},n={};return G=function(r){return r.schedule=function(t,a){var c=r.context.currentTime,o=t<c?c:t;r.emit("schedule",o,a);var s,u,d,l;return a.map(function(f){if(f)i(f)?(s=f[0],u=f[1]):(s=f.time,u=f);else return null;return e(u)?(d=u.name||u.key||u.note||u.midi||null,l=u):(d=u,l=n),r.start(d,o+(s||0),l)})},r},G}function I(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var V={exports:{}},ae;function Oe(){return ae||(ae=1,(function(i,e){(function(n){i.exports=n()})(function(){return(function n(r,t,a){function c(u,d){if(!t[u]){if(!r[u]){var l=typeof I=="function"&&I;if(!d&&l)return l(u,!0);if(o)return o(u,!0);var f=new Error("Cannot find module '"+u+"'");throw f.code="MODULE_NOT_FOUND",f}var m=t[u]={exports:{}};r[u][0].call(m.exports,function(w){var g=r[u][1][w];return c(g||w)},m,m.exports,n,r,t,a)}return t[u].exports}for(var o=typeof I=="function"&&I,s=0;s<a.length;s++)c(a[s]);return c})({1:[function(n,r,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(a){function c(o){if(this._event=o,this._data=o.data,this.receivedTime=o.receivedTime,this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}switch(this._messageCode=o.data[0]&240,this.channel=o.data[0]&15,this._messageCode){case 128:this.messageType="noteoff",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 144:this.messageType="noteon",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 160:this.messageType="keypressure",this.key=o.data[1]&127,this.pressure=o.data[2]&127;break;case 176:this.messageType="controlchange",this.controllerNumber=o.data[1]&127,this.controllerValue=o.data[2]&127,this.controllerNumber===120&&this.controllerValue===0?this.channelModeMessage="allsoundoff":this.controllerNumber===121?this.channelModeMessage="resetallcontrollers":this.controllerNumber===122?this.controllerValue===0?this.channelModeMessage="localcontroloff":this.channelModeMessage="localcontrolon":this.controllerNumber===123&&this.controllerValue===0?this.channelModeMessage="allnotesoff":this.controllerNumber===124&&this.controllerValue===0?this.channelModeMessage="omnimodeoff":this.controllerNumber===125&&this.controllerValue===0?this.channelModeMessage="omnimodeon":this.controllerNumber===126?this.channelModeMessage="monomodeon":this.controllerNumber===127&&(this.channelModeMessage="polymodeon");break;case 192:this.messageType="programchange",this.program=o.data[1];break;case 208:this.messageType="channelpressure",this.pressure=o.data[1]&127;break;case 224:this.messageType="pitchbendchange";var s=o.data[2]&127,u=o.data[1]&127;this.pitchBend=(s<<8)+u;break}}return new c(a)},r.exports=t.default},{}]},{},[1])(1)})})(V)),V.exports}var X,ce;function qe(){if(ce)return X;ce=1;var i=Oe();return X=function(e){return e.listenToMidi=function(n,r){var t={},a=r||{},c=a.gain||function(o){return o/127};return n.onmidimessage=function(o){var s=o.messageType?o:i(o);if(s.messageType==="noteon"&&s.velocity===0&&(s.messageType="noteoff"),!(a.channel&&s.channel!==a.channel))switch(s.messageType){case"noteon":t[s.key]=e.play(s.key,0,{gain:c(s.velocity)});break;case"noteoff":t[s.key]&&(t[s.key].stop(),delete t[s.key]);break}},e},e},X}var ue;function Fe(){return ue||(ue=1,(function(i){var e=Me(),n=xe(),r=Ie(),t=Be(),a=qe();function c(o,s,u){return a(t(r(n(e(o,s,u)))))}i.exports&&(i.exports=c),typeof window<"u"&&(window.SamplePlayer=c)})(R)),R.exports}function le(i,e){return Array(e+1).join(i)}function z(i){return typeof i=="number"}function Re(i){return typeof i=="string"}function je(i){return typeof i<"u"}function ye(i,e){return Math.pow(2,(i-69)/12)*(e||440)}var be=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function De(){return be}var ke=[0,2,4,5,7,9,11];function C(i,e,n){if(typeof i!="string")return null;var r=be.exec(i);if(!r||!e&&r[4])return null;var t={letter:r[1].toUpperCase(),acc:r[2].replace(/x/g,"##")};t.pc=t.letter+t.acc,t.step=(t.letter.charCodeAt(0)+3)%7,t.alt=t.acc[0]==="b"?-t.acc.length:t.acc.length;var a=ke[t.step]+t.alt;return t.chroma=a<0?12+a:a%12,r[3]&&(t.oct=+r[3],t.midi=a+12*(t.oct+1),t.freq=ye(t.midi,n)),e&&(t.tonicOf=r[4]),t}var He="CDEFGAB";function $e(i){return z(i)?i<0?le("b",-i):le("#",i):""}function Ge(i){return z(i)?""+i:""}function we(i,e,n){return i===null||typeof i>"u"?null:i.step?we(i.step,i.alt,i.oct):i<0||i>6?null:He.charAt(i)+$e(e)+Ge(n)}function Te(i){if((z(i)||Re(i))&&i>=0&&i<128)return+i;var e=C(i);return e&&je(e.midi)?e.midi:null}function Ve(i,e){var n=Te(i);return n===null?null:ye(n,e)}function Xe(i){return(C(i)||{}).letter}function Ue(i){return(C(i)||{}).acc}function ze(i){return(C(i)||{}).pc}function Je(i){return(C(i)||{}).step}function Ke(i){return(C(i)||{}).alt}function Ye(i){return(C(i)||{}).chroma}function We(i){return(C(i)||{}).oct}const Ze=Object.freeze(Object.defineProperty({__proto__:null,acc:Ue,alt:Ke,build:we,chroma:Ye,freq:Ve,letter:Xe,midi:Te,oct:We,parse:C,pc:ze,regex:De,step:Je},Symbol.toStringTag,{value:"Module"})),Qe=Ne(Ze);var U,de;function et(){if(de)return U;de=1;var i=Qe;function e(t,a){if(console.warn("new Soundfont() is deprected"),console.log("Please use Soundfont.instrument() instead of new Soundfont().instrument()"),!(this instanceof e))return new e(t);this.nameToUrl=a||e.nameToUrl,this.ctx=t,this.instruments={},this.promises=[]}e.prototype.onready=function(t){console.warn("deprecated API"),console.log("Please use Promise.all(Soundfont.instrument(), Soundfont.instrument()).then() instead of new Soundfont().onready()"),Promise.all(this.promises).then(t)},e.prototype.instrument=function(t,a){console.warn("new Soundfont().instrument() is deprecated."),console.log("Please use Soundfont.instrument() instead.");var c=this.ctx;if(t=t||"default",t in this.instruments)return this.instruments[t];var o={name:t,play:r(c,a)};if(this.instruments[t]=o,t!=="default"){var s=e.instrument(c,t,a).then(function(u){return o.play=u.play,o});this.promises.push(s),o.onready=function(u){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),s.then(u)}}else o.onready=function(u){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),u()};return o};function n(t,a,c){return console.warn("Soundfont.loadBuffers is deprecate."),console.log("Use Soundfont.instrument(..) and get buffers properties from the result."),e.instrument(t,a,c).then(function(o){return o.buffers})}e.loadBuffers=n;function r(t,a){return a=a||{},function(c,o,s,u){console.warn("The oscillator player is deprecated."),console.log("Starting with version 0.9.0 you will have to wait until the soundfont is loaded to play sounds.");var d=c>0&&c<129?+c:i.midi(c),l=d?i.midiToFreq(d,440):null;if(l){s=s||.2,u=u||{};var f=u.destination||a.destination||t.destination,m=u.vcoType||a.vcoType||"sine",w=u.gain||a.gain||.4,g=t.createOscillator();g.type=m,g.frequency.value=l;var v=t.createGain();return v.gain.value=w,g.connect(v),v.connect(f),g.start(o),s>0&&g.stop(o+s),g}}}return e.noteToMidi=i.midi,U=e,U}var fe;function tt(){return fe||(fe=1,(function(i){var e=Pe(),n=Fe();function r(o,s,u){if(arguments.length===1)return function(w,g){return r(o,w,g)};var d=u||{},l=d.isSoundfontURL||t,f=d.nameToUrl||a,m=l(s)?s:f(s,d.soundfont,d.format);return e(o,m,{only:d.only||d.notes}).then(function(w){var g=n(o,w,d).connect(d.destination?d.destination:o.destination);return g.url=m,g.name=s,g})}function t(o){return/\.js(\?.*)?$/i.test(o)}function a(o,s,u){return u=u==="ogg"?u:"mp3",s=s==="FluidR3_GM"?s:"MusyngKite","https://gleitz.github.io/midi-js-soundfonts/"+s+"/"+o+"-"+u+".js"}var c=et();c.instrument=r,c.nameToUrl=a,i.exports&&(i.exports=c),typeof window<"u"&&(window.Soundfont=c)})(B)),B.exports}var nt=tt();const he=Ee(nt),rt=new Set(["drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synthstrings_1","synthstrings_2","choir_aahs","voice_oohs","synth_voice","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep"]);class ot{instrument=null;activeNotes=new Map;ready=!1;audioContext=null;currentInstrumentName="";async initialize(e="electric_piano_1"){try{this.audioContext=new AudioContext,this.instrument=await he.instrument(this.audioContext,e,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=e,this.ready=!0,console.log(`Audio service initialized with ${e}`)}catch(n){throw console.error("Failed to initialize audio service:",n),n}}async changeInstrument(e){try{this.stopAllNotes(),this.ready=!1,this.audioContext||(this.audioContext=new AudioContext),this.instrument=await he.instrument(this.audioContext,e,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=e,this.ready=!0,console.log(`Changed instrument to ${e}`)}catch(n){throw console.error("Failed to change instrument:",n),n}}playNote(e){if(!this.instrument||!this.ready){console.warn("Audio service not ready");return}if(this.activeNotes.has(e))return;const n=rt.has(this.currentInstrumentName),r={gain:2,loop:n};n&&(r.loopStart=.3,r.loopEnd=2.5);const t=this.instrument.play(e,0,r);this.activeNotes.set(e,t)}stopNote(e){const n=this.activeNotes.get(e);n&&(n.stop(),this.activeNotes.delete(e))}stopAllNotes(){this.activeNotes.forEach(e=>e.stop()),this.activeNotes.clear()}isReady(){return this.ready}setPitchBend(e,n){const r=this.activeNotes.get(e);if(r)try{r.source&&r.source.detune&&(r.source.detune.value=n)}catch(t){console.warn("Failed to apply pitch bend:",t)}}}const M=new ot,L={instrument:"electric_piano_1",presetId:"harpejji-compact",showLabels:!1};class it{container;activeButtons=new Set;showLabels=L.showLabels;currentPreset=null;dragStartX=new Map;noteToTouchId=new Map;touchIdToNote=new Map;mouseControlledNote=null;mouseControlledPosition=null;touchIdToPosition=new Map;buttonPositions=new Map;documentMouseMoveHandler=null;documentMouseUpHandler=null;documentTouchMoveHandler=null;documentTouchEndHandler=null;documentTouchCancelHandler=null;constructor(e){const n=document.getElementById(e);if(!n)throw new Error(`Container element with id "${e}" not found`);this.container=n,this.setupDocumentEventListeners()}isFormControl(e){if(!e||!(e instanceof HTMLElement))return!1;const n=e.tagName.toLowerCase();return n==="select"||n==="input"||n==="textarea"||n==="label"||n==="dialog"||n==="button"&&!e.classList.contains("pad-button")||e.closest("select, input, textarea, label, dialog, .burger-menu, .close-button")!==null}getButtonAtPoint(e,n){const r=document.elementFromPoint(e,n);if(r&&r.classList.contains("pad-button")){const t=r.getAttribute("data-note"),a=r.getAttribute("data-position");if(t&&a){const c=this.buttonPositions.get(a);if(c)return{button:r,note:t,position:c}}}return null}isImmediatelyAdjacent(e,n){return e.col===n.col&&Math.abs(e.row-n.row)===1}setupDocumentEventListeners(){this.documentMouseMoveHandler=e=>{this.isFormControl(e.target)||e.preventDefault();const n=this.getButtonAtPoint(e.clientX,e.clientY);if(this.mouseControlledNote&&this.mouseControlledPosition)if(n&&(n.note!==this.mouseControlledNote||n.position.row!==this.mouseControlledPosition.row||n.position.col!==this.mouseControlledPosition.col)&&this.isImmediatelyAdjacent(this.mouseControlledPosition,n.position)){const r=this.dragStartX.get(this.mouseControlledNote);this.handleNoteEnd(this.mouseControlledNote),this.handleNoteStart(n.note,n.button,e.clientX,void 0,!0,n.position),r!==void 0&&this.dragStartX.set(n.note,r),this.mouseControlledNote=n.note,this.mouseControlledPosition=n.position}else(n||this.mouseControlledNote)&&this.handleDrag(this.mouseControlledNote,e.clientX)},this.documentMouseUpHandler=e=>{this.isFormControl(e.target)||e.preventDefault(),this.mouseControlledNote&&(this.handleNoteEnd(this.mouseControlledNote),this.mouseControlledNote=null,this.mouseControlledPosition=null)},this.documentTouchMoveHandler=e=>{this.isFormControl(e.target)||e.preventDefault();for(let n=0;n<e.touches.length;n++){const r=e.touches[n],t=this.touchIdToNote.get(r.identifier),a=this.touchIdToPosition.get(r.identifier);if(t&&a){const c=this.getButtonAtPoint(r.clientX,r.clientY);if(c&&(c.note!==t||c.position.row!==a.row||c.position.col!==a.col)&&this.isImmediatelyAdjacent(a,c.position)){const o=this.dragStartX.get(t);this.handleNoteEnd(t,r.identifier),this.handleNoteStart(c.note,c.button,r.clientX,r.identifier,!0,c.position),o!==void 0&&this.dragStartX.set(c.note,o)}else this.activeButtons.has(t)&&this.handleDrag(t,r.clientX,r.identifier)}}},this.documentTouchEndHandler=e=>{this.isFormControl(e.target)||e.preventDefault();for(let n=0;n<e.changedTouches.length;n++){const r=e.changedTouches[n],t=this.touchIdToNote.get(r.identifier);t&&(this.handleNoteEnd(t,r.identifier),this.touchIdToPosition.delete(r.identifier))}},this.documentTouchCancelHandler=e=>{this.isFormControl(e.target)||e.preventDefault();for(let n=0;n<e.changedTouches.length;n++){const r=e.changedTouches[n],t=this.touchIdToNote.get(r.identifier);t&&(this.handleNoteEnd(t,r.identifier),this.touchIdToPosition.delete(r.identifier))}},document.addEventListener("mousemove",this.documentMouseMoveHandler),document.addEventListener("mouseup",this.documentMouseUpHandler),document.addEventListener("touchmove",this.documentTouchMoveHandler,{passive:!1}),document.addEventListener("touchend",this.documentTouchEndHandler,{passive:!1}),document.addEventListener("touchcancel",this.documentTouchCancelHandler,{passive:!1})}setShowLabels(e){this.showLabels=e,this.currentPreset&&this.render(this.currentPreset)}render(e){this.currentPreset=e,this.activeButtons.clear(),this.buttonPositions.clear(),this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateRows=`repeat(${e.rows}, 1fr)`,this.container.style.gridTemplateColumns=`repeat(${e.cols}, 1fr)`;const n=e.rows>10||e.cols>10?"2px":"6px";this.container.style.gap=n,this.container.style.width="100%",this.container.style.height="100%";const r=e.rows>10||e.cols>10?"8px":"16px";this.container.style.padding=r,e.buttons.forEach(t=>{const a=this.createButton(t);this.container.appendChild(a)})}createButton(e){const n=document.createElement("button");n.className="pad-button",n.textContent=this.showLabels?e.label||e.note:"",n.dataset.note=e.note;const r=`${e.row}-${e.col}`;return n.dataset.position=r,this.buttonPositions.set(r,{row:e.row,col:e.col}),e.color&&(n.style.backgroundColor=e.color),n.style.gridRow=`${e.row+1}`,n.style.gridColumn=`${e.col+1}`,n.addEventListener("mousedown",t=>{t.preventDefault(),this.handleNoteStart(e.note,n,t.clientX,void 0,!1,{row:e.row,col:e.col})}),n.addEventListener("touchstart",t=>{if(t.preventDefault(),t.changedTouches.length>0){const a=t.changedTouches[0];this.handleNoteStart(e.note,n,a.clientX,a.identifier,!1,{row:e.row,col:e.col})}}),n}handleNoteStart(e,n,r,t,a=!1,c){if(!M.isReady()){console.warn("Audio service not ready");return}this.activeButtons.has(e)||(this.activeButtons.add(e),n.classList.add("active"),M.playNote(e),a||this.dragStartX.set(e,r),t!==void 0&&c?(this.noteToTouchId.set(e,t),this.touchIdToNote.set(t,e),this.touchIdToPosition.set(t,c)):c&&(this.mouseControlledNote=e,this.mouseControlledPosition=c))}handleDrag(e,n,r){if(r!==void 0&&this.noteToTouchId.get(e)!==r)return;const t=this.dragStartX.get(e);if(t===void 0)return;const a=n-t,c=window.innerWidth,o=1200,s=a/c*o,u=Math.max(-o,Math.min(o,s));M.setPitchBend(e,u)}handleNoteEnd(e,n){n!==void 0&&this.noteToTouchId.get(e)!==n||this.activeButtons.has(e)&&(this.activeButtons.delete(e),this.container.querySelectorAll(`[data-note="${e}"]`).forEach(t=>{t.classList.remove("active")}),M.stopNote(e),this.dragStartX.delete(e),n!==void 0?(this.noteToTouchId.delete(e),this.touchIdToNote.delete(n)):this.mouseControlledNote===e&&(this.mouseControlledNote=null))}stopAll(){this.activeButtons.clear(),M.stopAllNotes(),this.container.querySelectorAll(".pad-button").forEach(n=>n.classList.remove("active"))}destroy(){this.documentMouseMoveHandler&&document.removeEventListener("mousemove",this.documentMouseMoveHandler),this.documentMouseUpHandler&&document.removeEventListener("mouseup",this.documentMouseUpHandler),this.documentTouchMoveHandler&&document.removeEventListener("touchmove",this.documentTouchMoveHandler),this.documentTouchEndHandler&&document.removeEventListener("touchend",this.documentTouchEndHandler),this.documentTouchCancelHandler&&document.removeEventListener("touchcancel",this.documentTouchCancelHandler),this.stopAll()}}class st{container;config;onPresetChange;currentPresetId;constructor(e,n,r){const t=document.getElementById(e);if(!t)throw new Error(`Container element with id "${e}" not found`);this.container=t,this.config=n,this.onPresetChange=r,this.currentPresetId=n.defaultPresetId}render(){this.container.innerHTML="";const e=document.createElement("label");e.textContent="Layout: ",e.htmlFor="preset-select";const n=document.createElement("select");n.id="preset-select",n.className="preset-select",this.config.presets.forEach(r=>{const t=document.createElement("option");t.value=r.id,t.textContent=r.name,t.selected=r.id===this.currentPresetId,n.appendChild(t)}),n.addEventListener("change",r=>{const a=r.target.value;this.selectPreset(a)}),this.container.appendChild(e),this.container.appendChild(n)}selectPreset(e){const n=this.config.presets.find(r=>r.id===e);n?(this.currentPresetId=e,this.onPresetChange(n)):console.error(`Preset with id "${e}" not found`)}getCurrentPreset(){return this.config.presets.find(e=>e.id===this.currentPresetId)}}function J(i){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=i.match(/^([A-G]#?)(\d+)$/);if(!n)throw new Error(`Invalid note name: ${i}`);const[,r,t]=n,a=parseInt(t),c=e.indexOf(r);if(c===-1)throw new Error(`Invalid note name: ${i}`);return(a+1)*12+c}function K(i){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(i/12)-1,r=i%12;return`${e[r]}${n}`}function Y(i,e){const n=i.includes("#"),t={0:0,1:0,2:0,3:30,4:60,5:150,6:180,7:240,8:280,9:280}[e]??240;return n?`hsl(${t}, 25%, 28%)`:`hsl(${t}, 30%, 35%)`}function me(i="C4"){const e=[],n=J(i),r=24;for(let t=0;t<r;t++){const a=Math.floor(t/6),c=t%6,o=n+t,s=K(o),u=parseInt(s.match(/\d+/)?.[0]??"4"),d=s.replace(/\d+/,"");e.push({row:a,col:c,note:s,label:s,color:Y(d,u)})}return e}function pe(i="C2"){const e=[],n=J(i);for(let r=0;r<16;r++)for(let t=0;t<19;t++){const a=n+t*2+r,c=K(a),o=parseInt(c.match(/\d+/)?.[0]??"4"),s=c.replace(/\d+/,""),u=Y(s,o);e.push({row:15-r,col:t,note:c,label:c,color:u})}return e}function ve(i="C3"){const e=[],n=J(i);for(let r=0;r<12;r++)for(let t=0;t<15;t++){const a=n+t*2+r,c=K(a),o=parseInt(c.match(/\d+/)?.[0]??"4"),s=c.replace(/\d+/,""),u=Y(s,o);e.push({row:11-r,col:t,note:c,label:c,color:u})}return e}const ge={presets:[{id:"chromatic",name:"Chromatic Scale",rows:4,cols:6,defaultLowestNote:"C4",buttons:me("C4")},{id:"harpejji",name:"Harpejji",rows:16,cols:19,defaultLowestNote:"C2",buttons:pe("C2")},{id:"harpejji-compact",name:"Harpejji Compact",rows:12,cols:15,defaultLowestNote:"C3",buttons:ve("C3")}],defaultPresetId:L.presetId,updateLowestNote(i){this.presets[0].buttons=me(i),this.presets[1].buttons=pe(i),this.presets[2].buttons=ve(i)}},at="1.0.1";async function ct(){const i=document.getElementById("app");if(!i)throw new Error("App container not found");const e=document.getElementById("app-version");e&&(e.textContent=`v${at}`);const n=document.getElementById("burger-menu"),r=document.getElementById("menu-dialog"),t=document.getElementById("close-menu");n&&r&&n.addEventListener("click",()=>{r.showModal()}),t&&r&&t.addEventListener("click",()=>{r.close()}),r&&r.addEventListener("click",a=>{const c=r.getBoundingClientRect();(a.clientX<c.left||a.clientX>c.right||a.clientY<c.top||a.clientY>c.bottom)&&r.close()});try{await M.initialize(L.instrument);const a=document.getElementById("loading-overlay");a&&a.classList.add("hidden");const c=new it("grid-container"),o=document.getElementById("instrument-selector");if(o){const f=document.createElement("label");f.textContent="Instrument: ",f.htmlFor="instrument-select";const m=document.createElement("select");m.id="instrument-select",m.className="preset-select",[{value:"electric_piano_1",name:"Electric Piano (Rhodes)"},{value:"electric_piano_2",name:"Electric Piano (DX7)"},{value:"acoustic_grand_piano",name:"Acoustic Grand Piano"},{value:"bright_acoustic_piano",name:"Bright Acoustic Piano"},{value:"electric_grand_piano",name:"Electric Grand Piano"},{value:"honky_tonk_piano",name:"Honky-Tonk Piano"},{value:"vibraphone",name:"Vibraphone"},{value:"marimba",name:"Marimba"},{value:"xylophone",name:"Xylophone"},{value:"harpsichord",name:"Harpsichord"},{value:"clavinet",name:"Clavinet"},{value:"drawbar_organ",name:"Drawbar Organ"},{value:"percussive_organ",name:"Percussive Organ"},{value:"rock_organ",name:"Rock Organ"},{value:"church_organ",name:"Church Organ"},{value:"reed_organ",name:"Reed Organ"},{value:"acoustic_guitar_nylon",name:"Acoustic Guitar (Nylon)"},{value:"acoustic_guitar_steel",name:"Acoustic Guitar (Steel)"},{value:"electric_guitar_jazz",name:"Electric Guitar (Jazz)"},{value:"electric_guitar_clean",name:"Electric Guitar (Clean)"},{value:"electric_guitar_muted",name:"Electric Guitar (Muted)"},{value:"overdriven_guitar",name:"Overdriven Guitar"},{value:"distortion_guitar",name:"Distortion Guitar"}].forEach(g=>{const v=document.createElement("option");v.value=g.value,v.textContent=g.name,v.selected=g.value===L.instrument,m.appendChild(v)}),m.addEventListener("change",async g=>{const P=g.target.value;m.disabled=!0,c.stopAll();try{await M.changeInstrument(P),m.disabled=!1}catch(A){console.error("Failed to change instrument:",A),m.disabled=!1}}),o.appendChild(f),o.appendChild(m)}const s=document.getElementById("lowest-note-selector");if(s){const f=document.createElement("label");f.textContent="Lowest Note: ",f.htmlFor="lowest-note-select";const m=document.createElement("select");m.id="lowest-note-select",m.className="preset-select",["G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4"].forEach(g=>{const v=document.createElement("option");v.value=g,v.textContent=g,m.appendChild(v)}),m.addEventListener("change",g=>{const P=g.target.value;ge.updateLowestNote(P);const A=d.getCurrentPreset();A&&(c.stopAll(),c.render(A))}),s.appendChild(f),s.appendChild(m)}const u=document.getElementById("labels-toggle");if(u){const f=document.createElement("input");f.type="checkbox",f.id="show-labels",f.checked=L.showLabels;const m=document.createElement("label");m.htmlFor="show-labels",m.textContent="Show note names",f.addEventListener("change",w=>{const g=w.target;c.setShowLabels(g.checked)}),u.appendChild(f),u.appendChild(m)}const d=new st("preset-selector",ge,f=>{c.stopAll();const m=document.getElementById("lowest-note-select");m&&(m.value=f.defaultLowestNote),c.render(f)});d.render();const l=d.getCurrentPreset();if(l){const f=document.getElementById("lowest-note-select");f&&(f.value=l.defaultLowestNote),c.render(l)}console.log("Music Touchpad initialized successfully!")}catch(a){console.error("Failed to initialize app:",a);const c=document.createElement("div");c.className="error-message",c.textContent="Failed to load audio. Please refresh the page.",i.appendChild(c)}}ct();

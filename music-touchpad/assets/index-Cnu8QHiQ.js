(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function n(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(e){if(e.ep)return;e.ep=!0;const a=n(e);fetch(e.href,a)}})();function _e(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Ne(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var t=i.default;if(typeof t=="function"){var n=function r(){var e=!1;try{e=this instanceof r}catch{}return e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(i).forEach(function(r){var e=Object.getOwnPropertyDescriptor(i,r);Object.defineProperty(n,r,e.get?e:{enumerable:!0,get:function(){return i[r]}})}),n}var I={exports:{}},q={exports:{}},B,W;function Ce(){if(W)return B;W=1;function i(n){return n>64&&n<91?n-65:n>96&&n<123?n-71:n>47&&n<58?n+4:n===43?62:n===47?63:0}function t(n,r){for(var e=n.replace(/[^A-Za-z0-9\+\/]/g,""),a=e.length,u=r?Math.ceil((a*3+1>>2)/r)*r:a*3+1>>2,o=new Uint8Array(u),s,c,d=0,l=0,m=0;m<a;m++)if(c=m&3,d|=i(e.charCodeAt(m))<<18-6*c,c===3||a-m===1){for(s=0;s<3&&l<u;s++,l++)o[l]=d>>>(16>>>s&24)&255;d=0}return o}return B={decode:t},B}var O,Z;function Ee(){return Z||(Z=1,O=function(i,t){return new Promise(function(n,r){var e=new XMLHttpRequest;t&&(e.responseType=t),e.open("GET",i),e.onload=function(){e.status===200?n(e.response):r(Error(e.statusText))},e.onerror=function(){r(Error("Network Error"))},e.send()})}),O}var Q;function Ae(){return Q||(Q=1,(function(i){var t=Ce(),n=Ee();function r(h){return function(f){return typeof f=="string"&&h.test(f)}}function e(h,f){return typeof h=="string"?h+f:typeof h=="function"?h(f):f}function a(h,f,T,C){var S=u(f)?o:s(f)?c:d(f)?l:m(f)?p:g(f)?b:v(f)?x:L(f)?_:y(f)?N:null,A=T||{};return S?S(h,f,A):C?Promise.resolve(C):Promise.reject("Source not valid ("+f+")")}a.fetch=n;function u(h){return h instanceof ArrayBuffer}function o(h,f,T){return new Promise(function(C,S){h.decodeAudioData(f,function(A){C(A)},function(){S("Can't decode audio data ("+f.slice(0,30)+"...)")})})}var s=r(/\.(mp3|wav|ogg)(\?.*)?$/i);function c(h,f,T){var C=e(T.from,f);return a(h,a.fetch(C,"arraybuffer"),T)}function d(h){return h&&typeof h.then=="function"}function l(h,f,T){return f.then(function(C){return a(h,C,T)})}var m=Array.isArray;function p(h,f,T){return Promise.all(f.map(function(C){return a(h,C,T,C)}))}function g(h){return h&&typeof h=="object"}function b(h,f,T){var C={},S=Object.keys(f).map(function(A){if(T.only&&T.only.indexOf(A)===-1)return null;var Y=f[A];return a(h,Y,T,Y).then(function(Te){C[A]=Te})});return Promise.all(S).then(function(){return C})}var v=r(/\.json(\?.*)?$/i);function x(h,f,T){var C=e(T.from,f);return a(h,a.fetch(C,"text").then(JSON.parse),T)}var L=r(/^data:audio/);function _(h,f,T){var C=f.indexOf(",");return a(h,t.decode(f.slice(C+1)).buffer,T)}var y=r(/\.js(\?.*)?$/i);function N(h,f,T){var C=e(T.from,f);return a(h,a.fetch(C,"text").then(w),T)}function w(h){var f=h.indexOf("MIDI.Soundfont.");if(f<0)throw Error("Invalid MIDI.js Soundfont format");f=h.indexOf("=",f)+2;var T=h.lastIndexOf(",");return JSON.parse(h.slice(f,T)+"}")}i.exports&&(i.exports=a),typeof window<"u"&&(window.loadAudio=a)})(q)),q.exports}var F={exports:{}},R,ee;function Pe(){if(ee)return R;ee=1,R=i;function i(o){var s=o.createGain(),c=s._voltage=r(o),d=e(c),l=e(c),m=e(c);return s._startAmount=e(l),s._endAmount=e(m),s._multiplier=e(d),s._multiplier.connect(s),s._startAmount.connect(s),s._endAmount.connect(s),s.value=d.gain,s.startValue=l.gain,s.endValue=m.gain,s.startValue.value=0,s.endValue.value=0,Object.defineProperties(s,t),s}var t={attack:{value:0,writable:!0},decay:{value:0,writable:!0},sustain:{value:1,writable:!0},release:{value:0,writable:!0},getReleaseDuration:{value:function(){return this.release}},start:{value:function(o){var s=this._multiplier.gain,c=this._startAmount.gain,d=this._endAmount.gain;this._voltage.start(o),this._decayFrom=this._decayFrom=o+this.attack,this._startedAt=o;var l=this.sustain;s.cancelScheduledValues(o),c.cancelScheduledValues(o),d.cancelScheduledValues(o),d.setValueAtTime(0,o),this.attack?(s.setValueAtTime(0,o),s.linearRampToValueAtTime(1,o+this.attack),c.setValueAtTime(1,o),c.linearRampToValueAtTime(0,o+this.attack)):(s.setValueAtTime(1,o),c.setValueAtTime(0,o)),this.decay&&s.setTargetAtTime(l,this._decayFrom,a(this.decay))}},stop:{value:function(o,s){s&&(o=o-this.release);var c=o+this.release;if(this.release){var d=this._multiplier.gain,l=this._startAmount.gain,m=this._endAmount.gain;d.cancelScheduledValues(o),l.cancelScheduledValues(o),m.cancelScheduledValues(o);var p=a(this.release);if(this.attack&&o<this._decayFrom){var g=u(0,1,this._startedAt,this._decayFrom,o);d.linearRampToValueAtTime(g,o),l.linearRampToValueAtTime(1-g,o),l.setTargetAtTime(0,o,p)}m.setTargetAtTime(1,o,p),d.setTargetAtTime(0,o,p)}return this._voltage.stop(c),c}},onended:{get:function(){return this._voltage.onended},set:function(o){this._voltage.onended=o}}},n=new Float32Array([1,1]);function r(o){var s=o.createBufferSource(),c=o.createBuffer(1,2,o.sampleRate);return c.getChannelData(0).set(n),s.buffer=c,s.loop=!0,s}function e(o){var s=o.context.createGain();return o.connect(s),s}function a(o){return Math.log(o+1)/Math.log(100)}function u(o,s,c,d,l){var m=s-o,p=d-c,g=l-c,b=g/p,v=o+b*m;return v<=o&&(v=o),v>=s&&(v=s),v}return R}var j,te;function Se(){if(te)return j;te=1;var i=Pe(),t={},n={gain:1,attack:.01,decay:.1,sustain:.9,release:.3,loop:!1,cents:0,loopStart:0,loopEnd:0};function r(s,c,d){var l=!1,m=0,p={},g=s.createGain();g.gain.value=1;var b=Object.assign({},n,d),v={context:s,out:g,opts:b};return c instanceof AudioBuffer?v.buffer=c:v.buffers=c,v.start=function(_,y,N){if(v.buffer&&_!==null)return v.start(null,_,y);var w=_?v.buffers[_]:v.buffer;if(w){if(!l){console.warn("SamplePlayer not connected to any node.");return}}else{console.warn("Buffer "+_+" not found.");return}var h=N||t;y=Math.max(s.currentTime,y||0),v.emit("start",y,_,h);var f=L(_,w,h);return f.id=x(_,f),f.env.start(y),f.source.start(y),v.emit("started",y,f.id,f),h.duration&&f.stop(y+h.duration),f},v.play=function(_,y,N){return v.start(_,y,N)},v.stop=function(_,y){var N;return y=y||Object.keys(p),y.map(function(w){return N=p[w],N?(N.stop(_),N.id):null})},v.connect=function(_){return l=!0,g.connect(_),v},v.emit=function(_,y,N,w){v.onevent&&v.onevent(_,y,N,w);var h=v["on"+_];h&&h(y,N,w)},v;function x(_,y){return y.id=m++,p[y.id]=y,y.source.onended=function(){var N=s.currentTime;y.source.disconnect(),y.env.disconnect(),y.disconnect(),v.emit("ended",N,y.id,y)},y.id}function L(_,y,N){var w=s.createGain();return w.gain.value=0,w.connect(g),w.env=u(s,N,b),w.env.connect(w.gain),w.source=s.createBufferSource(),w.source.buffer=y,w.source.connect(w),w.source.loop=N.loop||b.loop,w.source.playbackRate.value=o(N.cents||b.cents),w.source.loopStart=N.loopStart||b.loopStart,w.source.loopEnd=N.loopEnd||b.loopEnd,w.stop=function(h){var f=h||s.currentTime;v.emit("stop",f,_);var T=w.env.stop(f);w.source.stop(T)},w}}function e(s){return typeof s=="number"}var a=["attack","decay","sustain","release"];function u(s,c,d){var l=i(s),m=c.adsr||d.adsr;return a.forEach(function(p,g){m?l[p]=m[g]:l[p]=c[p]||d[p]}),l.value.value=e(c.gain)?c.gain:e(d.gain)?d.gain:1,l}function o(s){return s?Math.pow(2,s/1200):1}return j=r,j}var D,ne;function Me(){if(ne)return D;ne=1,D=function(t){return t.on=function(n,r){if(arguments.length===1&&typeof n=="function")return t.on("event",n);var e="on"+n,a=t[e];return t[e]=a?i(a,r):r,t},t};function i(t,n){return function(r,e,a,u){t(r,e,a,u),n(r,e,a,u)}}return D}var k,re;function xe(){if(re)return k;re=1;var i=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function t(){return i}var n=[0,2,4,5,7,9,11];function r(o,s,c){if(typeof o!="string")return null;var d=i.exec(o);if(!d||!s&&d[4])return null;var l={letter:d[1].toUpperCase(),acc:d[2].replace(/x/g,"##")};return l.pc=l.letter+l.acc,l.step=(l.letter.charCodeAt(0)+3)%7,l.alt=l.acc[0]==="b"?-l.acc.length:l.acc.length,l.chroma=n[l.step]+l.alt,d[3]&&(l.oct=+d[3],l.midi=l.chroma+12*(l.oct+1),l.freq=e(l.midi,c)),s&&(l.tonicOf=d[4]),l}function e(o,s){return Math.pow(2,(o-69)/12)*(s||440)}var a={parse:r,regex:t,midiToFreq:e},u=["letter","acc","pc","step","alt","chroma","oct","midi","freq"];return u.forEach(function(o){a[o]=function(s){var c=r(s);return c&&typeof c[o]<"u"?c[o]:null}}),k=a,k}var H,oe;function Le(){if(oe)return H;oe=1;var i=xe(),t=function(e){return e!==null&&e!==[]&&e>=0&&e<129},n=function(e){return t(e)?+e:i.midi(e)};H=function(e){if(e.buffers){var a=e.opts.map,u=typeof a=="function"?a:n,o=function(c){return c?u(c)||c:null};e.buffers=r(e.buffers,o);var s=e.start;e.start=function(c,d,l){var m=o(c),p=m%1;return p&&(m=Math.floor(m),l=Object.assign(l||{},{cents:Math.floor(p*100)})),s(m,d,l)}}return e};function r(e,a){return Object.keys(e).reduce(function(u,o){return u[a(o)]=e[o],u},{})}return H}var $,ie;function Ie(){if(ie)return $;ie=1;var i=Array.isArray,t=function(r){return r&&typeof r=="object"},n={};return $=function(r){return r.schedule=function(e,a){var u=r.context.currentTime,o=e<u?u:e;r.emit("schedule",o,a);var s,c,d,l;return a.map(function(m){if(m)i(m)?(s=m[0],c=m[1]):(s=m.time,c=m);else return null;return t(c)?(d=c.name||c.key||c.note||c.midi||null,l=c):(d=c,l=n),r.start(d,o+(s||0),l)})},r},$}function M(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var G={exports:{}},se;function qe(){return se||(se=1,(function(i,t){(function(n){i.exports=n()})(function(){return(function n(r,e,a){function u(c,d){if(!e[c]){if(!r[c]){var l=typeof M=="function"&&M;if(!d&&l)return l(c,!0);if(o)return o(c,!0);var m=new Error("Cannot find module '"+c+"'");throw m.code="MODULE_NOT_FOUND",m}var p=e[c]={exports:{}};r[c][0].call(p.exports,function(g){var b=r[c][1][g];return u(b||g)},p,p.exports,n,r,e,a)}return e[c].exports}for(var o=typeof M=="function"&&M,s=0;s<a.length;s++)u(a[s]);return u})({1:[function(n,r,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(a){function u(o){if(this._event=o,this._data=o.data,this.receivedTime=o.receivedTime,this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}switch(this._messageCode=o.data[0]&240,this.channel=o.data[0]&15,this._messageCode){case 128:this.messageType="noteoff",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 144:this.messageType="noteon",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 160:this.messageType="keypressure",this.key=o.data[1]&127,this.pressure=o.data[2]&127;break;case 176:this.messageType="controlchange",this.controllerNumber=o.data[1]&127,this.controllerValue=o.data[2]&127,this.controllerNumber===120&&this.controllerValue===0?this.channelModeMessage="allsoundoff":this.controllerNumber===121?this.channelModeMessage="resetallcontrollers":this.controllerNumber===122?this.controllerValue===0?this.channelModeMessage="localcontroloff":this.channelModeMessage="localcontrolon":this.controllerNumber===123&&this.controllerValue===0?this.channelModeMessage="allnotesoff":this.controllerNumber===124&&this.controllerValue===0?this.channelModeMessage="omnimodeoff":this.controllerNumber===125&&this.controllerValue===0?this.channelModeMessage="omnimodeon":this.controllerNumber===126?this.channelModeMessage="monomodeon":this.controllerNumber===127&&(this.channelModeMessage="polymodeon");break;case 192:this.messageType="programchange",this.program=o.data[1];break;case 208:this.messageType="channelpressure",this.pressure=o.data[1]&127;break;case 224:this.messageType="pitchbendchange";var s=o.data[2]&127,c=o.data[1]&127;this.pitchBend=(s<<8)+c;break}}return new u(a)},r.exports=e.default},{}]},{},[1])(1)})})(G)),G.exports}var V,ae;function Be(){if(ae)return V;ae=1;var i=qe();return V=function(t){return t.listenToMidi=function(n,r){var e={},a=r||{},u=a.gain||function(o){return o/127};return n.onmidimessage=function(o){var s=o.messageType?o:i(o);if(s.messageType==="noteon"&&s.velocity===0&&(s.messageType="noteoff"),!(a.channel&&s.channel!==a.channel))switch(s.messageType){case"noteon":e[s.key]=t.play(s.key,0,{gain:u(s.velocity)});break;case"noteoff":e[s.key]&&(e[s.key].stop(),delete e[s.key]);break}},t},t},V}var ce;function Oe(){return ce||(ce=1,(function(i){var t=Se(),n=Me(),r=Le(),e=Ie(),a=Be();function u(o,s,c){return a(e(r(n(t(o,s,c)))))}i.exports&&(i.exports=u),typeof window<"u"&&(window.SamplePlayer=u)})(F)),F.exports}function ue(i,t){return Array(t+1).join(i)}function U(i){return typeof i=="number"}function Fe(i){return typeof i=="string"}function Re(i){return typeof i<"u"}function ge(i,t){return Math.pow(2,(i-69)/12)*(t||440)}var ye=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function je(){return ye}var De=[0,2,4,5,7,9,11];function E(i,t,n){if(typeof i!="string")return null;var r=ye.exec(i);if(!r||!t&&r[4])return null;var e={letter:r[1].toUpperCase(),acc:r[2].replace(/x/g,"##")};e.pc=e.letter+e.acc,e.step=(e.letter.charCodeAt(0)+3)%7,e.alt=e.acc[0]==="b"?-e.acc.length:e.acc.length;var a=De[e.step]+e.alt;return e.chroma=a<0?12+a:a%12,r[3]&&(e.oct=+r[3],e.midi=a+12*(e.oct+1),e.freq=ge(e.midi,n)),t&&(e.tonicOf=r[4]),e}var ke="CDEFGAB";function He(i){return U(i)?i<0?ue("b",-i):ue("#",i):""}function $e(i){return U(i)?""+i:""}function be(i,t,n){return i===null||typeof i>"u"?null:i.step?be(i.step,i.alt,i.oct):i<0||i>6?null:ke.charAt(i)+He(t)+$e(n)}function we(i){if((U(i)||Fe(i))&&i>=0&&i<128)return+i;var t=E(i);return t&&Re(t.midi)?t.midi:null}function Ge(i,t){var n=we(i);return n===null?null:ge(n,t)}function Ve(i){return(E(i)||{}).letter}function Xe(i){return(E(i)||{}).acc}function Ue(i){return(E(i)||{}).pc}function ze(i){return(E(i)||{}).step}function Je(i){return(E(i)||{}).alt}function Ke(i){return(E(i)||{}).chroma}function Ye(i){return(E(i)||{}).oct}const We=Object.freeze(Object.defineProperty({__proto__:null,acc:Xe,alt:Je,build:be,chroma:Ke,freq:Ge,letter:Ve,midi:we,oct:Ye,parse:E,pc:Ue,regex:je,step:ze},Symbol.toStringTag,{value:"Module"})),Ze=Ne(We);var X,le;function Qe(){if(le)return X;le=1;var i=Ze;function t(e,a){if(console.warn("new Soundfont() is deprected"),console.log("Please use Soundfont.instrument() instead of new Soundfont().instrument()"),!(this instanceof t))return new t(e);this.nameToUrl=a||t.nameToUrl,this.ctx=e,this.instruments={},this.promises=[]}t.prototype.onready=function(e){console.warn("deprecated API"),console.log("Please use Promise.all(Soundfont.instrument(), Soundfont.instrument()).then() instead of new Soundfont().onready()"),Promise.all(this.promises).then(e)},t.prototype.instrument=function(e,a){console.warn("new Soundfont().instrument() is deprecated."),console.log("Please use Soundfont.instrument() instead.");var u=this.ctx;if(e=e||"default",e in this.instruments)return this.instruments[e];var o={name:e,play:r(u,a)};if(this.instruments[e]=o,e!=="default"){var s=t.instrument(u,e,a).then(function(c){return o.play=c.play,o});this.promises.push(s),o.onready=function(c){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),s.then(c)}}else o.onready=function(c){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),c()};return o};function n(e,a,u){return console.warn("Soundfont.loadBuffers is deprecate."),console.log("Use Soundfont.instrument(..) and get buffers properties from the result."),t.instrument(e,a,u).then(function(o){return o.buffers})}t.loadBuffers=n;function r(e,a){return a=a||{},function(u,o,s,c){console.warn("The oscillator player is deprecated."),console.log("Starting with version 0.9.0 you will have to wait until the soundfont is loaded to play sounds.");var d=u>0&&u<129?+u:i.midi(u),l=d?i.midiToFreq(d,440):null;if(l){s=s||.2,c=c||{};var m=c.destination||a.destination||e.destination,p=c.vcoType||a.vcoType||"sine",g=c.gain||a.gain||.4,b=e.createOscillator();b.type=p,b.frequency.value=l;var v=e.createGain();return v.gain.value=g,b.connect(v),v.connect(m),b.start(o),s>0&&b.stop(o+s),b}}}return t.noteToMidi=i.midi,X=t,X}var de;function et(){return de||(de=1,(function(i){var t=Ae(),n=Oe();function r(o,s,c){if(arguments.length===1)return function(g,b){return r(o,g,b)};var d=c||{},l=d.isSoundfontURL||e,m=d.nameToUrl||a,p=l(s)?s:m(s,d.soundfont,d.format);return t(o,p,{only:d.only||d.notes}).then(function(g){var b=n(o,g,d).connect(d.destination?d.destination:o.destination);return b.url=p,b.name=s,b})}function e(o){return/\.js(\?.*)?$/i.test(o)}function a(o,s,c){return c=c==="ogg"?c:"mp3",s=s==="FluidR3_GM"?s:"MusyngKite","https://gleitz.github.io/midi-js-soundfonts/"+s+"/"+o+"-"+c+".js"}var u=Qe();u.instrument=r,u.nameToUrl=a,i.exports&&(i.exports=u),typeof window<"u"&&(window.Soundfont=u)})(I)),I.exports}var tt=et();const fe=_e(tt),nt=new Set(["drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synthstrings_1","synthstrings_2","choir_aahs","voice_oohs","synth_voice","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep"]);class rt{instrument=null;activeNotes=new Map;ready=!1;audioContext=null;currentInstrumentName="";async initialize(t="electric_piano_1"){try{this.audioContext=new AudioContext,this.instrument=await fe.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=t,this.ready=!0,console.log(`Audio service initialized with ${t}`)}catch(n){throw console.error("Failed to initialize audio service:",n),n}}async changeInstrument(t){try{this.stopAllNotes(),this.ready=!1,this.audioContext||(this.audioContext=new AudioContext),this.instrument=await fe.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=t,this.ready=!0,console.log(`Changed instrument to ${t}`)}catch(n){throw console.error("Failed to change instrument:",n),n}}playNote(t){if(!this.instrument||!this.ready){console.warn("Audio service not ready");return}if(this.activeNotes.has(t))return;const n=nt.has(this.currentInstrumentName),r={gain:2,loop:n};n&&(r.loopStart=.3,r.loopEnd=2.5);const e=this.instrument.play(t,0,r);this.activeNotes.set(t,e)}stopNote(t){const n=this.activeNotes.get(t);n&&(n.stop(),this.activeNotes.delete(t))}stopAllNotes(){this.activeNotes.forEach(t=>t.stop()),this.activeNotes.clear()}isReady(){return this.ready}setPitchBend(t,n){const r=this.activeNotes.get(t);if(r)try{r.source&&r.source.detune&&(r.source.detune.value=n)}catch(e){console.warn("Failed to apply pitch bend:",e)}}}const P=new rt;class ot{container;activeButtons=new Set;showLabels=!0;currentPreset=null;dragStartX=new Map;noteToTouchId=new Map;touchIdToNote=new Map;mouseControlledNote=null;mouseControlledPosition=null;touchIdToPosition=new Map;buttonPositions=new Map;documentMouseMoveHandler=null;documentMouseUpHandler=null;documentTouchMoveHandler=null;documentTouchEndHandler=null;documentTouchCancelHandler=null;constructor(t){const n=document.getElementById(t);if(!n)throw new Error(`Container element with id "${t}" not found`);this.container=n,this.setupDocumentEventListeners()}isFormControl(t){if(!t||!(t instanceof HTMLElement))return!1;const n=t.tagName.toLowerCase();return n==="select"||n==="input"||n==="textarea"||n==="label"||t.closest("select, input, textarea, label")!==null}getButtonAtPoint(t,n){const r=document.elementFromPoint(t,n);if(r&&r.classList.contains("pad-button")){const e=r.getAttribute("data-note"),a=r.getAttribute("data-position");if(e&&a){const u=this.buttonPositions.get(a);if(u)return{button:r,note:e,position:u}}}return null}isImmediatelyAdjacent(t,n){return t.col===n.col&&Math.abs(t.row-n.row)===1}setupDocumentEventListeners(){this.documentMouseMoveHandler=t=>{t.preventDefault();const n=this.getButtonAtPoint(t.clientX,t.clientY);if(this.mouseControlledNote&&this.mouseControlledPosition)if(n&&(n.note!==this.mouseControlledNote||n.position.row!==this.mouseControlledPosition.row||n.position.col!==this.mouseControlledPosition.col)&&this.isImmediatelyAdjacent(this.mouseControlledPosition,n.position)){const r=this.dragStartX.get(this.mouseControlledNote);this.handleNoteEnd(this.mouseControlledNote),this.handleNoteStart(n.note,n.button,t.clientX,void 0,!0,n.position),r!==void 0&&this.dragStartX.set(n.note,r),this.mouseControlledNote=n.note,this.mouseControlledPosition=n.position}else(n||this.mouseControlledNote)&&this.handleDrag(this.mouseControlledNote,t.clientX)},this.documentMouseUpHandler=t=>{t.preventDefault(),this.mouseControlledNote&&(this.handleNoteEnd(this.mouseControlledNote),this.mouseControlledNote=null,this.mouseControlledPosition=null)},this.documentTouchMoveHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.touches.length;n++){const r=t.touches[n],e=this.touchIdToNote.get(r.identifier),a=this.touchIdToPosition.get(r.identifier);if(e&&a){const u=this.getButtonAtPoint(r.clientX,r.clientY);if(u&&(u.note!==e||u.position.row!==a.row||u.position.col!==a.col)&&this.isImmediatelyAdjacent(a,u.position)){const o=this.dragStartX.get(e);this.handleNoteEnd(e,r.identifier),this.handleNoteStart(u.note,u.button,r.clientX,r.identifier,!0,u.position),o!==void 0&&this.dragStartX.set(u.note,o)}else this.activeButtons.has(e)&&this.handleDrag(e,r.clientX,r.identifier)}}},this.documentTouchEndHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&(this.handleNoteEnd(e,r.identifier),this.touchIdToPosition.delete(r.identifier))}},this.documentTouchCancelHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&(this.handleNoteEnd(e,r.identifier),this.touchIdToPosition.delete(r.identifier))}},document.addEventListener("mousemove",this.documentMouseMoveHandler),document.addEventListener("mouseup",this.documentMouseUpHandler),document.addEventListener("touchmove",this.documentTouchMoveHandler,{passive:!1}),document.addEventListener("touchend",this.documentTouchEndHandler,{passive:!1}),document.addEventListener("touchcancel",this.documentTouchCancelHandler,{passive:!1})}setShowLabels(t){this.showLabels=t,this.currentPreset&&this.render(this.currentPreset)}render(t){this.currentPreset=t,this.activeButtons.clear(),this.buttonPositions.clear(),this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateRows=`repeat(${t.rows}, 1fr)`,this.container.style.gridTemplateColumns=`repeat(${t.cols}, 1fr)`;const n=t.rows>10||t.cols>10?"2px":"6px";this.container.style.gap=n,this.container.style.width="100%",this.container.style.height="100%";const r=t.rows>10||t.cols>10?"8px":"16px";this.container.style.padding=r,t.buttons.forEach(e=>{const a=this.createButton(e);this.container.appendChild(a)})}createButton(t){const n=document.createElement("button");n.className="pad-button",n.textContent=this.showLabels?t.label||t.note:"",n.dataset.note=t.note;const r=`${t.row}-${t.col}`;return n.dataset.position=r,this.buttonPositions.set(r,{row:t.row,col:t.col}),t.color&&(n.style.backgroundColor=t.color),n.style.gridRow=`${t.row+1}`,n.style.gridColumn=`${t.col+1}`,n.addEventListener("mousedown",e=>{e.preventDefault(),this.handleNoteStart(t.note,n,e.clientX,void 0,!1,{row:t.row,col:t.col})}),n.addEventListener("touchstart",e=>{if(e.preventDefault(),e.changedTouches.length>0){const a=e.changedTouches[0];this.handleNoteStart(t.note,n,a.clientX,a.identifier,!1,{row:t.row,col:t.col})}}),n}handleNoteStart(t,n,r,e,a=!1,u){if(!P.isReady()){console.warn("Audio service not ready");return}this.activeButtons.has(t)||(this.activeButtons.add(t),n.classList.add("active"),P.playNote(t),a||this.dragStartX.set(t,r),e!==void 0&&u?(this.noteToTouchId.set(t,e),this.touchIdToNote.set(e,t),this.touchIdToPosition.set(e,u)):u&&(this.mouseControlledNote=t,this.mouseControlledPosition=u))}handleDrag(t,n,r){if(r!==void 0&&this.noteToTouchId.get(t)!==r)return;const e=this.dragStartX.get(t);if(e===void 0)return;const a=n-e,u=window.innerWidth,o=1200,s=a/u*o,c=Math.max(-o,Math.min(o,s));P.setPitchBend(t,c)}handleNoteEnd(t,n){n!==void 0&&this.noteToTouchId.get(t)!==n||this.activeButtons.has(t)&&(this.activeButtons.delete(t),this.container.querySelectorAll(`[data-note="${t}"]`).forEach(e=>{e.classList.remove("active")}),P.stopNote(t),this.dragStartX.delete(t),n!==void 0?(this.noteToTouchId.delete(t),this.touchIdToNote.delete(n)):this.mouseControlledNote===t&&(this.mouseControlledNote=null))}stopAll(){this.activeButtons.clear(),P.stopAllNotes(),this.container.querySelectorAll(".pad-button").forEach(n=>n.classList.remove("active"))}destroy(){this.documentMouseMoveHandler&&document.removeEventListener("mousemove",this.documentMouseMoveHandler),this.documentMouseUpHandler&&document.removeEventListener("mouseup",this.documentMouseUpHandler),this.documentTouchMoveHandler&&document.removeEventListener("touchmove",this.documentTouchMoveHandler),this.documentTouchEndHandler&&document.removeEventListener("touchend",this.documentTouchEndHandler),this.documentTouchCancelHandler&&document.removeEventListener("touchcancel",this.documentTouchCancelHandler),this.stopAll()}}class it{container;config;onPresetChange;currentPresetId;constructor(t,n,r){const e=document.getElementById(t);if(!e)throw new Error(`Container element with id "${t}" not found`);this.container=e,this.config=n,this.onPresetChange=r,this.currentPresetId=n.defaultPresetId}render(){this.container.innerHTML="";const t=document.createElement("label");t.textContent="Layout: ",t.htmlFor="preset-select";const n=document.createElement("select");n.id="preset-select",n.className="preset-select",this.config.presets.forEach(r=>{const e=document.createElement("option");e.value=r.id,e.textContent=r.name,e.selected=r.id===this.currentPresetId,n.appendChild(e)}),n.addEventListener("change",r=>{const a=r.target.value;this.selectPreset(a)}),this.container.appendChild(t),this.container.appendChild(n)}selectPreset(t){const n=this.config.presets.find(r=>r.id===t);n?(this.currentPresetId=t,this.onPresetChange(n)):console.error(`Preset with id "${t}" not found`)}getCurrentPreset(){return this.config.presets.find(t=>t.id===this.currentPresetId)}}function z(i){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=i.match(/^([A-G]#?)(\d+)$/);if(!n)throw new Error(`Invalid note name: ${i}`);const[,r,e]=n,a=parseInt(e),u=t.indexOf(r);if(u===-1)throw new Error(`Invalid note name: ${i}`);return(a+1)*12+u}function J(i){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(i/12)-1,r=i%12;return`${t[r]}${n}`}function K(i,t){const n=i.includes("#"),e={0:0,1:0,2:0,3:30,4:60,5:150,6:180,7:240,8:280,9:280}[t]??240;return n?`hsl(${e}, 25%, 28%)`:`hsl(${e}, 30%, 35%)`}function he(i="C4"){const t=[],n=z(i),r=24;for(let e=0;e<r;e++){const a=Math.floor(e/6),u=e%6,o=n+e,s=J(o),c=parseInt(s.match(/\d+/)?.[0]??"4"),d=s.replace(/\d+/,"");t.push({row:a,col:u,note:s,label:s,color:K(d,c)})}return t}function me(i="C2"){const t=[],n=z(i);for(let r=0;r<16;r++)for(let e=0;e<19;e++){const a=n+e*2+r,u=J(a),o=parseInt(u.match(/\d+/)?.[0]??"4"),s=u.replace(/\d+/,""),c=K(s,o);t.push({row:15-r,col:e,note:u,label:u,color:c})}return t}function pe(i="C3"){const t=[],n=z(i);for(let r=0;r<12;r++)for(let e=0;e<15;e++){const a=n+e*2+r,u=J(a),o=parseInt(u.match(/\d+/)?.[0]??"4"),s=u.replace(/\d+/,""),c=K(s,o);t.push({row:11-r,col:e,note:u,label:u,color:c})}return t}const ve={presets:[{id:"chromatic",name:"Chromatic Scale",rows:4,cols:6,defaultLowestNote:"C4",buttons:he("C4")},{id:"harpejji",name:"Harpejji",rows:16,cols:19,defaultLowestNote:"C2",buttons:me("C2")},{id:"harpejji-compact",name:"Harpejji Compact",rows:12,cols:15,defaultLowestNote:"C3",buttons:pe("C3")}],defaultPresetId:"chromatic",updateLowestNote(i){this.presets[0].buttons=he(i),this.presets[1].buttons=me(i),this.presets[2].buttons=pe(i)}},st="1.0.1";async function at(){const i=document.getElementById("app");if(!i)throw new Error("App container not found");i.classList.add("loading");const t=document.getElementById("header");if(t){const r=document.createElement("div");r.id="loading-message",r.textContent="Loading audio...",t.appendChild(r)}const n=t?.querySelector("h1");if(n){const r=document.createElement("span");r.className="version",r.textContent=`v${st}`,n.appendChild(r)}try{await P.initialize("electric_piano_1");const r=document.getElementById("loading-message");r&&r.remove(),i.classList.remove("loading");const e=new ot("grid-container"),a=document.getElementById("instrument-selector");if(a){const d=document.createElement("label");d.textContent="Instrument: ",d.htmlFor="instrument-select";const l=document.createElement("select");l.id="instrument-select",l.className="preset-select",[{value:"electric_piano_1",name:"Electric Piano (Rhodes)"},{value:"electric_piano_2",name:"Electric Piano (DX7)"},{value:"acoustic_grand_piano",name:"Acoustic Grand Piano"},{value:"bright_acoustic_piano",name:"Bright Acoustic Piano"},{value:"electric_grand_piano",name:"Electric Grand Piano"},{value:"honky_tonk_piano",name:"Honky-Tonk Piano"},{value:"vibraphone",name:"Vibraphone"},{value:"marimba",name:"Marimba"},{value:"xylophone",name:"Xylophone"},{value:"harpsichord",name:"Harpsichord"},{value:"clavinet",name:"Clavinet"},{value:"drawbar_organ",name:"Drawbar Organ"},{value:"percussive_organ",name:"Percussive Organ"},{value:"rock_organ",name:"Rock Organ"},{value:"church_organ",name:"Church Organ"},{value:"reed_organ",name:"Reed Organ"},{value:"acoustic_guitar_nylon",name:"Acoustic Guitar (Nylon)"},{value:"acoustic_guitar_steel",name:"Acoustic Guitar (Steel)"},{value:"electric_guitar_jazz",name:"Electric Guitar (Jazz)"},{value:"electric_guitar_clean",name:"Electric Guitar (Clean)"},{value:"electric_guitar_muted",name:"Electric Guitar (Muted)"},{value:"overdriven_guitar",name:"Overdriven Guitar"},{value:"distortion_guitar",name:"Distortion Guitar"}].forEach(p=>{const g=document.createElement("option");g.value=p.value,g.textContent=p.name,g.selected=p.value==="electric_piano_1",l.appendChild(g)}),l.addEventListener("change",async p=>{const b=p.target.value;l.disabled=!0,e.stopAll();try{await P.changeInstrument(b),l.disabled=!1}catch(v){console.error("Failed to change instrument:",v),l.disabled=!1}}),a.appendChild(d),a.appendChild(l)}const u=document.getElementById("lowest-note-selector");if(u){const d=document.createElement("label");d.textContent="Lowest Note: ",d.htmlFor="lowest-note-select";const l=document.createElement("select");l.id="lowest-note-select",l.className="preset-select",["G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4"].forEach(p=>{const g=document.createElement("option");g.value=p,g.textContent=p,g.selected=p==="C2",l.appendChild(g)}),l.addEventListener("change",p=>{const b=p.target.value;ve.updateLowestNote(b);const v=s.getCurrentPreset();v&&(e.stopAll(),e.render(v))}),u.appendChild(d),u.appendChild(l)}const o=document.getElementById("labels-toggle");if(o){const d=document.createElement("input");d.type="checkbox",d.id="show-labels",d.checked=!0;const l=document.createElement("label");l.htmlFor="show-labels",l.textContent="Show note names",d.addEventListener("change",m=>{const p=m.target;e.setShowLabels(p.checked)}),o.appendChild(d),o.appendChild(l)}const s=new it("preset-selector",ve,d=>{e.stopAll();const l=document.getElementById("lowest-note-select");l&&(l.value=d.defaultLowestNote),e.render(d)});s.render();const c=s.getCurrentPreset();if(c){const d=document.getElementById("lowest-note-select");d&&(d.value=c.defaultLowestNote),e.render(c)}console.log("Music Touchpad initialized successfully!")}catch(r){console.error("Failed to initialize app:",r);const e=document.createElement("div");e.className="error-message",e.textContent="Failed to load audio. Please refresh the page.",i.appendChild(e)}}at();

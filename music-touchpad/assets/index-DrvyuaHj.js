(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(e){if(e.ep)return;e.ep=!0;const s=n(e);fetch(e.href,s)}})();function ve(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function ge(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var t=i.default;if(typeof t=="function"){var n=function r(){var e=!1;try{e=this instanceof r}catch{}return e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(i).forEach(function(r){var e=Object.getOwnPropertyDescriptor(i,r);Object.defineProperty(n,r,e.get?e:{enumerable:!0,get:function(){return i[r]}})}),n}var q={exports:{}},I={exports:{}},O,K;function ye(){if(K)return O;K=1;function i(n){return n>64&&n<91?n-65:n>96&&n<123?n-71:n>47&&n<58?n+4:n===43?62:n===47?63:0}function t(n,r){for(var e=n.replace(/[^A-Za-z0-9\+\/]/g,""),s=e.length,c=r?Math.ceil((s*3+1>>2)/r)*r:s*3+1>>2,o=new Uint8Array(c),a,u,l=0,d=0,h=0;h<s;h++)if(u=h&3,l|=i(e.charCodeAt(h))<<18-6*u,u===3||s-h===1){for(a=0;a<3&&d<c;a++,d++)o[d]=l>>>(16>>>a&24)&255;l=0}return o}return O={decode:t},O}var R,Y;function be(){return Y||(Y=1,R=function(i,t){return new Promise(function(n,r){var e=new XMLHttpRequest;t&&(e.responseType=t),e.open("GET",i),e.onload=function(){e.status===200?n(e.response):r(Error(e.statusText))},e.onerror=function(){r(Error("Network Error"))},e.send()})}),R}var W;function we(){return W||(W=1,(function(i){var t=ye(),n=be();function r(m){return function(f){return typeof f=="string"&&m.test(f)}}function e(m,f){return typeof m=="string"?m+f:typeof m=="function"?m(f):f}function s(m,f,w,E){var M=c(f)?o:a(f)?u:l(f)?d:h(f)?p:T(f)?y:v(f)?x:L(f)?_:g(f)?N:null,C=w||{};return M?M(m,f,C):E?Promise.resolve(E):Promise.reject("Source not valid ("+f+")")}s.fetch=n;function c(m){return m instanceof ArrayBuffer}function o(m,f,w){return new Promise(function(E,M){m.decodeAudioData(f,function(C){E(C)},function(){M("Can't decode audio data ("+f.slice(0,30)+"...)")})})}var a=r(/\.(mp3|wav|ogg)(\?.*)?$/i);function u(m,f,w){var E=e(w.from,f);return s(m,s.fetch(E,"arraybuffer"),w)}function l(m){return m&&typeof m.then=="function"}function d(m,f,w){return f.then(function(E){return s(m,E,w)})}var h=Array.isArray;function p(m,f,w){return Promise.all(f.map(function(E){return s(m,E,w,E)}))}function T(m){return m&&typeof m=="object"}function y(m,f,w){var E={},M=Object.keys(f).map(function(C){if(w.only&&w.only.indexOf(C)===-1)return null;var J=f[C];return s(m,J,w,J).then(function(pe){E[C]=pe})});return Promise.all(M).then(function(){return E})}var v=r(/\.json(\?.*)?$/i);function x(m,f,w){var E=e(w.from,f);return s(m,s.fetch(E,"text").then(JSON.parse),w)}var L=r(/^data:audio/);function _(m,f,w){var E=f.indexOf(",");return s(m,t.decode(f.slice(E+1)).buffer,w)}var g=r(/\.js(\?.*)?$/i);function N(m,f,w){var E=e(w.from,f);return s(m,s.fetch(E,"text").then(b),w)}function b(m){var f=m.indexOf("MIDI.Soundfont.");if(f<0)throw Error("Invalid MIDI.js Soundfont format");f=m.indexOf("=",f)+2;var w=m.lastIndexOf(",");return JSON.parse(m.slice(f,w)+"}")}i.exports&&(i.exports=s),typeof window<"u"&&(window.loadAudio=s)})(I)),I.exports}var B={exports:{}},F,Z;function Te(){if(Z)return F;Z=1,F=i;function i(o){var a=o.createGain(),u=a._voltage=r(o),l=e(u),d=e(u),h=e(u);return a._startAmount=e(d),a._endAmount=e(h),a._multiplier=e(l),a._multiplier.connect(a),a._startAmount.connect(a),a._endAmount.connect(a),a.value=l.gain,a.startValue=d.gain,a.endValue=h.gain,a.startValue.value=0,a.endValue.value=0,Object.defineProperties(a,t),a}var t={attack:{value:0,writable:!0},decay:{value:0,writable:!0},sustain:{value:1,writable:!0},release:{value:0,writable:!0},getReleaseDuration:{value:function(){return this.release}},start:{value:function(o){var a=this._multiplier.gain,u=this._startAmount.gain,l=this._endAmount.gain;this._voltage.start(o),this._decayFrom=this._decayFrom=o+this.attack,this._startedAt=o;var d=this.sustain;a.cancelScheduledValues(o),u.cancelScheduledValues(o),l.cancelScheduledValues(o),l.setValueAtTime(0,o),this.attack?(a.setValueAtTime(0,o),a.linearRampToValueAtTime(1,o+this.attack),u.setValueAtTime(1,o),u.linearRampToValueAtTime(0,o+this.attack)):(a.setValueAtTime(1,o),u.setValueAtTime(0,o)),this.decay&&a.setTargetAtTime(d,this._decayFrom,s(this.decay))}},stop:{value:function(o,a){a&&(o=o-this.release);var u=o+this.release;if(this.release){var l=this._multiplier.gain,d=this._startAmount.gain,h=this._endAmount.gain;l.cancelScheduledValues(o),d.cancelScheduledValues(o),h.cancelScheduledValues(o);var p=s(this.release);if(this.attack&&o<this._decayFrom){var T=c(0,1,this._startedAt,this._decayFrom,o);l.linearRampToValueAtTime(T,o),d.linearRampToValueAtTime(1-T,o),d.setTargetAtTime(0,o,p)}h.setTargetAtTime(1,o,p),l.setTargetAtTime(0,o,p)}return this._voltage.stop(u),u}},onended:{get:function(){return this._voltage.onended},set:function(o){this._voltage.onended=o}}},n=new Float32Array([1,1]);function r(o){var a=o.createBufferSource(),u=o.createBuffer(1,2,o.sampleRate);return u.getChannelData(0).set(n),a.buffer=u,a.loop=!0,a}function e(o){var a=o.context.createGain();return o.connect(a),a}function s(o){return Math.log(o+1)/Math.log(100)}function c(o,a,u,l,d){var h=a-o,p=l-u,T=d-u,y=T/p,v=o+y*h;return v<=o&&(v=o),v>=a&&(v=a),v}return F}var j,Q;function _e(){if(Q)return j;Q=1;var i=Te(),t={},n={gain:1,attack:.01,decay:.1,sustain:.9,release:.3,loop:!1,cents:0,loopStart:0,loopEnd:0};function r(a,u,l){var d=!1,h=0,p={},T=a.createGain();T.gain.value=1;var y=Object.assign({},n,l),v={context:a,out:T,opts:y};return u instanceof AudioBuffer?v.buffer=u:v.buffers=u,v.start=function(_,g,N){if(v.buffer&&_!==null)return v.start(null,_,g);var b=_?v.buffers[_]:v.buffer;if(b){if(!d){console.warn("SamplePlayer not connected to any node.");return}}else{console.warn("Buffer "+_+" not found.");return}var m=N||t;g=Math.max(a.currentTime,g||0),v.emit("start",g,_,m);var f=L(_,b,m);return f.id=x(_,f),f.env.start(g),f.source.start(g),v.emit("started",g,f.id,f),m.duration&&f.stop(g+m.duration),f},v.play=function(_,g,N){return v.start(_,g,N)},v.stop=function(_,g){var N;return g=g||Object.keys(p),g.map(function(b){return N=p[b],N?(N.stop(_),N.id):null})},v.connect=function(_){return d=!0,T.connect(_),v},v.emit=function(_,g,N,b){v.onevent&&v.onevent(_,g,N,b);var m=v["on"+_];m&&m(g,N,b)},v;function x(_,g){return g.id=h++,p[g.id]=g,g.source.onended=function(){var N=a.currentTime;g.source.disconnect(),g.env.disconnect(),g.disconnect(),v.emit("ended",N,g.id,g)},g.id}function L(_,g,N){var b=a.createGain();return b.gain.value=0,b.connect(T),b.env=c(a,N,y),b.env.connect(b.gain),b.source=a.createBufferSource(),b.source.buffer=g,b.source.connect(b),b.source.loop=N.loop||y.loop,b.source.playbackRate.value=o(N.cents||y.cents),b.source.loopStart=N.loopStart||y.loopStart,b.source.loopEnd=N.loopEnd||y.loopEnd,b.stop=function(m){var f=m||a.currentTime;v.emit("stop",f,_);var w=b.env.stop(f);b.source.stop(w)},b}}function e(a){return typeof a=="number"}var s=["attack","decay","sustain","release"];function c(a,u,l){var d=i(a),h=u.adsr||l.adsr;return s.forEach(function(p,T){h?d[p]=h[T]:d[p]=u[p]||l[p]}),d.value.value=e(u.gain)?u.gain:e(l.gain)?l.gain:1,d}function o(a){return a?Math.pow(2,a/1200):1}return j=r,j}var D,ee;function Ne(){if(ee)return D;ee=1,D=function(t){return t.on=function(n,r){if(arguments.length===1&&typeof n=="function")return t.on("event",n);var e="on"+n,s=t[e];return t[e]=s?i(s,r):r,t},t};function i(t,n){return function(r,e,s,c){t(r,e,s,c),n(r,e,s,c)}}return D}var k,te;function Ee(){if(te)return k;te=1;var i=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function t(){return i}var n=[0,2,4,5,7,9,11];function r(o,a,u){if(typeof o!="string")return null;var l=i.exec(o);if(!l||!a&&l[4])return null;var d={letter:l[1].toUpperCase(),acc:l[2].replace(/x/g,"##")};return d.pc=d.letter+d.acc,d.step=(d.letter.charCodeAt(0)+3)%7,d.alt=d.acc[0]==="b"?-d.acc.length:d.acc.length,d.chroma=n[d.step]+d.alt,l[3]&&(d.oct=+l[3],d.midi=d.chroma+12*(d.oct+1),d.freq=e(d.midi,u)),a&&(d.tonicOf=l[4]),d}function e(o,a){return Math.pow(2,(o-69)/12)*(a||440)}var s={parse:r,regex:t,midiToFreq:e},c=["letter","acc","pc","step","alt","chroma","oct","midi","freq"];return c.forEach(function(o){s[o]=function(a){var u=r(a);return u&&typeof u[o]<"u"?u[o]:null}}),k=s,k}var H,ne;function Ae(){if(ne)return H;ne=1;var i=Ee(),t=function(e){return e!==null&&e!==[]&&e>=0&&e<129},n=function(e){return t(e)?+e:i.midi(e)};H=function(e){if(e.buffers){var s=e.opts.map,c=typeof s=="function"?s:n,o=function(u){return u?c(u)||u:null};e.buffers=r(e.buffers,o);var a=e.start;e.start=function(u,l,d){var h=o(u),p=h%1;return p&&(h=Math.floor(h),d=Object.assign(d||{},{cents:Math.floor(p*100)})),a(h,l,d)}}return e};function r(e,s){return Object.keys(e).reduce(function(c,o){return c[s(o)]=e[o],c},{})}return H}var $,re;function Ce(){if(re)return $;re=1;var i=Array.isArray,t=function(r){return r&&typeof r=="object"},n={};return $=function(r){return r.schedule=function(e,s){var c=r.context.currentTime,o=e<c?c:e;r.emit("schedule",o,s);var a,u,l,d;return s.map(function(h){if(h)i(h)?(a=h[0],u=h[1]):(a=h.time,u=h);else return null;return t(u)?(l=u.name||u.key||u.note||u.midi||null,d=u):(l=u,d=n),r.start(l,o+(a||0),d)})},r},$}function S(i){throw new Error('Could not dynamically require "'+i+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var G={exports:{}},oe;function Pe(){return oe||(oe=1,(function(i,t){(function(n){i.exports=n()})(function(){return(function n(r,e,s){function c(u,l){if(!e[u]){if(!r[u]){var d=typeof S=="function"&&S;if(!l&&d)return d(u,!0);if(o)return o(u,!0);var h=new Error("Cannot find module '"+u+"'");throw h.code="MODULE_NOT_FOUND",h}var p=e[u]={exports:{}};r[u][0].call(p.exports,function(T){var y=r[u][1][T];return c(y||T)},p,p.exports,n,r,e,s)}return e[u].exports}for(var o=typeof S=="function"&&S,a=0;a<s.length;a++)c(s[a]);return c})({1:[function(n,r,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(s){function c(o){if(this._event=o,this._data=o.data,this.receivedTime=o.receivedTime,this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}switch(this._messageCode=o.data[0]&240,this.channel=o.data[0]&15,this._messageCode){case 128:this.messageType="noteoff",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 144:this.messageType="noteon",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 160:this.messageType="keypressure",this.key=o.data[1]&127,this.pressure=o.data[2]&127;break;case 176:this.messageType="controlchange",this.controllerNumber=o.data[1]&127,this.controllerValue=o.data[2]&127,this.controllerNumber===120&&this.controllerValue===0?this.channelModeMessage="allsoundoff":this.controllerNumber===121?this.channelModeMessage="resetallcontrollers":this.controllerNumber===122?this.controllerValue===0?this.channelModeMessage="localcontroloff":this.channelModeMessage="localcontrolon":this.controllerNumber===123&&this.controllerValue===0?this.channelModeMessage="allnotesoff":this.controllerNumber===124&&this.controllerValue===0?this.channelModeMessage="omnimodeoff":this.controllerNumber===125&&this.controllerValue===0?this.channelModeMessage="omnimodeon":this.controllerNumber===126?this.channelModeMessage="monomodeon":this.controllerNumber===127&&(this.channelModeMessage="polymodeon");break;case 192:this.messageType="programchange",this.program=o.data[1];break;case 208:this.messageType="channelpressure",this.pressure=o.data[1]&127;break;case 224:this.messageType="pitchbendchange";var a=o.data[2]&127,u=o.data[1]&127;this.pitchBend=(a<<8)+u;break}}return new c(s)},r.exports=e.default},{}]},{},[1])(1)})})(G)),G.exports}var V,ie;function Me(){if(ie)return V;ie=1;var i=Pe();return V=function(t){return t.listenToMidi=function(n,r){var e={},s=r||{},c=s.gain||function(o){return o/127};return n.onmidimessage=function(o){var a=o.messageType?o:i(o);if(a.messageType==="noteon"&&a.velocity===0&&(a.messageType="noteoff"),!(s.channel&&a.channel!==s.channel))switch(a.messageType){case"noteon":e[a.key]=t.play(a.key,0,{gain:c(a.velocity)});break;case"noteoff":e[a.key]&&(e[a.key].stop(),delete e[a.key]);break}},t},t},V}var ae;function Se(){return ae||(ae=1,(function(i){var t=_e(),n=Ne(),r=Ae(),e=Ce(),s=Me();function c(o,a,u){return s(e(r(n(t(o,a,u)))))}i.exports&&(i.exports=c),typeof window<"u"&&(window.SamplePlayer=c)})(B)),B.exports}function se(i,t){return Array(t+1).join(i)}function U(i){return typeof i=="number"}function xe(i){return typeof i=="string"}function Le(i){return typeof i<"u"}function de(i,t){return Math.pow(2,(i-69)/12)*(t||440)}var fe=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function qe(){return fe}var Ie=[0,2,4,5,7,9,11];function A(i,t,n){if(typeof i!="string")return null;var r=fe.exec(i);if(!r||!t&&r[4])return null;var e={letter:r[1].toUpperCase(),acc:r[2].replace(/x/g,"##")};e.pc=e.letter+e.acc,e.step=(e.letter.charCodeAt(0)+3)%7,e.alt=e.acc[0]==="b"?-e.acc.length:e.acc.length;var s=Ie[e.step]+e.alt;return e.chroma=s<0?12+s:s%12,r[3]&&(e.oct=+r[3],e.midi=s+12*(e.oct+1),e.freq=de(e.midi,n)),t&&(e.tonicOf=r[4]),e}var Oe="CDEFGAB";function Re(i){return U(i)?i<0?se("b",-i):se("#",i):""}function Be(i){return U(i)?""+i:""}function he(i,t,n){return i===null||typeof i>"u"?null:i.step?he(i.step,i.alt,i.oct):i<0||i>6?null:Oe.charAt(i)+Re(t)+Be(n)}function me(i){if((U(i)||xe(i))&&i>=0&&i<128)return+i;var t=A(i);return t&&Le(t.midi)?t.midi:null}function Fe(i,t){var n=me(i);return n===null?null:de(n,t)}function je(i){return(A(i)||{}).letter}function De(i){return(A(i)||{}).acc}function ke(i){return(A(i)||{}).pc}function He(i){return(A(i)||{}).step}function $e(i){return(A(i)||{}).alt}function Ge(i){return(A(i)||{}).chroma}function Ve(i){return(A(i)||{}).oct}const Xe=Object.freeze(Object.defineProperty({__proto__:null,acc:De,alt:$e,build:he,chroma:Ge,freq:Fe,letter:je,midi:me,oct:Ve,parse:A,pc:ke,regex:qe,step:He},Symbol.toStringTag,{value:"Module"})),Ue=ge(Xe);var X,ue;function ze(){if(ue)return X;ue=1;var i=Ue;function t(e,s){if(console.warn("new Soundfont() is deprected"),console.log("Please use Soundfont.instrument() instead of new Soundfont().instrument()"),!(this instanceof t))return new t(e);this.nameToUrl=s||t.nameToUrl,this.ctx=e,this.instruments={},this.promises=[]}t.prototype.onready=function(e){console.warn("deprecated API"),console.log("Please use Promise.all(Soundfont.instrument(), Soundfont.instrument()).then() instead of new Soundfont().onready()"),Promise.all(this.promises).then(e)},t.prototype.instrument=function(e,s){console.warn("new Soundfont().instrument() is deprecated."),console.log("Please use Soundfont.instrument() instead.");var c=this.ctx;if(e=e||"default",e in this.instruments)return this.instruments[e];var o={name:e,play:r(c,s)};if(this.instruments[e]=o,e!=="default"){var a=t.instrument(c,e,s).then(function(u){return o.play=u.play,o});this.promises.push(a),o.onready=function(u){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),a.then(u)}}else o.onready=function(u){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),u()};return o};function n(e,s,c){return console.warn("Soundfont.loadBuffers is deprecate."),console.log("Use Soundfont.instrument(..) and get buffers properties from the result."),t.instrument(e,s,c).then(function(o){return o.buffers})}t.loadBuffers=n;function r(e,s){return s=s||{},function(c,o,a,u){console.warn("The oscillator player is deprecated."),console.log("Starting with version 0.9.0 you will have to wait until the soundfont is loaded to play sounds.");var l=c>0&&c<129?+c:i.midi(c),d=l?i.midiToFreq(l,440):null;if(d){a=a||.2,u=u||{};var h=u.destination||s.destination||e.destination,p=u.vcoType||s.vcoType||"sine",T=u.gain||s.gain||.4,y=e.createOscillator();y.type=p,y.frequency.value=d;var v=e.createGain();return v.gain.value=T,y.connect(v),v.connect(h),y.start(o),a>0&&y.stop(o+a),y}}}return t.noteToMidi=i.midi,X=t,X}var ce;function Je(){return ce||(ce=1,(function(i){var t=we(),n=Se();function r(o,a,u){if(arguments.length===1)return function(T,y){return r(o,T,y)};var l=u||{},d=l.isSoundfontURL||e,h=l.nameToUrl||s,p=d(a)?a:h(a,l.soundfont,l.format);return t(o,p,{only:l.only||l.notes}).then(function(T){var y=n(o,T,l).connect(l.destination?l.destination:o.destination);return y.url=p,y.name=a,y})}function e(o){return/\.js(\?.*)?$/i.test(o)}function s(o,a,u){return u=u==="ogg"?u:"mp3",a=a==="FluidR3_GM"?a:"MusyngKite","https://gleitz.github.io/midi-js-soundfonts/"+a+"/"+o+"-"+u+".js"}var c=ze();c.instrument=r,c.nameToUrl=s,i.exports&&(i.exports=c),typeof window<"u"&&(window.Soundfont=c)})(q)),q.exports}var Ke=Je();const le=ve(Ke),Ye=new Set(["drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synthstrings_1","synthstrings_2","choir_aahs","voice_oohs","synth_voice","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep"]);class We{instrument=null;activeNotes=new Map;ready=!1;audioContext=null;currentInstrumentName="";async initialize(t="electric_piano_1"){try{this.audioContext=new AudioContext,this.instrument=await le.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=t,this.ready=!0,console.log(`Audio service initialized with ${t}`)}catch(n){throw console.error("Failed to initialize audio service:",n),n}}async changeInstrument(t){try{this.stopAllNotes(),this.ready=!1,this.audioContext||(this.audioContext=new AudioContext),this.instrument=await le.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=t,this.ready=!0,console.log(`Changed instrument to ${t}`)}catch(n){throw console.error("Failed to change instrument:",n),n}}playNote(t){if(!this.instrument||!this.ready){console.warn("Audio service not ready");return}if(this.activeNotes.has(t))return;const n=Ye.has(this.currentInstrumentName),r={gain:2,loop:n};n&&(r.loopStart=.3,r.loopEnd=2.5);const e=this.instrument.play(t,0,r);this.activeNotes.set(t,e)}stopNote(t){const n=this.activeNotes.get(t);n&&(n.stop(),this.activeNotes.delete(t))}stopAllNotes(){this.activeNotes.forEach(t=>t.stop()),this.activeNotes.clear()}isReady(){return this.ready}setPitchBend(t,n){const r=this.activeNotes.get(t);if(r)try{r.source&&r.source.detune&&(r.source.detune.value=n)}catch(e){console.warn("Failed to apply pitch bend:",e)}}}const P=new We;class Ze{container;activeButtons=new Set;showLabels=!0;currentPreset=null;dragStartX=new Map;noteToTouchId=new Map;touchIdToNote=new Map;mouseControlledNote=null;mouseControlledPosition=null;touchIdToPosition=new Map;buttonPositions=new Map;documentMouseMoveHandler=null;documentMouseUpHandler=null;documentTouchMoveHandler=null;documentTouchEndHandler=null;documentTouchCancelHandler=null;constructor(t){const n=document.getElementById(t);if(!n)throw new Error(`Container element with id "${t}" not found`);this.container=n,this.setupDocumentEventListeners()}isFormControl(t){if(!t||!(t instanceof HTMLElement))return!1;const n=t.tagName.toLowerCase();return n==="select"||n==="input"||n==="textarea"||n==="label"||t.closest("select, input, textarea, label")!==null}getButtonAtPoint(t,n){const r=document.elementFromPoint(t,n);if(r&&r.classList.contains("pad-button")){const e=r.getAttribute("data-note"),s=r.getAttribute("data-position");if(e&&s){const c=this.buttonPositions.get(s);if(c)return{button:r,note:e,position:c}}}return null}isImmediatelyAdjacent(t,n){return t.col===n.col&&Math.abs(t.row-n.row)===1}setupDocumentEventListeners(){this.documentMouseMoveHandler=t=>{t.preventDefault();const n=this.getButtonAtPoint(t.clientX,t.clientY);if(this.mouseControlledNote&&this.mouseControlledPosition)if(n&&(n.note!==this.mouseControlledNote||n.position.row!==this.mouseControlledPosition.row||n.position.col!==this.mouseControlledPosition.col)&&this.isImmediatelyAdjacent(this.mouseControlledPosition,n.position)){const r=this.dragStartX.get(this.mouseControlledNote);this.handleNoteEnd(this.mouseControlledNote),this.handleNoteStart(n.note,n.button,t.clientX,void 0,!0,n.position),r!==void 0&&this.dragStartX.set(n.note,r),this.mouseControlledNote=n.note,this.mouseControlledPosition=n.position}else(n||this.mouseControlledNote)&&this.handleDrag(this.mouseControlledNote,t.clientX)},this.documentMouseUpHandler=t=>{t.preventDefault(),this.mouseControlledNote&&(this.handleNoteEnd(this.mouseControlledNote),this.mouseControlledNote=null,this.mouseControlledPosition=null)},this.documentTouchMoveHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.touches.length;n++){const r=t.touches[n],e=this.touchIdToNote.get(r.identifier),s=this.touchIdToPosition.get(r.identifier);if(e&&s){const c=this.getButtonAtPoint(r.clientX,r.clientY);if(c&&(c.note!==e||c.position.row!==s.row||c.position.col!==s.col)&&this.isImmediatelyAdjacent(s,c.position)){const o=this.dragStartX.get(e);this.handleNoteEnd(e,r.identifier),this.handleNoteStart(c.note,c.button,r.clientX,r.identifier,!0,c.position),o!==void 0&&this.dragStartX.set(c.note,o)}else this.activeButtons.has(e)&&this.handleDrag(e,r.clientX,r.identifier)}}},this.documentTouchEndHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&(this.handleNoteEnd(e,r.identifier),this.touchIdToPosition.delete(r.identifier))}},this.documentTouchCancelHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&(this.handleNoteEnd(e,r.identifier),this.touchIdToPosition.delete(r.identifier))}},document.addEventListener("mousemove",this.documentMouseMoveHandler),document.addEventListener("mouseup",this.documentMouseUpHandler),document.addEventListener("touchmove",this.documentTouchMoveHandler,{passive:!1}),document.addEventListener("touchend",this.documentTouchEndHandler,{passive:!1}),document.addEventListener("touchcancel",this.documentTouchCancelHandler,{passive:!1})}setShowLabels(t){this.showLabels=t,this.currentPreset&&this.render(this.currentPreset)}render(t){this.currentPreset=t,this.activeButtons.clear(),this.buttonPositions.clear(),this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateRows=`repeat(${t.rows}, 1fr)`,this.container.style.gridTemplateColumns=`repeat(${t.cols}, 1fr)`;const n=t.rows>10||t.cols>10?"2px":"6px";this.container.style.gap=n,this.container.style.width="100%",this.container.style.height="100%";const r=t.rows>10||t.cols>10?"8px":"16px";this.container.style.padding=r,t.buttons.forEach(e=>{const s=this.createButton(e);this.container.appendChild(s)})}createButton(t){const n=document.createElement("button");n.className="pad-button",n.textContent=this.showLabels?t.label||t.note:"",n.dataset.note=t.note;const r=`${t.row}-${t.col}`;return n.dataset.position=r,this.buttonPositions.set(r,{row:t.row,col:t.col}),t.color&&(n.style.backgroundColor=t.color),n.style.gridRow=`${t.row+1}`,n.style.gridColumn=`${t.col+1}`,n.addEventListener("mousedown",e=>{e.preventDefault(),this.handleNoteStart(t.note,n,e.clientX,void 0,!1,{row:t.row,col:t.col})}),n.addEventListener("touchstart",e=>{if(e.preventDefault(),e.changedTouches.length>0){const s=e.changedTouches[0];this.handleNoteStart(t.note,n,s.clientX,s.identifier,!1,{row:t.row,col:t.col})}}),n}handleNoteStart(t,n,r,e,s=!1,c){if(!P.isReady()){console.warn("Audio service not ready");return}this.activeButtons.has(t)||(this.activeButtons.add(t),n.classList.add("active"),P.playNote(t),s||this.dragStartX.set(t,r),e!==void 0&&c?(this.noteToTouchId.set(t,e),this.touchIdToNote.set(e,t),this.touchIdToPosition.set(e,c)):c&&(this.mouseControlledNote=t,this.mouseControlledPosition=c))}handleDrag(t,n,r){if(r!==void 0&&this.noteToTouchId.get(t)!==r)return;const e=this.dragStartX.get(t);if(e===void 0)return;const s=n-e,c=window.innerWidth,o=1200,a=s/c*o,u=Math.max(-o,Math.min(o,a));P.setPitchBend(t,u)}handleNoteEnd(t,n){n!==void 0&&this.noteToTouchId.get(t)!==n||this.activeButtons.has(t)&&(this.activeButtons.delete(t),this.container.querySelectorAll(`[data-note="${t}"]`).forEach(e=>{e.classList.remove("active")}),P.stopNote(t),this.dragStartX.delete(t),n!==void 0?(this.noteToTouchId.delete(t),this.touchIdToNote.delete(n)):this.mouseControlledNote===t&&(this.mouseControlledNote=null))}stopAll(){this.activeButtons.clear(),P.stopAllNotes(),this.container.querySelectorAll(".pad-button").forEach(n=>n.classList.remove("active"))}destroy(){this.documentMouseMoveHandler&&document.removeEventListener("mousemove",this.documentMouseMoveHandler),this.documentMouseUpHandler&&document.removeEventListener("mouseup",this.documentMouseUpHandler),this.documentTouchMoveHandler&&document.removeEventListener("touchmove",this.documentTouchMoveHandler),this.documentTouchEndHandler&&document.removeEventListener("touchend",this.documentTouchEndHandler),this.documentTouchCancelHandler&&document.removeEventListener("touchcancel",this.documentTouchCancelHandler),this.stopAll()}}class Qe{container;config;onPresetChange;currentPresetId;constructor(t,n,r){const e=document.getElementById(t);if(!e)throw new Error(`Container element with id "${t}" not found`);this.container=e,this.config=n,this.onPresetChange=r,this.currentPresetId=n.defaultPresetId}render(){this.container.innerHTML="";const t=document.createElement("label");t.textContent="Layout: ",t.htmlFor="preset-select";const n=document.createElement("select");n.id="preset-select",n.className="preset-select",this.config.presets.forEach(r=>{const e=document.createElement("option");e.value=r.id,e.textContent=r.name,e.selected=r.id===this.currentPresetId,n.appendChild(e)}),n.addEventListener("change",r=>{const s=r.target.value;this.selectPreset(s)}),this.container.appendChild(t),this.container.appendChild(n)}selectPreset(t){const n=this.config.presets.find(r=>r.id===t);n?(this.currentPresetId=t,this.onPresetChange(n)):console.error(`Preset with id "${t}" not found`)}getCurrentPreset(){return this.config.presets.find(t=>t.id===this.currentPresetId)}}function z(i,t){const n=i.includes("#"),e={0:0,1:0,2:0,3:30,4:60,5:150,6:180,7:240,8:280,9:280}[t]??240;return n?`hsl(${e}, 25%, 28%)`:`hsl(${e}, 30%, 35%)`}function et(){const i=["C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5"],t=[];for(let n=0;n<i.length;n++){const r=Math.floor(n/6),e=n%6,s=i[n],c=parseInt(s.match(/\d+/)?.[0]??"4"),o=s.replace(/\d+/,"");t.push({row:r,col:e,note:s,label:s,color:z(o,c)})}return t}function tt(){const i=[],n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];for(let r=0;r<16;r++)for(let e=0;e<19;e++){const s=36+e*2+r,c=Math.floor(s/12)-1,o=s%12,a=n[o],u=`${a}${c}`,l=z(a,c);i.push({row:15-r,col:e,note:u,label:u,color:l})}return i}function nt(){const i=[],n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];for(let r=0;r<12;r++)for(let e=0;e<15;e++){const s=48+e*2+r,c=Math.floor(s/12)-1,o=s%12,a=n[o],u=`${a}${c}`,l=z(a,c);i.push({row:11-r,col:e,note:u,label:u,color:l})}return i}const rt={presets:[{id:"chromatic",name:"Chromatic Scale",rows:4,cols:6,buttons:et()},{id:"harpejji",name:"Harpejji",rows:16,cols:19,buttons:tt()},{id:"harpejji-compact",name:"Harpejji Compact",rows:12,cols:15,buttons:nt()}],defaultPresetId:"chromatic"},ot="1.0.0";async function it(){const i=document.getElementById("app");if(!i)throw new Error("App container not found");i.classList.add("loading");const t=document.getElementById("header");if(t){const r=document.createElement("div");r.id="loading-message",r.textContent="Loading audio...",t.appendChild(r)}const n=t?.querySelector("h1");if(n){const r=document.createElement("span");r.className="version",r.textContent=`v${ot}`,n.appendChild(r)}try{await P.initialize("electric_piano_1");const r=document.getElementById("loading-message");r&&r.remove(),i.classList.remove("loading");const e=new Ze("grid-container"),s=document.getElementById("instrument-selector");if(s){const u=document.createElement("label");u.textContent="Instrument: ",u.htmlFor="instrument-select";const l=document.createElement("select");l.id="instrument-select",l.className="preset-select",[{value:"electric_piano_1",name:"Electric Piano (Rhodes)"},{value:"electric_piano_2",name:"Electric Piano (DX7)"},{value:"acoustic_grand_piano",name:"Acoustic Grand Piano"},{value:"bright_acoustic_piano",name:"Bright Acoustic Piano"},{value:"electric_grand_piano",name:"Electric Grand Piano"},{value:"honky_tonk_piano",name:"Honky-Tonk Piano"},{value:"vibraphone",name:"Vibraphone"},{value:"marimba",name:"Marimba"},{value:"xylophone",name:"Xylophone"},{value:"harpsichord",name:"Harpsichord"},{value:"clavinet",name:"Clavinet"},{value:"drawbar_organ",name:"Drawbar Organ"},{value:"percussive_organ",name:"Percussive Organ"},{value:"rock_organ",name:"Rock Organ"},{value:"church_organ",name:"Church Organ"},{value:"reed_organ",name:"Reed Organ"},{value:"acoustic_guitar_nylon",name:"Acoustic Guitar (Nylon)"},{value:"acoustic_guitar_steel",name:"Acoustic Guitar (Steel)"},{value:"electric_guitar_jazz",name:"Electric Guitar (Jazz)"},{value:"electric_guitar_clean",name:"Electric Guitar (Clean)"},{value:"electric_guitar_muted",name:"Electric Guitar (Muted)"},{value:"overdriven_guitar",name:"Overdriven Guitar"},{value:"distortion_guitar",name:"Distortion Guitar"}].forEach(h=>{const p=document.createElement("option");p.value=h.value,p.textContent=h.name,p.selected=h.value==="electric_piano_1",l.appendChild(p)}),l.addEventListener("change",async h=>{const T=h.target.value;l.disabled=!0,e.stopAll();try{await P.changeInstrument(T),l.disabled=!1}catch(y){console.error("Failed to change instrument:",y),l.disabled=!1}}),s.appendChild(u),s.appendChild(l)}const c=document.getElementById("labels-toggle");if(c){const u=document.createElement("input");u.type="checkbox",u.id="show-labels",u.checked=!0;const l=document.createElement("label");l.htmlFor="show-labels",l.textContent="Show note names",u.addEventListener("change",d=>{const h=d.target;e.setShowLabels(h.checked)}),c.appendChild(u),c.appendChild(l)}const o=new Qe("preset-selector",rt,u=>{e.stopAll(),e.render(u)});o.render();const a=o.getCurrentPreset();a&&e.render(a),console.log("Music Touchpad initialized successfully!")}catch(r){console.error("Failed to initialize app:",r);const e=document.createElement("div");e.className="error-message",e.textContent="Failed to load audio. Please refresh the page.",i.appendChild(e)}}it();

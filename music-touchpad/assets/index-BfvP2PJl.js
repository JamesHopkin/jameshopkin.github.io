(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function n(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(e){if(e.ep)return;e.ep=!0;const a=n(e);fetch(e.href,a)}})();function Ee(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function Ne(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var t=s.default;if(typeof t=="function"){var n=function r(){var e=!1;try{e=this instanceof r}catch{}return e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(s).forEach(function(r){var e=Object.getOwnPropertyDescriptor(s,r);Object.defineProperty(n,r,e.get?e:{enumerable:!0,get:function(){return s[r]}})}),n}var B={exports:{}},O={exports:{}},q,Z;function Ce(){if(Z)return q;Z=1;function s(n){return n>64&&n<91?n-65:n>96&&n<123?n-71:n>47&&n<58?n+4:n===43?62:n===47?63:0}function t(n,r){for(var e=n.replace(/[^A-Za-z0-9\+\/]/g,""),a=e.length,u=r?Math.ceil((a*3+1>>2)/r)*r:a*3+1>>2,o=new Uint8Array(u),i,c,d=0,l=0,p=0;p<a;p++)if(c=p&3,d|=s(e.charCodeAt(p))<<18-6*c,c===3||a-p===1){for(i=0;i<3&&l<u;i++,l++)o[l]=d>>>(16>>>i&24)&255;d=0}return o}return q={decode:t},q}var F,Q;function Ae(){return Q||(Q=1,F=function(s,t){return new Promise(function(n,r){var e=new XMLHttpRequest;t&&(e.responseType=t),e.open("GET",s),e.onload=function(){e.status===200?n(e.response):r(Error(e.statusText))},e.onerror=function(){r(Error("Network Error"))},e.send()})}),F}var ee;function Pe(){return ee||(ee=1,(function(s){var t=Ce(),n=Ae();function r(m){return function(f){return typeof f=="string"&&m.test(f)}}function e(m,f){return typeof m=="string"?m+f:typeof m=="function"?m(f):f}function a(m,f,_,N){var L=u(f)?o:i(f)?c:d(f)?l:p(f)?b:v(f)?h:g(f)?C:A(f)?T:y(f)?E:null,S=_||{};return L?L(m,f,S):N?Promise.resolve(N):Promise.reject("Source not valid ("+f+")")}a.fetch=n;function u(m){return m instanceof ArrayBuffer}function o(m,f,_){return new Promise(function(N,L){m.decodeAudioData(f,function(S){N(S)},function(){L("Can't decode audio data ("+f.slice(0,30)+"...)")})})}var i=r(/\.(mp3|wav|ogg)(\?.*)?$/i);function c(m,f,_){var N=e(_.from,f);return a(m,a.fetch(N,"arraybuffer"),_)}function d(m){return m&&typeof m.then=="function"}function l(m,f,_){return f.then(function(N){return a(m,N,_)})}var p=Array.isArray;function b(m,f,_){return Promise.all(f.map(function(N){return a(m,N,_,N)}))}function v(m){return m&&typeof m=="object"}function h(m,f,_){var N={},L=Object.keys(f).map(function(S){if(_.only&&_.only.indexOf(S)===-1)return null;var W=f[S];return a(m,W,_,W).then(function(_e){N[S]=_e})});return Promise.all(L).then(function(){return N})}var g=r(/\.json(\?.*)?$/i);function C(m,f,_){var N=e(_.from,f);return a(m,a.fetch(N,"text").then(JSON.parse),_)}var A=r(/^data:audio/);function T(m,f,_){var N=f.indexOf(",");return a(m,t.decode(f.slice(N+1)).buffer,_)}var y=r(/\.js(\?.*)?$/i);function E(m,f,_){var N=e(_.from,f);return a(m,a.fetch(N,"text").then(w),_)}function w(m){var f=m.indexOf("MIDI.Soundfont.");if(f<0)throw Error("Invalid MIDI.js Soundfont format");f=m.indexOf("=",f)+2;var _=m.lastIndexOf(",");return JSON.parse(m.slice(f,_)+"}")}s.exports&&(s.exports=a),typeof window<"u"&&(window.loadAudio=a)})(O)),O.exports}var j={exports:{}},R,te;function Se(){if(te)return R;te=1,R=s;function s(o){var i=o.createGain(),c=i._voltage=r(o),d=e(c),l=e(c),p=e(c);return i._startAmount=e(l),i._endAmount=e(p),i._multiplier=e(d),i._multiplier.connect(i),i._startAmount.connect(i),i._endAmount.connect(i),i.value=d.gain,i.startValue=l.gain,i.endValue=p.gain,i.startValue.value=0,i.endValue.value=0,Object.defineProperties(i,t),i}var t={attack:{value:0,writable:!0},decay:{value:0,writable:!0},sustain:{value:1,writable:!0},release:{value:0,writable:!0},getReleaseDuration:{value:function(){return this.release}},start:{value:function(o){var i=this._multiplier.gain,c=this._startAmount.gain,d=this._endAmount.gain;this._voltage.start(o),this._decayFrom=this._decayFrom=o+this.attack,this._startedAt=o;var l=this.sustain;i.cancelScheduledValues(o),c.cancelScheduledValues(o),d.cancelScheduledValues(o),d.setValueAtTime(0,o),this.attack?(i.setValueAtTime(0,o),i.linearRampToValueAtTime(1,o+this.attack),c.setValueAtTime(1,o),c.linearRampToValueAtTime(0,o+this.attack)):(i.setValueAtTime(1,o),c.setValueAtTime(0,o)),this.decay&&i.setTargetAtTime(l,this._decayFrom,a(this.decay))}},stop:{value:function(o,i){i&&(o=o-this.release);var c=o+this.release;if(this.release){var d=this._multiplier.gain,l=this._startAmount.gain,p=this._endAmount.gain;d.cancelScheduledValues(o),l.cancelScheduledValues(o),p.cancelScheduledValues(o);var b=a(this.release);if(this.attack&&o<this._decayFrom){var v=u(0,1,this._startedAt,this._decayFrom,o);d.linearRampToValueAtTime(v,o),l.linearRampToValueAtTime(1-v,o),l.setTargetAtTime(0,o,b)}p.setTargetAtTime(1,o,b),d.setTargetAtTime(0,o,b)}return this._voltage.stop(c),c}},onended:{get:function(){return this._voltage.onended},set:function(o){this._voltage.onended=o}}},n=new Float32Array([1,1]);function r(o){var i=o.createBufferSource(),c=o.createBuffer(1,2,o.sampleRate);return c.getChannelData(0).set(n),i.buffer=c,i.loop=!0,i}function e(o){var i=o.context.createGain();return o.connect(i),i}function a(o){return Math.log(o+1)/Math.log(100)}function u(o,i,c,d,l){var p=i-o,b=d-c,v=l-c,h=v/b,g=o+h*p;return g<=o&&(g=o),g>=i&&(g=i),g}return R}var D,ne;function Me(){if(ne)return D;ne=1;var s=Se(),t={},n={gain:1,attack:.01,decay:.1,sustain:.9,release:.3,loop:!1,cents:0,loopStart:0,loopEnd:0};function r(i,c,d){var l=!1,p=0,b={},v=i.createGain();v.gain.value=1;var h=Object.assign({},n,d),g={context:i,out:v,opts:h};return c instanceof AudioBuffer?g.buffer=c:g.buffers=c,g.start=function(T,y,E){if(g.buffer&&T!==null)return g.start(null,T,y);var w=T?g.buffers[T]:g.buffer;if(w){if(!l){console.warn("SamplePlayer not connected to any node.");return}}else{console.warn("Buffer "+T+" not found.");return}var m=E||t;y=Math.max(i.currentTime,y||0),g.emit("start",y,T,m);var f=A(T,w,m);return f.id=C(T,f),f.env.start(y),f.source.start(y),g.emit("started",y,f.id,f),m.duration&&f.stop(y+m.duration),f},g.play=function(T,y,E){return g.start(T,y,E)},g.stop=function(T,y){var E;return y=y||Object.keys(b),y.map(function(w){return E=b[w],E?(E.stop(T),E.id):null})},g.connect=function(T){return l=!0,v.connect(T),g},g.emit=function(T,y,E,w){g.onevent&&g.onevent(T,y,E,w);var m=g["on"+T];m&&m(y,E,w)},g;function C(T,y){return y.id=p++,b[y.id]=y,y.source.onended=function(){var E=i.currentTime;y.source.disconnect(),y.env.disconnect(),y.disconnect(),g.emit("ended",E,y.id,y)},y.id}function A(T,y,E){var w=i.createGain();return w.gain.value=0,w.connect(v),w.env=u(i,E,h),w.env.connect(w.gain),w.source=i.createBufferSource(),w.source.buffer=y,w.source.connect(w),w.source.loop=E.loop||h.loop,w.source.playbackRate.value=o(E.cents||h.cents),w.source.loopStart=E.loopStart||h.loopStart,w.source.loopEnd=E.loopEnd||h.loopEnd,w.stop=function(m){var f=m||i.currentTime;g.emit("stop",f,T);var _=w.env.stop(f);w.source.stop(_)},w}}function e(i){return typeof i=="number"}var a=["attack","decay","sustain","release"];function u(i,c,d){var l=s(i),p=c.adsr||d.adsr;return a.forEach(function(b,v){p?l[b]=p[v]:l[b]=c[b]||d[b]}),l.value.value=e(c.gain)?c.gain:e(d.gain)?d.gain:1,l}function o(i){return i?Math.pow(2,i/1200):1}return D=r,D}var k,re;function Le(){if(re)return k;re=1,k=function(t){return t.on=function(n,r){if(arguments.length===1&&typeof n=="function")return t.on("event",n);var e="on"+n,a=t[e];return t[e]=a?s(a,r):r,t},t};function s(t,n){return function(r,e,a,u){t(r,e,a,u),n(r,e,a,u)}}return k}var H,oe;function xe(){if(oe)return H;oe=1;var s=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function t(){return s}var n=[0,2,4,5,7,9,11];function r(o,i,c){if(typeof o!="string")return null;var d=s.exec(o);if(!d||!i&&d[4])return null;var l={letter:d[1].toUpperCase(),acc:d[2].replace(/x/g,"##")};return l.pc=l.letter+l.acc,l.step=(l.letter.charCodeAt(0)+3)%7,l.alt=l.acc[0]==="b"?-l.acc.length:l.acc.length,l.chroma=n[l.step]+l.alt,d[3]&&(l.oct=+d[3],l.midi=l.chroma+12*(l.oct+1),l.freq=e(l.midi,c)),i&&(l.tonicOf=d[4]),l}function e(o,i){return Math.pow(2,(o-69)/12)*(i||440)}var a={parse:r,regex:t,midiToFreq:e},u=["letter","acc","pc","step","alt","chroma","oct","midi","freq"];return u.forEach(function(o){a[o]=function(i){var c=r(i);return c&&typeof c[o]<"u"?c[o]:null}}),H=a,H}var $,ie;function Ie(){if(ie)return $;ie=1;var s=xe(),t=function(e){return e!==null&&e!==[]&&e>=0&&e<129},n=function(e){return t(e)?+e:s.midi(e)};$=function(e){if(e.buffers){var a=e.opts.map,u=typeof a=="function"?a:n,o=function(c){return c?u(c)||c:null};e.buffers=r(e.buffers,o);var i=e.start;e.start=function(c,d,l){var p=o(c),b=p%1;return b&&(p=Math.floor(p),l=Object.assign(l||{},{cents:Math.floor(b*100)})),i(p,d,l)}}return e};function r(e,a){return Object.keys(e).reduce(function(u,o){return u[a(o)]=e[o],u},{})}return $}var G,se;function Be(){if(se)return G;se=1;var s=Array.isArray,t=function(r){return r&&typeof r=="object"},n={};return G=function(r){return r.schedule=function(e,a){var u=r.context.currentTime,o=e<u?u:e;r.emit("schedule",o,a);var i,c,d,l;return a.map(function(p){if(p)s(p)?(i=p[0],c=p[1]):(i=p.time,c=p);else return null;return t(c)?(d=c.name||c.key||c.note||c.midi||null,l=c):(d=c,l=n),r.start(d,o+(i||0),l)})},r},G}function I(s){throw new Error('Could not dynamically require "'+s+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var V={exports:{}},ae;function Oe(){return ae||(ae=1,(function(s,t){(function(n){s.exports=n()})(function(){return(function n(r,e,a){function u(c,d){if(!e[c]){if(!r[c]){var l=typeof I=="function"&&I;if(!d&&l)return l(c,!0);if(o)return o(c,!0);var p=new Error("Cannot find module '"+c+"'");throw p.code="MODULE_NOT_FOUND",p}var b=e[c]={exports:{}};r[c][0].call(b.exports,function(v){var h=r[c][1][v];return u(h||v)},b,b.exports,n,r,e,a)}return e[c].exports}for(var o=typeof I=="function"&&I,i=0;i<a.length;i++)u(a[i]);return u})({1:[function(n,r,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(a){function u(o){if(this._event=o,this._data=o.data,this.receivedTime=o.receivedTime,this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}switch(this._messageCode=o.data[0]&240,this.channel=o.data[0]&15,this._messageCode){case 128:this.messageType="noteoff",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 144:this.messageType="noteon",this.key=o.data[1]&127,this.velocity=o.data[2]&127;break;case 160:this.messageType="keypressure",this.key=o.data[1]&127,this.pressure=o.data[2]&127;break;case 176:this.messageType="controlchange",this.controllerNumber=o.data[1]&127,this.controllerValue=o.data[2]&127,this.controllerNumber===120&&this.controllerValue===0?this.channelModeMessage="allsoundoff":this.controllerNumber===121?this.channelModeMessage="resetallcontrollers":this.controllerNumber===122?this.controllerValue===0?this.channelModeMessage="localcontroloff":this.channelModeMessage="localcontrolon":this.controllerNumber===123&&this.controllerValue===0?this.channelModeMessage="allnotesoff":this.controllerNumber===124&&this.controllerValue===0?this.channelModeMessage="omnimodeoff":this.controllerNumber===125&&this.controllerValue===0?this.channelModeMessage="omnimodeon":this.controllerNumber===126?this.channelModeMessage="monomodeon":this.controllerNumber===127&&(this.channelModeMessage="polymodeon");break;case 192:this.messageType="programchange",this.program=o.data[1];break;case 208:this.messageType="channelpressure",this.pressure=o.data[1]&127;break;case 224:this.messageType="pitchbendchange";var i=o.data[2]&127,c=o.data[1]&127;this.pitchBend=(i<<8)+c;break}}return new u(a)},r.exports=e.default},{}]},{},[1])(1)})})(V)),V.exports}var U,ce;function qe(){if(ce)return U;ce=1;var s=Oe();return U=function(t){return t.listenToMidi=function(n,r){var e={},a=r||{},u=a.gain||function(o){return o/127};return n.onmidimessage=function(o){var i=o.messageType?o:s(o);if(i.messageType==="noteon"&&i.velocity===0&&(i.messageType="noteoff"),!(a.channel&&i.channel!==a.channel))switch(i.messageType){case"noteon":e[i.key]=t.play(i.key,0,{gain:u(i.velocity)});break;case"noteoff":e[i.key]&&(e[i.key].stop(),delete e[i.key]);break}},t},t},U}var ue;function Fe(){return ue||(ue=1,(function(s){var t=Me(),n=Le(),r=Ie(),e=Be(),a=qe();function u(o,i,c){return a(e(r(n(t(o,i,c)))))}s.exports&&(s.exports=u),typeof window<"u"&&(window.SamplePlayer=u)})(j)),j.exports}function le(s,t){return Array(t+1).join(s)}function z(s){return typeof s=="number"}function je(s){return typeof s=="string"}function Re(s){return typeof s<"u"}function ye(s,t){return Math.pow(2,(s-69)/12)*(t||440)}var be=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function De(){return be}var ke=[0,2,4,5,7,9,11];function P(s,t,n){if(typeof s!="string")return null;var r=be.exec(s);if(!r||!t&&r[4])return null;var e={letter:r[1].toUpperCase(),acc:r[2].replace(/x/g,"##")};e.pc=e.letter+e.acc,e.step=(e.letter.charCodeAt(0)+3)%7,e.alt=e.acc[0]==="b"?-e.acc.length:e.acc.length;var a=ke[e.step]+e.alt;return e.chroma=a<0?12+a:a%12,r[3]&&(e.oct=+r[3],e.midi=a+12*(e.oct+1),e.freq=ye(e.midi,n)),t&&(e.tonicOf=r[4]),e}var He="CDEFGAB";function $e(s){return z(s)?s<0?le("b",-s):le("#",s):""}function Ge(s){return z(s)?""+s:""}function we(s,t,n){return s===null||typeof s>"u"?null:s.step?we(s.step,s.alt,s.oct):s<0||s>6?null:He.charAt(s)+$e(t)+Ge(n)}function Te(s){if((z(s)||je(s))&&s>=0&&s<128)return+s;var t=P(s);return t&&Re(t.midi)?t.midi:null}function Ve(s,t){var n=Te(s);return n===null?null:ye(n,t)}function Ue(s){return(P(s)||{}).letter}function Xe(s){return(P(s)||{}).acc}function ze(s){return(P(s)||{}).pc}function Je(s){return(P(s)||{}).step}function Ke(s){return(P(s)||{}).alt}function Ye(s){return(P(s)||{}).chroma}function We(s){return(P(s)||{}).oct}const Ze=Object.freeze(Object.defineProperty({__proto__:null,acc:Xe,alt:Ke,build:we,chroma:Ye,freq:Ve,letter:Ue,midi:Te,oct:We,parse:P,pc:ze,regex:De,step:Je},Symbol.toStringTag,{value:"Module"})),Qe=Ne(Ze);var X,de;function et(){if(de)return X;de=1;var s=Qe;function t(e,a){if(console.warn("new Soundfont() is deprected"),console.log("Please use Soundfont.instrument() instead of new Soundfont().instrument()"),!(this instanceof t))return new t(e);this.nameToUrl=a||t.nameToUrl,this.ctx=e,this.instruments={},this.promises=[]}t.prototype.onready=function(e){console.warn("deprecated API"),console.log("Please use Promise.all(Soundfont.instrument(), Soundfont.instrument()).then() instead of new Soundfont().onready()"),Promise.all(this.promises).then(e)},t.prototype.instrument=function(e,a){console.warn("new Soundfont().instrument() is deprecated."),console.log("Please use Soundfont.instrument() instead.");var u=this.ctx;if(e=e||"default",e in this.instruments)return this.instruments[e];var o={name:e,play:r(u,a)};if(this.instruments[e]=o,e!=="default"){var i=t.instrument(u,e,a).then(function(c){return o.play=c.play,o});this.promises.push(i),o.onready=function(c){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),i.then(c)}}else o.onready=function(c){console.warn("onready is deprecated. Use Soundfont.instrument().then()"),c()};return o};function n(e,a,u){return console.warn("Soundfont.loadBuffers is deprecate."),console.log("Use Soundfont.instrument(..) and get buffers properties from the result."),t.instrument(e,a,u).then(function(o){return o.buffers})}t.loadBuffers=n;function r(e,a){return a=a||{},function(u,o,i,c){console.warn("The oscillator player is deprecated."),console.log("Starting with version 0.9.0 you will have to wait until the soundfont is loaded to play sounds.");var d=u>0&&u<129?+u:s.midi(u),l=d?s.midiToFreq(d,440):null;if(l){i=i||.2,c=c||{};var p=c.destination||a.destination||e.destination,b=c.vcoType||a.vcoType||"sine",v=c.gain||a.gain||.4,h=e.createOscillator();h.type=b,h.frequency.value=l;var g=e.createGain();return g.gain.value=v,h.connect(g),g.connect(p),h.start(o),i>0&&h.stop(o+i),h}}}return t.noteToMidi=s.midi,X=t,X}var fe;function tt(){return fe||(fe=1,(function(s){var t=Pe(),n=Fe();function r(o,i,c){if(arguments.length===1)return function(v,h){return r(o,v,h)};var d=c||{},l=d.isSoundfontURL||e,p=d.nameToUrl||a,b=l(i)?i:p(i,d.soundfont,d.format);return t(o,b,{only:d.only||d.notes}).then(function(v){var h=n(o,v,d).connect(d.destination?d.destination:o.destination);return h.url=b,h.name=i,h})}function e(o){return/\.js(\?.*)?$/i.test(o)}function a(o,i,c){return c=c==="ogg"?c:"mp3",i=i==="FluidR3_GM"?i:"MusyngKite","https://gleitz.github.io/midi-js-soundfonts/"+i+"/"+o+"-"+c+".js"}var u=et();u.instrument=r,u.nameToUrl=a,s.exports&&(s.exports=u),typeof window<"u"&&(window.Soundfont=u)})(B)),B.exports}var nt=tt();const he=Ee(nt),rt=new Set(["drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synthstrings_1","synthstrings_2","choir_aahs","voice_oohs","synth_voice","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep"]);class ot{instrument=null;activeNotes=new Map;ready=!1;audioContext=null;currentInstrumentName="";async initialize(t="electric_piano_1"){try{this.audioContext=new AudioContext,this.instrument=await he.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=t,this.ready=!0,console.log(`Audio service initialized with ${t}`)}catch(n){throw console.error("Failed to initialize audio service:",n),n}}async changeInstrument(t){try{this.stopAllNotes(),this.ready=!1,this.audioContext||(this.audioContext=new AudioContext),this.instrument=await he.instrument(this.audioContext,t,{format:"mp3",soundfont:"MusyngKite",gain:2}),this.currentInstrumentName=t,this.ready=!0,console.log(`Changed instrument to ${t}`)}catch(n){throw console.error("Failed to change instrument:",n),n}}playNote(t){if(!this.instrument||!this.ready){console.warn("Audio service not ready");return}if(this.activeNotes.has(t))return;const n=rt.has(this.currentInstrumentName),r={gain:2,loop:n};n&&(r.loopStart=.3,r.loopEnd=2.5);const e=this.instrument.play(t,0,r);this.activeNotes.set(t,e)}stopNote(t){const n=this.activeNotes.get(t);n&&(n.stop(),this.activeNotes.delete(t))}stopAllNotes(){this.activeNotes.forEach(t=>t.stop()),this.activeNotes.clear()}isReady(){return this.ready}setPitchBend(t,n){const r=this.activeNotes.get(t);if(r)try{r.source&&r.source.detune&&(r.source.detune.value=n)}catch(e){console.warn("Failed to apply pitch bend:",e)}}}const M=new ot,x={instrument:"electric_piano_1",presetId:"harpejji-compact",showLabels:!1};class it{container;activeButtons=new Set;showLabels=x.showLabels;currentPreset=null;dragStartX=new Map;noteToTouchId=new Map;touchIdToNote=new Map;mouseControlledNote=null;mouseControlledPosition=null;touchIdToPosition=new Map;buttonPositions=new Map;documentMouseMoveHandler=null;documentMouseUpHandler=null;documentTouchMoveHandler=null;documentTouchEndHandler=null;documentTouchCancelHandler=null;constructor(t){const n=document.getElementById(t);if(!n)throw new Error(`Container element with id "${t}" not found`);this.container=n,this.setupDocumentEventListeners()}isFormControl(t){if(!t||!(t instanceof HTMLElement))return!1;const n=t.tagName.toLowerCase();return n==="select"||n==="input"||n==="textarea"||n==="label"||t.closest("select, input, textarea, label")!==null}getButtonAtPoint(t,n){const r=document.elementFromPoint(t,n);if(r&&r.classList.contains("pad-button")){const e=r.getAttribute("data-note"),a=r.getAttribute("data-position");if(e&&a){const u=this.buttonPositions.get(a);if(u)return{button:r,note:e,position:u}}}return null}isImmediatelyAdjacent(t,n){return t.col===n.col&&Math.abs(t.row-n.row)===1}setupDocumentEventListeners(){this.documentMouseMoveHandler=t=>{t.preventDefault();const n=this.getButtonAtPoint(t.clientX,t.clientY);if(this.mouseControlledNote&&this.mouseControlledPosition)if(n&&(n.note!==this.mouseControlledNote||n.position.row!==this.mouseControlledPosition.row||n.position.col!==this.mouseControlledPosition.col)&&this.isImmediatelyAdjacent(this.mouseControlledPosition,n.position)){const r=this.dragStartX.get(this.mouseControlledNote);this.handleNoteEnd(this.mouseControlledNote),this.handleNoteStart(n.note,n.button,t.clientX,void 0,!0,n.position),r!==void 0&&this.dragStartX.set(n.note,r),this.mouseControlledNote=n.note,this.mouseControlledPosition=n.position}else(n||this.mouseControlledNote)&&this.handleDrag(this.mouseControlledNote,t.clientX)},this.documentMouseUpHandler=t=>{t.preventDefault(),this.mouseControlledNote&&(this.handleNoteEnd(this.mouseControlledNote),this.mouseControlledNote=null,this.mouseControlledPosition=null)},this.documentTouchMoveHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.touches.length;n++){const r=t.touches[n],e=this.touchIdToNote.get(r.identifier),a=this.touchIdToPosition.get(r.identifier);if(e&&a){const u=this.getButtonAtPoint(r.clientX,r.clientY);if(u&&(u.note!==e||u.position.row!==a.row||u.position.col!==a.col)&&this.isImmediatelyAdjacent(a,u.position)){const o=this.dragStartX.get(e);this.handleNoteEnd(e,r.identifier),this.handleNoteStart(u.note,u.button,r.clientX,r.identifier,!0,u.position),o!==void 0&&this.dragStartX.set(u.note,o)}else this.activeButtons.has(e)&&this.handleDrag(e,r.clientX,r.identifier)}}},this.documentTouchEndHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&(this.handleNoteEnd(e,r.identifier),this.touchIdToPosition.delete(r.identifier))}},this.documentTouchCancelHandler=t=>{this.isFormControl(t.target)||t.preventDefault();for(let n=0;n<t.changedTouches.length;n++){const r=t.changedTouches[n],e=this.touchIdToNote.get(r.identifier);e&&(this.handleNoteEnd(e,r.identifier),this.touchIdToPosition.delete(r.identifier))}},document.addEventListener("mousemove",this.documentMouseMoveHandler),document.addEventListener("mouseup",this.documentMouseUpHandler),document.addEventListener("touchmove",this.documentTouchMoveHandler,{passive:!1}),document.addEventListener("touchend",this.documentTouchEndHandler,{passive:!1}),document.addEventListener("touchcancel",this.documentTouchCancelHandler,{passive:!1})}setShowLabels(t){this.showLabels=t,this.currentPreset&&this.render(this.currentPreset)}render(t){this.currentPreset=t,this.activeButtons.clear(),this.buttonPositions.clear(),this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateRows=`repeat(${t.rows}, 1fr)`,this.container.style.gridTemplateColumns=`repeat(${t.cols}, 1fr)`;const n=t.rows>10||t.cols>10?"2px":"6px";this.container.style.gap=n,this.container.style.width="100%",this.container.style.height="100%";const r=t.rows>10||t.cols>10?"8px":"16px";this.container.style.padding=r,t.buttons.forEach(e=>{const a=this.createButton(e);this.container.appendChild(a)})}createButton(t){const n=document.createElement("button");n.className="pad-button",n.textContent=this.showLabels?t.label||t.note:"",n.dataset.note=t.note;const r=`${t.row}-${t.col}`;return n.dataset.position=r,this.buttonPositions.set(r,{row:t.row,col:t.col}),t.color&&(n.style.backgroundColor=t.color),n.style.gridRow=`${t.row+1}`,n.style.gridColumn=`${t.col+1}`,n.addEventListener("mousedown",e=>{e.preventDefault(),this.handleNoteStart(t.note,n,e.clientX,void 0,!1,{row:t.row,col:t.col})}),n.addEventListener("touchstart",e=>{if(e.preventDefault(),e.changedTouches.length>0){const a=e.changedTouches[0];this.handleNoteStart(t.note,n,a.clientX,a.identifier,!1,{row:t.row,col:t.col})}}),n}handleNoteStart(t,n,r,e,a=!1,u){if(!M.isReady()){console.warn("Audio service not ready");return}this.activeButtons.has(t)||(this.activeButtons.add(t),n.classList.add("active"),M.playNote(t),a||this.dragStartX.set(t,r),e!==void 0&&u?(this.noteToTouchId.set(t,e),this.touchIdToNote.set(e,t),this.touchIdToPosition.set(e,u)):u&&(this.mouseControlledNote=t,this.mouseControlledPosition=u))}handleDrag(t,n,r){if(r!==void 0&&this.noteToTouchId.get(t)!==r)return;const e=this.dragStartX.get(t);if(e===void 0)return;const a=n-e,u=window.innerWidth,o=1200,i=a/u*o,c=Math.max(-o,Math.min(o,i));M.setPitchBend(t,c)}handleNoteEnd(t,n){n!==void 0&&this.noteToTouchId.get(t)!==n||this.activeButtons.has(t)&&(this.activeButtons.delete(t),this.container.querySelectorAll(`[data-note="${t}"]`).forEach(e=>{e.classList.remove("active")}),M.stopNote(t),this.dragStartX.delete(t),n!==void 0?(this.noteToTouchId.delete(t),this.touchIdToNote.delete(n)):this.mouseControlledNote===t&&(this.mouseControlledNote=null))}stopAll(){this.activeButtons.clear(),M.stopAllNotes(),this.container.querySelectorAll(".pad-button").forEach(n=>n.classList.remove("active"))}destroy(){this.documentMouseMoveHandler&&document.removeEventListener("mousemove",this.documentMouseMoveHandler),this.documentMouseUpHandler&&document.removeEventListener("mouseup",this.documentMouseUpHandler),this.documentTouchMoveHandler&&document.removeEventListener("touchmove",this.documentTouchMoveHandler),this.documentTouchEndHandler&&document.removeEventListener("touchend",this.documentTouchEndHandler),this.documentTouchCancelHandler&&document.removeEventListener("touchcancel",this.documentTouchCancelHandler),this.stopAll()}}class st{container;config;onPresetChange;currentPresetId;constructor(t,n,r){const e=document.getElementById(t);if(!e)throw new Error(`Container element with id "${t}" not found`);this.container=e,this.config=n,this.onPresetChange=r,this.currentPresetId=n.defaultPresetId}render(){this.container.innerHTML="";const t=document.createElement("label");t.textContent="Layout: ",t.htmlFor="preset-select";const n=document.createElement("select");n.id="preset-select",n.className="preset-select",this.config.presets.forEach(r=>{const e=document.createElement("option");e.value=r.id,e.textContent=r.name,e.selected=r.id===this.currentPresetId,n.appendChild(e)}),n.addEventListener("change",r=>{const a=r.target.value;this.selectPreset(a)}),this.container.appendChild(t),this.container.appendChild(n)}selectPreset(t){const n=this.config.presets.find(r=>r.id===t);n?(this.currentPresetId=t,this.onPresetChange(n)):console.error(`Preset with id "${t}" not found`)}getCurrentPreset(){return this.config.presets.find(t=>t.id===this.currentPresetId)}}function J(s){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=s.match(/^([A-G]#?)(\d+)$/);if(!n)throw new Error(`Invalid note name: ${s}`);const[,r,e]=n,a=parseInt(e),u=t.indexOf(r);if(u===-1)throw new Error(`Invalid note name: ${s}`);return(a+1)*12+u}function K(s){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(s/12)-1,r=s%12;return`${t[r]}${n}`}function Y(s,t){const n=s.includes("#"),e={0:0,1:0,2:0,3:30,4:60,5:150,6:180,7:240,8:280,9:280}[t]??240;return n?`hsl(${e}, 25%, 28%)`:`hsl(${e}, 30%, 35%)`}function me(s="C4"){const t=[],n=J(s),r=24;for(let e=0;e<r;e++){const a=Math.floor(e/6),u=e%6,o=n+e,i=K(o),c=parseInt(i.match(/\d+/)?.[0]??"4"),d=i.replace(/\d+/,"");t.push({row:a,col:u,note:i,label:i,color:Y(d,c)})}return t}function pe(s="C2"){const t=[],n=J(s);for(let r=0;r<16;r++)for(let e=0;e<19;e++){const a=n+e*2+r,u=K(a),o=parseInt(u.match(/\d+/)?.[0]??"4"),i=u.replace(/\d+/,""),c=Y(i,o);t.push({row:15-r,col:e,note:u,label:u,color:c})}return t}function ve(s="C3"){const t=[],n=J(s);for(let r=0;r<12;r++)for(let e=0;e<15;e++){const a=n+e*2+r,u=K(a),o=parseInt(u.match(/\d+/)?.[0]??"4"),i=u.replace(/\d+/,""),c=Y(i,o);t.push({row:11-r,col:e,note:u,label:u,color:c})}return t}const ge={presets:[{id:"chromatic",name:"Chromatic Scale",rows:4,cols:6,defaultLowestNote:"C4",buttons:me("C4")},{id:"harpejji",name:"Harpejji",rows:16,cols:19,defaultLowestNote:"C2",buttons:pe("C2")},{id:"harpejji-compact",name:"Harpejji Compact",rows:12,cols:15,defaultLowestNote:"C3",buttons:ve("C3")}],defaultPresetId:x.presetId,updateLowestNote(s){this.presets[0].buttons=me(s),this.presets[1].buttons=pe(s),this.presets[2].buttons=ve(s)}},at="1.0.1";async function ct(){const s=document.getElementById("app");if(!s)throw new Error("App container not found");const t=document.getElementById("app-version");t&&(t.textContent=`v${at}`);const n=document.getElementById("burger-menu"),r=document.getElementById("menu-popup"),e=document.getElementById("close-menu"),a=()=>{r&&r.classList.toggle("hidden")},u=()=>{r&&r.classList.add("hidden")};n&&n.addEventListener("click",a),e&&e.addEventListener("click",u),r&&r.addEventListener("click",o=>{o.target===r&&u()});try{await M.initialize(x.instrument);const o=document.getElementById("loading-overlay");o&&o.classList.add("hidden");const i=new it("grid-container"),c=document.getElementById("instrument-selector");if(c){const v=document.createElement("label");v.textContent="Instrument: ",v.htmlFor="instrument-select";const h=document.createElement("select");h.id="instrument-select",h.className="preset-select",[{value:"electric_piano_1",name:"Electric Piano (Rhodes)"},{value:"electric_piano_2",name:"Electric Piano (DX7)"},{value:"acoustic_grand_piano",name:"Acoustic Grand Piano"},{value:"bright_acoustic_piano",name:"Bright Acoustic Piano"},{value:"electric_grand_piano",name:"Electric Grand Piano"},{value:"honky_tonk_piano",name:"Honky-Tonk Piano"},{value:"vibraphone",name:"Vibraphone"},{value:"marimba",name:"Marimba"},{value:"xylophone",name:"Xylophone"},{value:"harpsichord",name:"Harpsichord"},{value:"clavinet",name:"Clavinet"},{value:"drawbar_organ",name:"Drawbar Organ"},{value:"percussive_organ",name:"Percussive Organ"},{value:"rock_organ",name:"Rock Organ"},{value:"church_organ",name:"Church Organ"},{value:"reed_organ",name:"Reed Organ"},{value:"acoustic_guitar_nylon",name:"Acoustic Guitar (Nylon)"},{value:"acoustic_guitar_steel",name:"Acoustic Guitar (Steel)"},{value:"electric_guitar_jazz",name:"Electric Guitar (Jazz)"},{value:"electric_guitar_clean",name:"Electric Guitar (Clean)"},{value:"electric_guitar_muted",name:"Electric Guitar (Muted)"},{value:"overdriven_guitar",name:"Overdriven Guitar"},{value:"distortion_guitar",name:"Distortion Guitar"}].forEach(C=>{const A=document.createElement("option");A.value=C.value,A.textContent=C.name,A.selected=C.value===x.instrument,h.appendChild(A)}),h.addEventListener("change",async C=>{const T=C.target.value;h.disabled=!0,i.stopAll();try{await M.changeInstrument(T),h.disabled=!1}catch(y){console.error("Failed to change instrument:",y),h.disabled=!1}}),c.appendChild(v),c.appendChild(h)}const d=document.getElementById("lowest-note-selector");if(d){const v=document.createElement("label");v.textContent="Lowest Note: ",v.htmlFor="lowest-note-select";const h=document.createElement("select");h.id="lowest-note-select",h.className="preset-select",["G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4"].forEach(C=>{const A=document.createElement("option");A.value=C,A.textContent=C,h.appendChild(A)}),h.addEventListener("change",C=>{const T=C.target.value;ge.updateLowestNote(T);const y=p.getCurrentPreset();y&&(i.stopAll(),i.render(y))}),d.appendChild(v),d.appendChild(h)}const l=document.getElementById("labels-toggle");if(l){const v=document.createElement("input");v.type="checkbox",v.id="show-labels",v.checked=x.showLabels;const h=document.createElement("label");h.htmlFor="show-labels",h.textContent="Show note names",v.addEventListener("change",g=>{const C=g.target;i.setShowLabels(C.checked)}),l.appendChild(v),l.appendChild(h)}const p=new st("preset-selector",ge,v=>{i.stopAll();const h=document.getElementById("lowest-note-select");h&&(h.value=v.defaultLowestNote),i.render(v)});p.render();const b=p.getCurrentPreset();if(b){const v=document.getElementById("lowest-note-select");v&&(v.value=b.defaultLowestNote),i.render(b)}console.log("Music Touchpad initialized successfully!")}catch(o){console.error("Failed to initialize app:",o);const i=document.createElement("div");i.className="error-message",i.textContent="Failed to load audio. Please refresh the page.",s.appendChild(i)}}ct();
